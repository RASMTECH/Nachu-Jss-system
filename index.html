 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASM School Management System</title>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
 const firebaseConfig = {
    apiKey: "AIzaSyDhTehL7VIaGG-bC2n1AFILZeJJ-drmSC0",
    authDomain: "rasm-school-management.firebaseapp.com",
    databaseURL: "https://rasm-school-management-default-rtdb.firebaseio.com",
    projectId: "rasm-school-management",
    storageBucket: "rasm-school-management.firebasestorage.app",
    messagingSenderId: "1015313561987",
    appId: "1:1015313561987:web:1de51ea41dcac727e59eb6",
    measurementId: "G-LY61SYE1S5"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  // Initialize Firestore
  const db = firebase.firestore();
</script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.0/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/confetti-js@0.0.18/dist/index.min.js"></script>

<style>
    .report-logo {
        display: block;
        max-width: 150px;
        margin: 0 auto 20px; /* Center and add space below */
    }
.circle-button {
    width: 50px; /* Adjust the width for the desired size */
    height: 50px; /* Same as width to make it a circle */
    border-radius: 50%; /* Makes it circular */
    background-color: #4CAF50; /* Button background color */
    color: white; /* Text color */
    border: none; /* Removes border */
    cursor: pointer; /* Changes cursor to pointer */
    display: inline-flex; /* Align text in the center */
    align-items: center; /* Vertically center text */
    justify-content: center; /* Horizontally center text */
    font-size: 16px; /* Font size */
  }

  .circle-button:hover {
    background-color: #45a049; /* Color when hovering */
  }

.menu-container {
    position: relative;
    display: inline-block;
  }

  .menu-button {
    background-color: #4CAF50; /* Adjust as needed */
    color: white;
    padding: 10px 20px;
    border: none;
    cursor: pointer;
    font-size: 16px;
  }

  .dropdown {
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
    z-index: 1;
  }

  .dropdown .neon-button {
    display: block;
    width: 100%;
    border: none;
    padding: 10px;
    text-align: left;
    background: none;
    color: inherit;
    cursor: pointer;
  }

  .menu-container .dropdown .neon-button:hover {
    background-color: #ddd; /* Adjust hover effect */
  }
  .neon-button {
    background-color: #222;
    border: 2px solid #00ff00;
    color: #00ff00;
    font-size: 16px;
    font-weight: bold;
    padding: 10px 20px;
    text-transform: uppercase;
    cursor: pointer;
    outline: none;
    transition: all 0.3s ease;
  }

  .neon-button:hover {
    box-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00, 0 0 30px #00ff00;
    transform: scale(1.1);
  }

  .neon-button:focus {
    outline: none;
    box-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00, 0 0 30px #00ff00;
  }
@media print {
        button {
            display: none; /* Hide all buttons */
        }

        .no-print {
            display: none; /* Additional class for specific elements */
        }
    }

/* Styling for the Junior School Marks Entry Section form */
        #juniorMarksEntrySection {
            background-color: #fff8e1; /* Light amber */
            border: 2px solid #ffc107; /* Amber border */
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
}
 /* Buttons */
        .button, button, .btn {
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        /* Styling for the Register Learner form */
        #registerLearnerSection {
            background-color: #e3f2fd; /* Light blue */
            border: 2px solid #2196f3; /* Blue border */
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .support-staff-section {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
        }
 /* Forms */
        input[type="text"], input[type="number"], select {
            width: 30%;
            padding: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            background-color: #f3f9fb; /* Light green background */
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }

        input[type="text"], input[type="number"] {
            background-color: #eaf6fb; /* Lighter blue for input fields */
        }
        .support-staff-section h1, .support-staff-section h2 {
            color: #4CAF50;
            text-align: center;
        }

        .support-staff-section .form-container {
            background-color: #fff;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            width: 350px;
            margin: 20px auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .support-staff-section .form-container input[type="text"],
        .support-staff-section .form-container input[type="date"],
        .support-staff-section .form-container input[type="file"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .support-staff-section .form-container button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }

        .support-staff-section .form-container button:hover {
            background-color: #45a049;
        }

        .support-staff-section .table-container {
            margin: 20px auto;
            width: 90%;
        }

        .support-staff-section table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .support-staff-section table th, .support-staff-section table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        .support-staff-section table th {
            background-color: #4CAF50;
            color: white;
        }

        .support-staff-section .id-card {
            width: 350px;
            border: 2px solid #007bff;
            padding: 20px;
            background-color: #e0f7fa;
            margin: 20px auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            font-family: 'Arial', sans-serif;
            color: #333;
            text-align: center;
        }

        .support-staff-section .header {
            text-align: center;
            background-color: #007bff;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
        }

        .support-staff-section .header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
        }

        .support-staff-section .school-tagline {
            font-style: italic;
            font-size: 14px;
            color: #e0e0e0;
        }

        .support-staff-section .id-card-content h2 {
            font-size: 20px;
            color: #007bff;
            margin: 15px 0;
        }

        .support-staff-section .id-card-content p {
            font-size: 16px;
            margin: 8px 0;
            line-height: 1.5;
        }

        .support-staff-section .id-card-content strong {
            color: #007bff;
        }

        .support-staff-section .id-card-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 2px solid #007bff;
            margin: 10px auto;
            object-fit: cover;
        }

        .support-staff-section .id-card-footer {
            margin-top: 15px;
            font-size: 12px;
            color: #555;
            font-style: italic;
        }

        .support-staff-section .school-email {
            font-size: 12px;
            color: #007bff;
            margin-top: 10px;
        }

        .support-staff-section .staff-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto;
        }

        /* Print Styles */
        @media print {
            body {
                margin: 0;
                padding: 0;
                background-color: white;
            }

            .form-container, .table-container {
                display: none; /* Hide form and table during print */
            }

            .id-card {
                width: 100%;
                max-width: 350px;
                border: none;
                padding: 10px;
                background-color: #e0f7fa; /* Same background color for print */
                margin: 0 auto;
                box-shadow: none;
            }

            .id-card .header, .id-card .id-card-content, .id-card .id-card-footer {
                page-break-inside: avoid; /* Prevent breaking content inside card */
            }

            .id-card-footer {
                font-size: 10px;
            }

            .school-email {
                font-size: 10px;
                color: #007bff;
            }
        }


    #loginSection {
        display: block;
        text-align: center;
        margin: auto;
        margin-top: 50px;
        width: 300px; /* Reduce width */
        padding: 20px; /* Add some padding for spacing */
        border: 2px solid #2196F3; /* Add a border for a clean look */
        border-radius: 10px; /* Round the corners */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Add subtle shadow */
        background-color: #e3f2fd; /* Light blue background */
    }
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

  /* Global styles for ID Card */
        .id-card {
            width: 350px;
            border: 2px solid #007bff; /* Border color for the ID card */
            padding: 20px;
            background-color: #f8f9fa; /* Light background color */
            margin: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Shadow for depth */
            font-family: 'Arial', sans-serif;
            color: #333; /* Default text color */
        }

        .header {
            text-align: center;
            background-color: #007bff; /* Blue header background */
            color: white; /* White text for header */
            padding: 10px;
            border-radius: 5px;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
        }

        .school-tagline {
            font-style: italic;
            font-size: 14px;
            color: #dcdcdc; /* Lighter color for tagline */
        }

        /* RASM Tech Online Text */
        .rasm-tech {
            font-size: 16px;
            color: #28a745; /* Green color for RASM Tech Online */
            margin-top: 10px;
            font-weight: bold;
        }

        .rasm-tech strong {
            color: #007bff; /* Blue color for the text "RASM Tech Online" */
        }

        .id-card-content {
            padding-top: 10px;
        }

        .id-card-content h2 {
            font-size: 20px;
            text-align: center;
            margin-bottom: 10px;
            color: #333; /* Dark text color for the title */
        }

        .id-card-content p {
            font-size: 16px;
            line-height: 1.5;
            margin: 8px 0;
            color: #555; /* Slightly lighter color for text */
        }

        .id-card-content strong {
            color: #007bff; /* Blue color for strong text (labels) */
        }

        /* Button styles for generating ID cards */
        button {
            background-color: #007bff; /* Blue background for buttons */
            color: white; /* White text on buttons */
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3; /* Darker blue on hover */
        }

        /* Printing styles */
        @media print {
            .id-card {
                page-break-before: always;
            }

            /* Remove background and shadows when printing */
            .id-card {
                box-shadow: none;
                background-color: white;
            }
        }

        /* Container for all ID cards */
        #idCardsContainer {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }

        /* Styles for the ID cards container */
        #idCardsContainer .id-card {
            width: 300px; /* Adjust width for printed layout */
            margin: 10px;
        }

#report {
    background-color: green; /* For visibility */
    border: 2px solid red;    /* For debugging */
}
.text-success {
    color: green;
    font-weight: bold;
}
.text-error {
    color: red;
    font-weight: bold;
}

    .menu-button {
        width: 150px; /* Adjust the button width */
        padding: 10px; /* Add some padding for better appearance */
        border: none;
        background-color: #4CAF50; /* Green color */
        color: white;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
    }
.alert {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 20px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 10px;
    text-align: center;
    z-index: 1000;
    display: none;
}

.alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.alert-warning {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
}
    .menu-button:hover {
        background-color: #45a049; /* Slightly darker green on hover */
    }
/* Logo Style */
.logo-img {
    max-width: 80px; /* Limit the logo size */
    margin-bottom: 1px; /* Space between logo and text */
}
.firework {
    position: absolute;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: radial-gradient(circle, yellow, red);
    animation: explode 1s linear infinite;
    pointer-events: none;
}

@keyframes explode {
    0% {
        transform: scale(0);
        opacity: 1;
    }
    100% {
        transform: scale(2);
        opacity: 0;
    }
    }
    #loginSection input[type="text"],
    #loginSection input[type="password"] {
        width: calc(100% - 20px); /* Adjust input width */
        padding: 8px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    #loginSection button {
        width: 100%; /* Full-width button */
        padding: 10px;
        font-size: 14px;
        background-color: #4CAF50; /* Green color */
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .warning-message {
        color: red;
        font-weight: bold;
    }
    .success-message {
        color: green;
        font-weight: bold;
    }
.bottom-footer {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  background-color: #333;
  color: #fff;
  text-align: center;
  padding: 10px;
  height: 50px; /* Consistent height for footer */
}
.bottom-footer {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  background-color: #333;
  color: #fff;
  text-align: center;
  padding: 10px;
  height: 50px; /* Consistent height for footer */
}


#alertContainer div {
    animation: fadeInOut 3.5s;
}

@keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(-10px); }
    10%, 90% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-10px); }
}

button {
    min-width: 48px; /* Recommended minimum size for touch targets */
    min-height: 48px;
    padding: 10px 15px;
    font-size: 16px; /* Larger font for readability */
}
/* Stacked forms on small screens */
@media (max-width: 600px) {
    form input, form select, form button {
        width: 100%; /* Full width on small screens */
        margin-bottom: 10px; /* Add spacing */
    }
}
/* Scrollable table on small screens */
@media (max-width: 768px) {
    .report-table {
        display: block;
        overflow-x: auto; /* Allow horizontal scrolling */
        white-space: nowrap; /* Prevent text wrapping */
    }
    .report-table th, .report-table td {
        font-size: 12px; /* Reduce font size */
    }
}

    #loginSection button:hover {
        background-color: #45a049; /* Slightly darker green */
    } 
  <style>
/* Button Colors */
.btn-report { background-color: #4CAF50; color: white; }      /* Green */
.btn-print { background-color: #FF9800; color: white; }       /* Orange */
.btn-champions { background-color: #2196F3; color: white; }   /* Blue */
.btn-ranking { background-color: #9C27B0; color: white; }     /* Purple */
.btn-performance { background-color: #F44336; color: white; } /* Red */
.btn-print-champions { background-color: #00BCD4; color: white; } /* Cyan */
.btn-print-ranking { background-color: #FFC107; color: white; }   /* Amber */
.btn-print-performance { background-color: #673AB7; color: white; } /* Dark Purple */

button:hover {
    opacity: 0.9; /* Add a hover effect */
 }body 
{
            font-family: Arial, sans-serif;
        }
        .hidden-section {
            display: none; /* Hide sections by default */
        }
        button {
            margin: 8px;
            padding: 8px 10px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 3px;
        }
button {
    margin: 10px;
    padding: 10px 15px;
    font-size: 14px;
    border: none;
    border-radius: 5px;
    color: white;
    cursor: pointer;
}
/* Style the toggle button */
.btn-toggle {
    background-color: #4CAF50; /* Green background */
    color: white;
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}
/* Printing styles */
@media print {
    .id-card {
        page-break-before: always;
    }
.btn-toggle:hover {
    background-color: #45a049; /* Darker green on hover */
}

/* Style the form container */
#staffRegistrationForm {
    margin-top: 20px;
    padding: 20px;
    background-color: #f9f9f9;
    border: 1px solid #ccc;
    border-radius: 5px;
}

#staffRegistrationForm input {
    margin: 10px 0;
    padding: 8px;
    width: 100%;
    box-sizing: border-box;
}

#staffRegistrationForm button {
    background-color: #4CAF50; /* Green background */
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}
/* Style the toggle button */
.btn-toggle {
    background-color: #4CAF50; /* Green background */
    color: white;
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.btn-toggle:hover {
    background-color: #45a049; /* Darker green on hover */
}

/* Style the form container */
#staffRegistrationForm {
    margin-top: 20px;
    padding: 20px;
    background-color: #f9f9f9;
    border: 1px solid #ccc;
    border-radius: 5px;
}

#staffRegistrationForm input {
    margin: 10px 0;
    padding: 8px;
    width: 100%;
    box-sizing: border-box;
}

#staffRegistrationForm button {
    background-color: #4CAF50; /* Green background */
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

#staffRegistrationForm button:hover {
    background-color: #45a049; /* Darker green on hover */
}

#staffRegistrationForm button:hover {
    background-color: #45a049; /* Darker green on hover */
}

/* Different colors for each button */
.btn-red {
    background-color: #f44336; /* Red */
}
.btn-red:hover {
    background-color: #d32f2f; /* Darker red on hover */
}

.btn-blue {
    background-color: #2196F3; /* Blue */
}
.btn-blue:hover {
    background-color: #1976D2; /* Darker blue on hover */
}

.btn-green {
    background-color: #4CAF50; /* Green */
}
.btn-green:hover {
    background-color: #388E3C; /* Darker green on hover */
}

.btn-orange {
    background-color: #FF9800; /* Orange */
}
.btn-orange:hover {
    background-color: #F57C00; /* Darker orange on hover */
}

.btn-purple {
    background-color: #9C27B0; /* Purple */
}
.btn-purple:hover {
    background-color: #7B1FA2; /* Darker purple on hover */
}


        /* Styling for the Register Learner form */
        #registerLearnerSection {
            background-color: #e3f2fd; /* Light blue */
            border: 2px solid #2196f3; /* Blue border */
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
   
        /* Styling for the Junior School Marks Entry Section form */
        #juniorMarksEntrySection {
            background-color: #fff8e1; /* Light amber */
            border: 2px solid #ffc107; /* Amber border */
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        /* Styling for the Bulk Report Generation box */
        #bulkReportGeneration {
            background-color: #fce4ec; /* Light pink */
            border: 2px solid #e91e63; /* Pink border */
            border-radius: 5px;
            padding: 5px;
            margin-top: 5px;
        }
} .hidden-section { display: none; /* Hide sections by default */ } button { margin: 5px; padding: 5px 5px; font-size: 14px; cursor: pointer; border-radius: 5px; }

/* Styling for the Actions For Junior School box */
#juniorSchoolActions {
    background-color: #e8f5e9; /* Light green */
    border: 2px solid #4CAF50; /* Green border */
    border-radius: 10px;
    padding: 10px;
    margin-top: 10px;
    width: 200px; /* Set the width to a smaller value */
    /* Adjust the width as needed for your layout */
}

/* Styling for the Marks table box */
        #markstable {
            background-color: #e8f5e9; /* Light green */
            border: 2px solid #4CAF50; /* Green border */
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px
         }
        /* Input and button styling for all forms */
        input[type="text"], input[type="number"], input[type="file"], select {
            width: 25%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
        }
        h1 {
            color: #4CAF50;
            text-align: center;
        }
        .header {
            font-weight: bold;
            text-align: center;
            border: 3px solid #4CAF50;
            padding: 10px;
            background-color: #e1f5fe;
            margin-bottom: 20px;
        }
        .section {
            background-color: #ffffff;
            border: 3px solid #4CAF50;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
       .report-details, .comment-section {
            margin: 20px 0;
            font-weight: bold;
            background-color: #e1f5fe;
            padding: 10px;
            border-radius: 5px;
        }
        .report-table, .learners-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: #e6f7ff;
        }
        .report-table th, .report-table td, .learners-table th, .learners-table td {
            border: 2px solid black;
            padding: 8px;
            text-align: center;
        }
        .report-table td.total-marks {
            font-weight: bold;
            border: 2px solid black; /* Add a border to Total Marks */
        }
        .stamp {
            border: 2px solid blue; /* Border for stamp */
            color: blue; /* Text color for stamp */
            width: 200px; /* Adjusted width for visibility */
            height: 70px; /* Adjusted height for visibility */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            text-align: center;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], select {
            width: calc(100% - 22px);
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;

        }
        button {
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 0;
        }
        button:nth-of-type(1) {
            background-color: #2196F3; /* Color for the first button */
        }
        button:nth-of-type(2) {
            background-color: #FF9800; /* Color for the second button */
        }
        button:nth-of-type(3) {
            b ackground-color: #F44336; /* Color for the third button */
        }
        button {
            background-color: #4CAF50; /* Default color for buttons */
        }
        button:hover {
            background-color: #45a049; /* Hover effect */

        }
        @media print {
            .section {
                page-break-after: always;
        }
    .total-marks {
        font-weight: bold;
        border: 3px solid black; /* Add a border to Total Marks */
        padding: 8px;
        margin-bottom: 20px; /* Adds spacing below the total marks */
    }
    
    .comment-section {
        margin-top: 20px; /* Adds space above the comments */
        margin-bottom: 20px; /* Adds space below the comments */
    }

    .signature-section {
        margin-top: 30px; /* Adds extra space for the signatures */
    }
@media print {
  body * {
    visibility: hidden !important;
  }

  #marksStatusWrapper, #marksStatusWrapper * {
    visibility: visible !important;
  }

  #marksStatusWrapper {
    position: absolute !important;
    top: 0;
    left: 0;
    width: 100%;
    background: white;
    padding: 20px;
  }

  #toggleMarksStatusBtn,
  #printHeader {
    display: block !important; /* Show header only during print */
  }

  #printHeader {
    text-align: center !important;
    margin-bottom: 20px !important;
  }

  #marksStatusWrapper button {
    display: none !important; /* Hide all buttons */
  }
}
/* Highlighted styling for total and average summary rows */
#marksList .summary-row {
    background-color: #e8f5e9; /* Light green background */
    font-weight: bold;
    color: #2e7d32; /* Deep green text */
    border-top: 2px solid #4CAF50;
}


    </style>
</head>
<body>
     <div id="loginSection" style="display: block; text-align: center; margin-top: 30px;">
 <div class="logo">
        <img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo" class="logo-img">
    </div>
   <h1>RASM School Management System</h1>
<p style="color: red; font-weight: bold;">NACHU COMPREHENSIVE SCHOOL </p>
    <form id="loginForm">
        <input type="text" id="username" placeholder="Username" required><br><br>
        <input type="password" id="password" placeholder="Password" required><br><br>
      <button type="submit" class="btn-login">
            <span class="material-icons">login</span> Login
        </button>
    </form>
    <div id="loginError" style="color: red; display: none;">Invalid username or password</div>
    <br>
    <button onclick="showResetPasswordForm()">Forgot Password?</button>
</div>
<div id="resetPasswordSection" style="display: none; text-align: center; margin-top: 50px;">
    <h2>Reset Password</h2>
    <form id="resetPasswordForm">
        <input type="text" id="resetUsername" placeholder="Username" required><br><br>
        <input type="text" id="securityAnswer" placeholder="Your favorite color?" required><br><br>
        <input type="password" id="newPassword" placeholder="New Password" required><br><br>
        <input type="password" id="confirmPassword" placeholder="Confirm New Password" required><br><br>
        <button type="submit">Reset Password</button>
    </form>
    <button onclick="showLoginForm()">Back to Login</button>
    <div id="resetError" style="color: red; display: none;">Error resetting password</div>
    <div id="resetSuccess" style="color: green; display: none;">Password reset successfully!</div>
</div>
   <!-- Main Content -->
 <div id="mainContent" style="display: none;">
<!-- Header Section -->
<header class="header">
    <div class="logo">
        <img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo" class="logo-img">
    </div>
    <div class="header-text">
        <h1>Welcome To Rasm School Automation Management System</h1>
<p style="color: red; font-weight: bold;">Your Gateway To Smooth And Efficient School Management </p>
    </div>
<p style="color: red; font-weight: bold;">NACHU COMPREHENSIVE SCHOOL</p>
</header>

<button class="btn-bright green" onclick="toggleSection('registeredLearnersBox')">
    <span class="material-icons" style="color: #2ecc71;">groups</span> Learners Database
</button>

<button class="btn-actions" onclick="toggleSection('juniorSchoolActions')">
    <span class="material-icons">school</span> Assessment Actions
</button>
<button class="btn-purple" onclick="toggleSection('championsForm')">
    <span class="material-icons" style="color: #9b59b6;">admin_panel_settings</span> Admin Details
</button>

<!-- Menu Button -->
<button id="menuToggle" class="btn-toggle" onclick="toggleSection('menuActions')">
    <span class="material-icons" style="color: #3498db;">group</span> Manage Staff
</button>

<button id="logoutButton" onclick="logout()" style="background-color: #e74c3c; color: white; border: none; padding: 10px 15px; font-size: 16px; cursor: pointer; border-radius: 5px;">
    <i class="fas fa-sign-out-alt" style="color: #fff; margin-right: 5px;"></i> Logout
</button>

<!-- Button to Show/Hide Fee Management Menu -->
<button onclick="toggleFeeActionsMenu()" style="background-color: #d32f2f; color: white; border: none; padding: 10px 15px; font-size: 16px; cursor: pointer; border-radius: 5px; margin-bottom: 10px;">
    <i class="fas fa-cogs" style="color: #ffeb3b;"></i> Manage Fees
</button>

<section id="library-records"> 
 
  <!-- Toggle Button -->
  <button
    type="button"
    onclick="toggleLibraryManagement()"
    style="display: flex; align-items: center; gap: 5px;"
  >
    <i class="fas fa-book" style="font-size: 16px;"></i> Library Records 
  </button>

  <!-- Library Management Section -->
  <div id="library-management" style="display: none; margin-top: 20px;">

    <!-- Toggle Form Visibility Button -->
    <button
      type="button"
      id="manage-library-btn"
      onclick="toggleFormVisibility()"
      style="margin-bottom: 20px;"
    >
      Library
    </button>

    <!-- Add Record Form -->
    <form id="record-form" onsubmit="addRecord(event)" style="display: none;">
      <label>
        Name:
        <input type="text" id="name" required />
      </label>

      <label>
        Grade:
        <input type="text" id="grade" required />
      </label>

      <label>
        Book No:
        <input type="text" id="bookNo" required />
      </label>

      <label>
        <label for="date">Date:</label>
        <input type="date" id="date" readonly />
      </label>

      <!-- Issued Books -->
      <fieldset>
        <legend>Issued Books</legend>
        <label>
          <input
            type="checkbox"
            id="selectAllIssued"
            onclick="toggleCheckboxes('issuedBooks', this)"
          />
          Select All
        </label>
        <div id="issuedBooks">
          <!-- Issued Book Options -->
          <label><input type="checkbox" value="English" /> English</label>
          <label><input type="checkbox" value="Maths" /> Maths</label>
          <label><input type="checkbox" value="Pre-technical" /> Pre-technical</label>
          <label><input type="checkbox" value="Kiswahili" /> Kiswahili</label>
          <label><input type="checkbox" value="Science" /> Science</label>
          <label><input type="checkbox" value="Social Studies" /> Social Studies</label>
          <label><input type="checkbox" value="Business" /> Business</label>
          <label><input type="checkbox" value="Agriculture" /> Agriculture</label>
          <label><input type="checkbox" value="Health Education" /> Health Education</label>
          <label><input type="checkbox" value="Sports" /> Sports</label>
          <label><input type="checkbox" value="Performing Art" /> Performing Art</label>
          <label><input type="checkbox" value="Life Skills" /> Life Skills</label>
          <label><input type="checkbox" value="Computer" /> Computer</label>
          <label><input type="checkbox" value="Visual Art" /> Visual Art</label>
          <label><input type="checkbox" value="Chemistry" /> Chemistry</label>
          <label><input type="checkbox" value="Biology" /> Biology</label>
          <label><input type="checkbox" value="Physics" /> Physics</label>
          <label><input type="checkbox" value="Geography" /> Geography</label>
          <label><input type="checkbox" value="History" /> History</label>
          <label><input type="checkbox" value="Physical Education" /> Physical Education</label>
        </div>
      </fieldset>

      <!-- Lost Books -->
      <fieldset>
        <legend>Lost Books</legend>
        <label>
          <input
            type="checkbox"
            id="selectAllLost"
            onclick="toggleCheckboxes('lostBooks', this)"
          />
          Select All
        </label>
        <div id="lostBooks">
          <!-- Lost Book Options -->
          <label><input type="checkbox" value="English" /> English</label>
          <label><input type="checkbox" value="Maths" /> Maths</label>
          <label><input type="checkbox" value="Pre-technical" /> Pre-technical</label>
          <label><input type="checkbox" value="Kiswahili" /> Kiswahili</label>
          <label><input type="checkbox" value="Science" /> Science</label>
          <label><input type="checkbox" value="Social Studies" /> Social Studies</label>
          <label><input type="checkbox" value="Business" /> Business</label>
          <label><input type="checkbox" value="Agriculture" /> Agriculture</label>
          <label><input type="checkbox" value="Health Education" /> Health Education</label>
          <label><input type="checkbox" value="Sports" /> Sports</label>
          <label><input type="checkbox" value="Performing Art" /> Performing Art</label>
          <label><input type="checkbox" value="Life Skills" /> Life Skills</label>
          <label><input type="checkbox" value="Computer" /> Computer</label>
          <label><input type="checkbox" value="Visual Art" /> Visual Art</label>
          <label><input type="checkbox" value="Chemistry" /> Chemistry</label>
          <label><input type="checkbox" value="Biology" /> Biology</label>
          <label><input type="checkbox" value="Physics" /> Physics</label>
          <label><input type="checkbox" value="Geography" /> Geography</label>
          <label><input type="checkbox" value="History" /> History</label>
          <label><input type="checkbox" value="Physical Education" /> Physical Education</label>
        </div>
      </fieldset>

      <label for="status">Status:</label>
      <input type="text" id="status" readonly />

      <button type="submit">
  <i class="fas fa-plus-circle"></i> Add Record
</button>
    </form>

    <!-- Search and Filter Section -->
    <section id="filters" style="margin-top: 20px;">
      <input
        type="text"
        id="search-bar"
        placeholder="Search by name..."
        oninput="searchTable()"
        style="margin-right: 10px;"
      />
      <select id="grade-filter" onchange="searchTable()">
        <!-- Options dynamically populated -->
      </select>
    </section>

    <!-- Records Table -->
    <table
      border="1"
      style="width: 100%; border-collapse: collapse; margin-top: 20px; text-align: left;"
    >
      <thead>
        <tr>
          <th>No</th>
          <th>Name</th>
          <th>Grade</th>
          <th>Book No</th>
          <th>Date</th>
          <th>Issued Books</th>
          <th>Lost Books</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <!-- Dynamically generated rows -->
      </tbody>
    </table>

  <!-- Button with an icon -->
<button onclick="printFilteredTable()" style="margin-top: 20px;">
  <i class="fas fa-print"></i> Print Table
</button>
    <!-- Library Cards Section -->
    <div id="library-cards-section" style="margin-top: 20px;">
      <select id="grade-filter">
        <option value="All">All Grades</option>
      </select>
     <!-- Button with an icon -->
 <button
        onclick="generateLibraryCards()"
        style="
          margin-left: 10px;
          padding: 10px 20px;
          background-color: #007BFF;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
        "
      >
        Generate Library Cards
      </button>
    </div>
  </div>




  <!-- Fee Management Actions Box (Initially Hidden) -->
  <div id="feeActionsBox" style="display: none; text-align: center; background: #fff; padding: 10px; border-radius: 10px; box-shadow: 0px 4px 10px rgba(0,0,0,0.2); margin-top: 10px; width: 45%; margin-left: auto; margin-right: auto;">
    <h2 style="color: #4CAF50; margin-bottom: 10px;">Fee Management Actions</h2>
    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
      <!-- Button to Toggle Fee Capture Form --> 
    <!-- Record Fee Button -->
<!-- Record Fee Button -->
<button onclick="openOnlyOneSection('feeCaptureForm')" style="width: 40%; padding: 10px; background-color: #388E3C; color: white; border: none; border-radius: 5px; cursor: pointer;">
  <i class="fas fa-plus-circle"></i> Record Fee Here
</button>

<!-- View Fee Records Button -->
<button onclick="openOnlyOneSection('feeSummaryTableContainer')" style="width: 40%; padding: 10px; background-color: #F57C00; color: white; border: none; border-radius: 5px; cursor: pointer;">
  <i class="fas fa-folder-open"></i> My Fee Records
</button>

<!-- Show Filtered Records Button -->
<button id="togglePrintFilteredRecordsBtn" onclick="openOnlyOneSection('filteredFeeTableContainer')" 
  style="width: 40%; padding: 10px; background-color: #1976D2; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
  <i class="fas fa-print"></i> Show Filtered Records
</button>


<!-- Archive Fees Button -->
<button type="button" onclick="archiveFeesTable()" class="btn-archive" 
  style="width: 40%; padding: 10px; background-color: #8E44AD; color: white; border: none; border-radius: 5px; cursor: pointer;">
  <i class="fas fa-archive"></i> Archive Fees
</button>

<!-- View Archived Fees Button -->
<button id="toggleViewArchivedBtn" onclick="openOnlyOneSection('archivedFeesContainer')" 
  style="width: 40%; padding: 10px; background-color: #1976D2; color: white; border: none; border-radius: 5px; cursor: pointer;">
  <i class="fas fa-eye"></i> View Archived Fees
</button>

<!-- Print Payment Summary Button -->
<button onclick="printPaymentSummary()" id="printSummaryBtn" 
  style="width: 40%; padding: 10px; background-color: #0277BD; color: white; border: none; border-radius: 5px; cursor: pointer; display: none;">
  <i class="fas fa-print"></i> Print Summary
</button>

<!-- Show Fee Collection Summary Button -->
<button id="toggleSummaryBtn" onclick="openOnlyOneSection('feeSummaryContainer')" 
  style="padding: 10px; background: #9C27B0; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
  <i class="fas fa-chart-bar"></i> Show Fee Collection Summary
</button>

<!-- Show Defaulters List Button -->
<button onclick="openOnlyOneSection('defaultersTableContainer')" 
  style="width: 40%; padding: 10px; background-color: red; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
  <i class="fas fa-exclamation-triangle"></i> Defaulters List
</button>

<!-- Payment Summary Button -->
<button onclick="openOnlyOneSection('paymentSummaryContainer')" class="neon-button btn-purple" 
  style="width: 50%; padding: 10px; margin-bottom: 15px; background-color: #9C27B0; color: white; border: none; border-radius: 5px; cursor: pointer;">
  <i class="fas fa-chart-bar"></i> Payment Summary Per Grade
</button>

<!-- Delete All Fee Records Button -->
<button onclick="deleteFeeRecordsTable()" 
  style="padding: 10px; background: red; color: white; border: none; cursor: pointer; border-radius: 5px;">
  <i class="fas fa-trash-alt"></i> Delete All Fee Records
</button>

<!-- Button to Show Learner Count -->
<button onclick="openOnlyOneSection('learnerCountContainer')" 
  style="background: #4CAF50; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer;">
  <i class="fas fa-users"></i> Show Learner Count Per Grade
</button>
  </div>
   <!-- Archived Fees Container -->
<div id="archivedFeesContainer" style="display: none; text-align: left; background: #f0f0f0; padding: 15px; border-radius: 5px; margin-top: 20px;">
  <h2 style="color: #4CAF50;">Archived Fee Records</h2>

  <!-- Search Box for Filtering Archived Fees -->
  <label for="archivedGradeFilter"><strong>Filter by Grade:</strong></label>
  <input type="text" id="archivedGradeFilter" onkeyup="filterArchivedFees()" placeholder="Enter grade to filter" 
         style="margin-bottom: 10px; padding: 5px; width: 200px; border: 1px solid #ccc; border-radius: 5px;">

  <div id="archivedFeesList"></div>
</div>


  <!-- Fee Capture Form (Initially Hidden) -->
  <div id="feeCaptureForm" style="display: none; text-align: center; padding: 20px; width: 60%; margin: auto; background: #fff; box-shadow: 0px 4px 10px rgba(0,0,0,0.2); border-radius: 10px;">
    <h2 style="color: #333;">Fee Capture Form</h2>
    <form id="feeForm">
      <label for="feeLearnerName"><strong>Learner Name:</strong></label>
      <input type="text" id="feeLearnerName" placeholder="Enter learner name" required><br><br>
      <label for="feeLearnerGrade"><strong>Grade:</strong></label>
      <input type="text" id="feeLearnerGrade" placeholder="Enter learner grade" required><br><br>
      <label for="securityFee"><strong>Security Fee (KSH):</strong></label>
      <input type="number" id="securityFee" placeholder="Enter amount" required><br><br>
      <label for="bomFee"><strong>BOM Fee (KSH):</strong></label>
      <input type="number" id="bomFee" placeholder="Enter amount" required><br><br>
      <label for="tuitionFee"><strong>Tuition Fee (KSH):</strong></label>
      <input type="number" id="tuitionFee" placeholder="Enter amount" required><br><br>
      <label for="exam1Fee"><strong>Exam 1 Fee (KSH):</strong></label>
      <input type="number" id="exam1Fee" placeholder="Enter amount" required><br><br>
      <label for="exam2Fee"><strong>Exam 2 Fee (KSH):</strong></label>
      <input type="number" id="exam2Fee" placeholder="Enter amount" required><br><br>
      <label for="exam3Fee"><strong>Exam 3 Fee (KSH):</strong></label>
      <input type="number" id="exam3Fee" placeholder="Enter amount" required><br><br>
      <label for="activityFee"><strong>Activity Fee (KSH):</strong></label>
      <input type="number" id="activityFee" placeholder="Enter amount" required><br><br>
      <button type="submit" style="padding: 10px 15px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px;">
        Save Fee Details
      </button>
    </form>
  </div>

  <!-- Fee Summary Table Container (Wrapped with Grade Filter) -->
<div id="feeSummaryTableContainer" style="display: none; text-align: center; padding: 20px; width: 100%; margin: auto; background: #fff; box-shadow: 0px 4px 10px rgba(0,0,0,0.2); border-radius: 10px;">
    <h2 style="margin-bottom: 10px; color: #333;">Fee Records</h2>

    <!-- Search Learner -->
    <input type="text" id="searchLearnerFee" onkeyup="searchLearnerFee()" placeholder="Search for learner..." 
    style="margin-bottom: 10px; padding: 8px; width: 250px; border: 1px solid #ccc; border-radius: 5px; text-align: center;">

    <!-- Grade Filter -->
    <label for="gradeFilter"><strong>Filter by Grade:</strong></label>
    <select id="gradeFilter" onchange="filterFeeRecords()">
        <option value="">All Grades</option>
        <option value="1">Grade 1</option>
        <option value="2">Grade 2</option>
        <option value="3">Grade 3</option>
        <option value="4">Grade 4</option>
        <option value="5">Grade 5</option>
        <option value="6">Grade 6</option>
        <option value="7">Grade 7</option>
        <option value="8">Grade 8</option>
        <option value="9">Grade 9</option>
    </select>

    <table class="learners-table" id="feeSummaryTable" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <thead>
            <tr style="background: #4CAF50; color: white;">
                <th>No</th>
                <th>Learner Name</th>
                <th>Grade</th>
                <th>Security Fee</th>
                <th>BOM Fee</th>
                <th>Tuition Fee</th>
                <th>Exam 1 Fee</th>
                <th>Exam 2 Fee</th>
                <th>Exam 3 Fee</th>
                <th>Activity Fee</th>
                <th>Constant Fee</th>
                <th>Total Paid</th>
                <th>Total Balance</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="feeSummaryTableBody"></tbody>
    </table>
</div>

  <!-- Receipt Container -->
  <div id="receiptContainer" style="display: none; text-align: center; border-radius: 10px; padding: 20px; width: 60%; margin: auto; background: #fff; box-shadow: 0px 4px 10px rgba(0,0,0,0.2); font-family: 'Arial', sans-serif;">
    <!-- School Header -->
    <div style="display: flex; align-items: center; justify-content: center;">
      <img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo" style="max-width: 80px; margin-right: 10px;">
      <div style="text-align: left;">
        <h2 style="margin: 0;">NACHU COMPREHENSIVE SCHOOL</h2>
        <p style="margin: 2px; font-size: 14px; color: #555;">561-00902 Kikuyu, Kenya</p>
        <p style="margin: 2px; font-size: 14px; color: #555;">Phone: +254-700-123456</p>
      </div>
    </div>
    <hr style="border: 1px solid #ddd; margin: 10px 0;">
    <!-- Receipt Title -->
    <h3 style="margin-bottom: 5px; color: #333; text-transform: uppercase;">Official Fee Payment Receipt</h3>
    <!-- Receipt Details -->
    <div style="display: flex; justify-content: space-between; padding: 0 20px; font-size: 14px; color: #444;">
      <p><strong>Receipt No:</strong> <span id="receiptNo"></span></p>
      <p><strong>Date:</strong> <span id="receiptDate"></span></p>
    </div>
    <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; text-align: left; font-size: 14px;">
      <p><strong>Learner Name:</strong> <span id="receiptLearner"></span></p>
      <p><strong>Grade:</strong> <span id="receiptGrade"></span></p>
      <p><strong>Payment Method:</strong> Cash / MPESA</p>
    </div>
    <!-- Fee Breakdown Table -->
    <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px;">
      <thead>
        <tr style="background: #4CAF50; color: white;">
          <th style="border: 1px solid #ddd; padding: 8px;">Fee Item</th>
          <th style="border: 1px solid #ddd; padding: 8px;">Amount (KSH)</th>
        </tr>
      </thead>
      <tbody id="receiptTableBody" style="background: #f9f9f9;"></tbody>
    </table>
    <!-- Total Amounts -->
    <p style="font-size: 16px; font-weight: bold; margin-top: 10px;">Total Fees: KSH <span id="receiptTotal"></span></p>
    <p style="font-weight: bold; color: green;">Amount Paid: KSH <span id="receiptPaid"></span></p>
    <p style="font-weight: bold; color: red;">Balance: KSH <span id="receiptBalance"></span></p>
    <!-- Official Stamp -->
    <div style="border: 2px solid blue; color: blue; width: 150px; height: 80px; margin: 15px auto; text-align: center; font-weight: bold; display: flex; align-items: center; justify-content: center;">
      NACHU COMPREHENSIVE SCHOOL 
    </div>
    <!-- Authorized Signature -->
    <div style="text-align: left; margin-top: 30px; font-size: 14px;">
      <p><strong>Authorized by:</strong> _____________________</p>
      <p><strong>Signature:</strong> _____________________</p>
    </div>
    <!-- Footer Note -->
    <p style="margin-top: 20px; font-style: italic; font-size: 12px;">Thank you for your payment. For inquiries, contact our office.</p>
    <!-- Print and Download Buttons -->
    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
      <button onclick="printReceipt()" style="padding: 10px 15px; background: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px;">Print Receipt</button>
      <button onclick="downloadReceiptPDF()" style="padding: 10px 15px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px;">Download PDF</button>
    </div>
  </div>
</div>

  <!-- Filtered Fee Table Container -->
  <div id="filteredFeeTableContainer" style="display: none; text-align: center; padding: 20px; width: 90%; margin: auto; background: #fff; box-shadow: 0px 4px 10px rgba(0,0,0,0.2); font-family: 'Arial', sans-serif;">
    <!-- School Header -->
    <div style="display: flex; align-items: center; justify-content: center;">
      <img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo" style="max-width: 80px; margin-right: 10px;">
      <div style="text-align: left;">
        <h2 style="margin: 0;">NACHU COMPREHENSIVE SCHOOL </h2>
        <p style="margin: 2px; font-size: 14px; color: #555;">561-00902 Kikuyu, Kenya</p>
        <p style="margin: 2px; font-size: 14px; color: #555;">Phone: +254-700-123456</p>
        <p style="margin: 2px; font-size: 14px; color: #555;"><strong>School Motto:</strong> "Excellence Through Knowledge"</p>
        <p style="margin: 2px; font-size: 14px; color: #555;"><strong>Year:</strong> <span id="currentYear"></span></p>
      </div>
    </div>
    <hr style="border: 1px solid #ddd; margin: 10px 0;">
    <!-- Report Title -->
    <h3 style="margin-bottom: 5px; color: #333; text-transform: uppercase;">Filtered Fee Records for <span id="selectedGrade"></span></h3>
    <!-- Fee Table -->
    <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px;">
      <thead>
        <tr style="background: #4CAF50; color: white;">
          <th style="border: 1px solid #ddd; padding: 8px;">#</th>
          <th style="border: 1px solid #ddd; padding: 8px;">Learner Name</th>
          <th style="border: 1px solid #ddd; padding: 8px;">Security Fee</th>
          <th style="border: 1px solid #ddd; padding: 8px;">BOM Fee</th>
          <th style="border: 1px solid #ddd; padding: 8px;">Tuition Fee</th>
          <th style="border: 1px solid #ddd; padding: 8px;">Exam 1 Fee</th>
          <th style="border: 1px solid #ddd; padding: 8px;">Exam 2 Fee</th>
          <th style="border: 1px solid #ddd; padding: 8px;">Exam 3 Fee</th>
          <th style="border: 1px solid #ddd; padding: 8px;">Activity Fee</th>
          <th style="border: 1px solid #ddd; padding: 8px;">Total Paid</th>
          <th style="border: 1px solid #ddd; padding: 8px;">Balance</th>
        </tr>
      </thead>
      <tbody id="filteredFeeTableBody" style="background: #f9f9f9;"></tbody>
    </table>
    <!-- Print & PDF Buttons -->
    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
      <button onclick="printFilteredFeeTable()" style="padding: 10px 15px; background: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px;">Print Report</button>
      <button onclick="downloadFeeTablePDF()" style="padding: 10px 15px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px;">Download PDF</button>
    </div>
  </div>

  <!-- Payment Summary Per Grade Section -->
  <div id="paymentSummaryContainer" style="display: none; margin-top: 20px; text-align: center; border: 2px solid black; padding: 20px;">
    <!-- School Header -->
    <div style="text-align: center; margin-bottom: 10px;">
      <img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo" style="max-width: 80px; margin-bottom: 5px;">
      <h2 style="margin: 0; color: #4CAF50;">NACHU COMPREHENSIVE SCHOOL </h2>
      <p style="margin: 2px; font-size: 14px;">P.O BOX 886-01000, THIKA, Kenya</p>
      <p style="margin: 2px; font-size: 14px;">Phone: +254-700-123456</p>
      <p style="margin: 2px; font-size: 14px; font-weight: bold;">School Motto: "Excellence Through Knowledge"</p>
      <h3 style="margin-top: 10px; color: #333;">Year: 2025</h3>
    </div>
    <h2 style="background: #4CAF50; color: white; padding: 10px;">Payment Summary Per Grade</h2>
    <table id="summaryTable" class="learners-table" style="width: 100%; border-collapse: collapse; border: 2px solid black;">
      <thead>
        <tr style="background: #4CAF50; color: white; border: 2px solid black;">
          <th style="border: 2px solid black; padding: 10px;">Grade</th>
          <th style="border: 2px solid black; padding: 10px;">Total Collected (KSH)</th>
          <th style="border: 2px solid black; padding: 10px;">Expected Amount (KSH)</th>
          <th style="border: 2px solid black; padding: 10px;">Balance (KSH)</th>
          <th style="border: 2px solid black; padding: 10px;">Status</th>
        </tr>
      </thead>
      <tbody id="paymentSummaryBody" style="border: 2px solid black;"></tbody>
    </table>
    <!-- Print Button -->
    <button onclick="printPaymentSummaryOnly()" class="neon-button btn-print" style="margin-top: 15px;">
      <i class="fas fa-print"></i> Print Payment Summary
    </button>
  </div>
<!-- Custom Delete Confirmation Modal -->
<div id="deleteConfirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000;">
  <div style="background: white; width: 350px; padding: 20px; border-radius: 10px; text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0px 4px 10px rgba(0,0,0,0.3);">
    <h2 style="color: red;">Warning</h2>
    <p id="deleteMessage" style="font-size: 16px; color: black;">Are you sure you want to delete all fee records? This action cannot be undone.</p>
    <button onclick="confirmDeleteFeeRecords()" style="background: red; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin: 10px;">Yes, Delete</button>
    <button onclick="closeDeleteModal()" style="background: grey; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
  </div>
</div>
<div id="customAlert" style="display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #4CAF50; color: white; padding: 15px; border-radius: 5px; font-size: 16px; text-align: center; width: 30px; box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);">

</div>
<div id="archiveAlert" style="display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #0288d1; color: white; padding: 15px; border-radius: 5px; font-size: 16px; text-align: center; width: 300px; box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);">
  Archived successfully!
</div>
<!-- Archive Confirmation Alert -->
<div id="archiveConfirmAlert" style="display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #fbc02d; color: black; padding: 15px; border-radius: 5px; font-size: 16px; text-align: center; width: 350px; box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);">
  An archive for <span id="archiveYear"></span> exists. Do you want to update it?
  <br><br>
  <button onclick="confirmArchive(true)" style="background-color: green; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer;">Yes</button>
  <button onclick="confirmArchive(false)" style="background-color: red; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer;">No</button>
</div>

<!-- Archive Success Alert -->
<div id="archiveSuccessAlert" style="display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #0288d1; color: white; padding: 15px; border-radius: 5px; font-size: 16px; text-align: center; width: 300px; box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);">
  Fees table for <span id="successYear"></span> archived successfully!
</div>

<!-- Summary Table Container (Initially Hidden) -->
<div id="feeSummaryContainer" style="display: none; margin-top: 20px;"></div>
<!-- Defaulters List Container -->
<div id="defaultersTableContainer" style="display: none; text-align: center; padding: 20px; width: 80%; margin: auto; background: #fff; box-shadow: 0px 4px 10px rgba(0,0,0,0.2); border-radius: 10px;">
    <h2 style="background: red; color: white; padding: 10px;">Defaulters List</h2>

    <!-- Search Learner -->
    <input type="text" id="searchDefaulter" onkeyup="searchDefaulter()" placeholder="Search for learner..." 
    style="margin-bottom: 10px; padding: 8px; width: 250px; border: 1px solid #ccc; border-radius: 5px; text-align: center;">

 <!-- Grade Filter -->
   <label for="defaultersGradeFilter"><strong>Filter by Grade:</strong></label>
<select id="defaultersGradeFilter" onchange="filterDefaulters()">
  <option value="">All Grades</option>
  <option value="1">Grade 1</option>
  <option value="2">Grade 2</option>
  <option value="3">Grade 3</option>
  <option value="4">Grade 4</option>
  <option value="5">Grade 5</option>
  <option value="6">Grade 6</option>
  <option value="7">Grade 7</option>
  <option value="8">Grade 8</option>
  <option value="9">Grade 9</option>
</select>

    <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px;">
        <thead>
            <tr style="background: red; color: white;">
                <th>No</th>
                <th>Learner Name</th>
                <th>Grade</th>
                <th>Balance Due (KSH)</th>
            </tr>
        </thead>
        <tbody id="defaultersTableBody" style="background: #f9f9f9;"></tbody>
    </table>

    <!-- Print Button -->
    <button onclick="printDefaultersList()" style="margin-top: 15px; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
        <i class="fas fa-print"></i> Print Defaulters List
    </button>
</div>

<!-- Collapsible Menu Actions --> 
<div id="menuActions" style="display: none;">
  <div class="menu-container">
<button class="menu-button" aria-label="Registration Options" onclick="toggleRegistrationMenu()"> 
  <i class="fas fa-cogs"></i> Registration Options 
</button> 

<div class="dropdown" id="registrationMenu">
  <button onclick="toggleSection('parentRegistrationSection')" class="neon-button" style="width: 90px; padding: 10px;">
    <i class="fas fa-user-plus"></i> Register Parent
  </button>
  <button onclick="toggleSection('staffRegistrationSection')" class="neon-button" style="width: 90px; padding: 10px;">
    <i class="fas fa-chalkboard-teacher"></i> Register Staff
  </button>
  <button onclick="toggleRegisterSupportStaff()" class="neon-button">
    <i class="fas fa-users-cog"></i> Register Support Staff
  </button>
  <button onclick="toggleSection('registeredParentsSection')" class="neon-button" style="width: 90px; padding: 10px;">
    <i class="fas fa-users"></i> View Parents
  </button>
  <button onclick="toggleSection('registeredStaffSection')" class="neon-button" style="width: 90px; padding: 10px;">
    <i class="fas fa-users"></i> View Staff
  </button>


 <button onclick="toggleSection('registerLearnerSection')" class="neon-button" style="width: 90px; padding: 10px;">
    <i class="fas fa-user-plus"></i> Register Learner
</button>

    </div>
  </div>
</div>

<div id="registerLearnerSection" style="max-width: 400px; margin: auto; display: none;">
    <h2>Register Learner</h2>
    <form id="learnerForm">
        <label>Name:</label> <input type="text" id="learnerName" required><br>
        <label>Gender:</label> <input type="text" id="learnerGender" required><br>
        <label>Grade:</label> <input type="text" id="learnerGrade" required><br>
        <label>Age:</label> <input type="number" id="learnerAge" required><br>
        <label>Parent Name:</label> <input type="text" id="parentName" required><br>
        <label>Parent Phone No:</label> <input type="text" id="learnerPhone" required><br>
        <label>Birth Certificate No:</label> <input type="number" id="birthCertificate" required><br>
        <label>Admission Number:</label> <input type="text" id="admissionNumber" required><br>

        <!-- Photo Upload -->
        <label>Photo:</label> <input type="file" id="learnerPhoto" accept="image/*" onchange="previewPhoto(event)"><br>

        <!-- Image Preview -->
        <img id="photoPreview" style="display:none; width:100px; height:100px; border-radius:10px; margin-top:10px;">

       <!-- Voice Input Button -->
<button type="button" onclick="startVoiceInput()" style="margin-top: 15px; padding: 10px; background: #007BFF; color: white; border: none; border-radius: 5px; cursor: pointer;">
    <i class="fas fa-microphone"></i> Start Voice Input
</button>

<!-- Add Learner Button -->
<button type="submit" style="margin-top: 15px; padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
    <i class="fas fa-user-plus"></i> Add Learner
</button>
    </form>
</div>

<!-- Custom Styled Prompt Box -->
<div id="voicePrompt" style="display: none; position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%);
    background: #4CAF50; color: white; padding: 20px; font-size: 18px; border-radius: 10px; text-align: center;
    box-shadow: 0px 4px 10px rgba(0,0,0,0.2);">
    <p id="promptText"></p>
</div
<div id="fireworks-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000;"></div>
   </div>
<div id="registeredLearnersBox" style="display: none;">
        <h2>Registered Learners</h2>
        <input type="text" id="searchLearner" onkeyup="searchLearner()" placeholder="Search for learner">
        <div class="menu-container">
<button class="menu-button" aria-label="Learners Options" onclick="toggleLearnersMenu()">
  <i class="fas fa-graduation-cap"></i> Learners Options
</button>

<div class="dropdown" id="learnersMenu">
<button class="neon-button btn-yellow" onclick="toggleSection('registerLearnerSection')">
    <span class="material-icons" style="color: #fbc02d;">person_add</span> Register Learner
</button>

<button onclick="printRegisteredLearners()" class="neon-button">
    <i class="fas fa-print" style="color: #2ecc71;"></i> Print Registered Learners
</button>

<button onclick="groupLearnersByGrade()" class="neon-button">
    <i class="fas fa-users" style="color: #3498db;"></i> Group by Grade
</button>

<button onclick="promoteLearners()" class="neon-button">
    <i class="fas fa-arrow-up" style="color: #e67e22;"></i> Promote Learners to Next Grade
</button>

<!-- Undo Promotion Button -->
<button onclick="undoPromotion()" class="neon-button neon-red">
    <i class="fas fa-undo" style="color: #c0392b;"></i> Undo Promotion
</button>

<button onclick="groupLearnersByGender()" class="neon-button">
    <i class="fas fa-transgender-alt" style="color: #9b59b6;"></i> Group by Gender
</button>

<button onclick="printGroupedByGender()" class="neon-button">
    <i class="fas fa-print" style="color: #2ecc71;"></i> Print Grouped by Gender
</button>

<!-- Button to Toggle Learners Count --> 
<button id="toggleLearnersCountButton" onclick="toggleLearnersCount()" class="neon-button">
    <i class="fas fa-eye" style="color: #f1c40f;"></i> Show Learners Count
</button>

<!-- Button to Print Learners Count -->
<button onclick="printLearnersCount()" class="neon-button orange-neon">
    <i class="fas fa-print" style="color: #e74c3c;"></i> Print Learners Count
</button>
<div style="margin-top: 20px;">
  <label for="gradeDropdown"><strong>Select Grade:</strong></label>
  <select id="gradeDropdown" onchange="showLearnerNamesOnly()" style="margin-left: 10px;">
    <option value="">-- Select Grade --</option>
  </select>

  <button onclick="printLearnersTable()" style="margin-left: 15px; padding: 6px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
    <i class="fas fa-print"></i> Print
  </button>

  <!-- Printable Section -->
  <div id="printableLearnersTable" style="margin-top: 20px;">
    <div id="printHeader" style="text-align: center; margin-bottom: 15px;">
      <img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo" style="max-height: 80px;"><br>
      <h2 style="margin: 5px 0; color: black;">NACHU PRIMARY SCHOOL</h2>
      <h3 style="margin: 5px 0; color: black;">Learner List - <span id="selectedGradeHeader"></span></h3>
    </div>

    <table id="learnersNameTable" style="border-collapse: collapse; width: 100%; color: black;">
      <thead>
        <tr style="background-color: #4CAF50; color: white;">
          <th style="border: 1px solid black; padding: 8px;">No</th>
          <th style="border: 1px solid black; padding: 8px;">Name</th>
        </tr>
      </thead>
      <tbody id="learnerNamesList"></tbody>
    </table>
  </div>
</div>

  
    <button class="neon-button btn-red" onclick="viewArchives()">
        <span class="material-icons" style="color: #d32f2f;">archive</span> View Archived Exams
    </button>
    
    <a href="https://drive.google.com/file/d/14qlKVZ_0nsgHqthYDAdks4qpHkZV6iN3/view?usp=drivesdk" download>Download Admission Form</a>
    
    <button class="neon-button btn-red" onclick="toggleArchives()">
        <span class="material-icons" style="color: #0288d1;">visibility</span> View Archived
    </button>

</div>
</div>

<div id="groupedByGender"></div>
        <div id="groupedLearners"></div>
        <table class="learners-table">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Photo</th>
                        <th>Name</th>
                        <th>Gender</th>
                        <th>Grade</th>
                        <th>Age</th>
                       <th>Parent Name</th>
                        <th>Parent Phone No</th>
                        <th>Birth Certificate No</th>
                        <th>Admission Number</th>
                     <th>Edit</th>
                </tr>
            </thead>
            <tbody id="learnersList"></tbody>
        </table>
    </div>
<div id="report"></div>
<div id="teacherPromptModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fce4ec; padding: 20px; border: 2px solid #e91e63; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); z-index: 1000;">
    <h3 style="color: #e91e63;">Kindly Capture The Following</h3>
    <p id="subjectPromptText" style="margin: 10px 0; font-size: 16px; color: #333;">Enter the teacher's name for the subject:</p>
    <input type="text" id="teacherNameInput" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;">
    <button id="submitTeacherName" style="background-color: #e91e63; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Submit</button>
</div>
<div id="overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999;"></div>
<div id="juniorMarksEntrySection" style="max-width: 400px; margin: auto; display: none;">
<h2>Junior School Marks Entry Section</h2>
<form id="marksForm">
    Grade:  
    <input type="text" id="marksGrade" placeholder="Enter Grade (e.g., 7A)" required><br>
    
    Learner:  
    <select id="learnerSelect">
        <option disabled selected>Select Grade First</option>
    </select><br>
    
    <!-- Display Learner Photo -->
    <img id="learnerPhotoDisplay" src="default.png" alt="Learner Photo" width="100" height="100" 
         style="display: none; border-radius: 10px; margin-top: 10px;"><br>

    <div>
        Eng: <input type="number" id="english" required><br>
        Math: <input type="number" id="math" required><br>
        Pre-technical Studies: <input type="number" id="preTech" required><br>
        Kiswahili: <input type="number" id="kiswahili" required><br>
        Integrated Science: <input type="number" id="science" required><br>
        Social Studies: <input type="number" id="social" required><br>
        Agriculture: <input type="number" id="agriculture" required><br>
        Religious Education: <input type="number" id="religion" required><br>
        Creative Art: <input type="number" id="art" required><br>
    </div>
    <button type="submit">Submit Marks</button>
</form>
</div>
<!-- Success Message -->
<div id="successMessage" style="
    display: none; 
    position: fixed; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    color: red; 
    font-size: 14px; 
    font-weight: bold; 
    background-color: #e8f5e9; 
    padding: 20px; 
    border: 2px solid #4CAF50; 
    border-radius: 10px; 
    text-align: center;">
    Marks submitted successfully!
</div>
<div id="promotionMessage" style="
    display: none; 
    position: fixed; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    color: blue; 
    font-size: 12px; 
    font-weight: bold; 
    background-color: #e3f2fd; 
    padding: 10px; 
    border: 2px solid #2196F3; 
    border-radius: 10px; 
    text-align: center;">
    Eligible learners have been promoted to another grade!
</div>
<!-- Success Message for Grouping by Gender -->
<div id="genderGroupMessage" style="
    display: none; 
    position: fixed; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    color: purple; 
    font-size: 12px; 
    font-weight: bold; 
    background-color: #f3e5f5; 
    padding: 10px; 
    border: 2px solid #9C27B0; 
    border-radius: 10px; 
    text-align: center;">
    Learners have been grouped by gender successfully!
</div>

<!-- Success Message for Grouping by Grade -->
<div id="gradeGroupMessage" style="
    display: none; 
    position: fixed; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    color: teal; 
    font-size: 12px; 
    font-weight: bold; 
    background-color: #e0f7fa; 
    padding: 10px; 
   border: 2px solid #9C27B0; 
    border-radius: 10px; 
    text-align: center;">
    Learners grouped by grade successfully!
</div>
<div id="marksTableSection" class="hidden-section">
        <h2>Marks Table</h2>
        
<button onclick="sendToArchives()" class="neon-button">
    <i class="fas fa-archive"></i> Send to Archives
</button>


<button onclick="saveCurrentMarksTable()" class="neon-button">
  <i class="fas fa-table"></i> Backup Merit
</button>
<div style="background-color: #ffeb3b; color: #000; padding: 10px; border-radius: 5px; font-weight: bold; display: flex; align-items: center;">
    <i class="fas fa-bullhorn" style="color: #d32f2f; font-size: 24px; margin-right: 8px;"></i> 
   RASM reminds you to backup,and send to archives your marks for further analysis.
</div>

   <div id="marksHeader"></div>
    <table class="report-table">
        <thead>
<button onclick="deleteMarksTable()" style="background: red; color: white; padding: 10px; border-radius: 5px; font-weight: bold;">
    <i class="fas fa-trash"></i> Delete Marks Table
</button>


<button id="toggleMarksStatusBtn" onclick="toggleMarksStatus()" style="background: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">
  <i class="fas fa-chart-bar"></i>  Marks Recording Summary
</button>
<div id="marksStatusWrapper" style="margin-top: 20px;"></div>

 <div style="background-color: #ffeb3b; color: #000; padding: 10px; border-radius: 5px; font-weight: bold; display: flex; align-items: center;">
    <i class="fas fa-bullhorn" style="color: #d32f2f; font-size: 24px; margin-right: 8px;"></i> 
    Kindly generate all reports before deleting this merit list.

<div style="margin-bottom: 10px;">
  <label for="gradeSelect"><strong>Filter by Grade:</strong></label>
  <select id="gradeSelect" onchange="filterMarksByGrade()">
    <option value="">All Grades</option>
  </select>
</div>
<div style="margin-top: 15px;">
  <button onclick="printFilteredGrades()" style="padding: 10px 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
    <i class="fas fa-print"></i> Print Filtered Grades
  </button>
</div>

</div>
            <th>No.</th> <!-- Serial Number -->
            <th>Learner</th> <!-- Learner Name -->
            <th>Grade</th> <!-- Grade -->
            <th>Eng</th><th>Lev</th>
            <th>Math</th><th>Lev</th>
            <th>Pre-Tech</th><th>Lev</th>
            <th>Kiswa</th><th>Lev</th>
            <th>Scie</th><th>Lev</th>
            <th>Sst</th><th>Lev</th>
            <th>Agric</th><th>Lev</th>
            <th>Cre</th><th>Lev</th>
            <th>C/A</th><th>Lev</th>
            <th>Total Marks</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="marksList"></tbody>
</table>
      <!-- Section for Subject Levels -->
<h2 style="background-color: #ffeb3b; color: #000; padding: 10px; border-radius: 5px; display: flex; align-items: center; gap: 10px; width: fit-content;">
    <i class="fas fa-chart-bar" style="color: #d32f2f;"></i> Subject Level Summary
</h2>

<table class="report-table">
    <thead>
        <tr>
            <th>Subject</th>
            <th>Level 1 (BE)</th>
            <th>Level 2 (AE)</th>
            <th>Level 3 (ME)</th>
            <th>Level 4 (EE)</th>
        </tr>
    </thead>
    <tbody id="subjectLevels"></tbody>
</table>


<!-- Simple Print Button -->
<button onclick="printSubjectLevels()" style="
    background-color: #4CAF50; 
    color: white; 
    border: none; 
    padding: 10px 15px; 
    font-size: 16px; 
    cursor: pointer; 
    border-radius: 5px;
">
    <i class="fas fa-print"></i> Print Subject Levels
</button>

    </div>
<!-- Archived Marks Section -->
<div id="archivesSection" class="hidden-section">
   <h2 style="background-color: #ffeb3b; color: #000; padding: 10px; border-radius: 5px; display: flex; align-items: center; gap: 10px; width: fit-content;">
    <i class="fas fa-archive" style="color: #d32f2f;"></i> Archived Marks
</h2>

    <div id="archivedMarksList"></div>
<button onclick="combineMeritListsByGrade()" class="neon-button">
  <i class="fas fa-sync-alt"></i> Get Overall Merit for Same Grade
</button>

<div id="combinedMeritLists"></div>

<button onclick="printCombinedMeritList()" class="neon-button">
  <i class="fas fa-print"></i> Print Overall  Merit
</button>
</div>
<div id="loadingSpinner" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
    <div style="border: 5px solid #f3f3f3; border-radius: 50%; border-top: 5px solid #3498db; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
</div>
<div id="juniorSchoolActions" class="hidden-section">
  <div class="menu-container">
<button class="menu-button" aria-label="COMPREHENSIVE SCHOOL Actions" onclick="toggleJuniorSchoolMenu()">
  <i class="fas fa-school" style="color: #3498db;"></i> HEY THERE! CLICK TO DIVE IN.
</button>

<div class="dropdown" id="juniorSchoolMenu">
  <button onclick="printAssessmentReport()" class="neon-button btn-print">
    <i class="fas fa-print" style="color: #2ecc71;"></i> Print Report
  </button>

  <button onclick="showSubjectChampions()" class="neon-button btn-champions"> 
    <i class="fas fa-trophy" style="color: orange;"></i> Learning Areas Star Achievers
  </button>

  <button onclick="showSubjectRanking()" class="neon-button btn-ranking">
    <i class="fas fa-chart-line" style="color: #f39c12;"></i> Learning Area Performance Index 
  </button>

  <button onclick="showSubjectPerformance()" class="neon-button btn-performance">
    <i class="fas fa-chart-bar" style="color: #9b59b6;"></i> Learning Area Performance Status
  </button>

  <button onclick="toggleSection('juniorMarksEntrySection')" class="neon-button btn-blue">
    <i class="fas fa-pen" style="color: #e74c3c;"></i> Record Outcomes
  </button>

  <button onclick="toggleSection('marksTableSection')" class="neon-button btn-red">
    <i class="fas fa-list" style="color: #1abc9c;"></i> Merit List
  </button>

  <button onclick="toggleSection('bulkReportGeneration')" class="neon-button btn-blue">
    <i class="fas fa-file-alt" style="color: #2c3e50;"></i> Bulk Report Generation
  </button>

  <button onclick="generateGenderPerformance()" class="neon-button">
    <i class="fas fa-venus-mars" style="color: #d35400;"></i> Generate Gender Merit List
  </button>

  <button onclick="togglePathwaysTable()" class="button toggle-button">
    <i class="fas fa-project-diagram" style="color: #16a085;"></i> Group Learners by Pathways
  </button>
<!-- Merit List Control Buttons -->
<button onclick="generateMeritList()" class="neon-button btn-ranking">
    <i class="fas fa-chart-line" style="color: #f39c12;"></i> Get Merit List
</button>

<button onclick="toggleMeritList()" class="neon-button btn-toggle" id="toggleBtn">
    <i class="fas fa-eye-slash" style="color: #e74c3c;"></i> Hide Merit List
</button>

<button onclick="printMeritList()" id="printBtn" class="neon-button btn-print" style="display:none;">
    <i class="fas fa-print" style="color: #2ecc71;"></i> Print
</button>

 <button onclick="hideGeneratedReports()" class="neon-button btn-red circle-button">
    <i class="fas fa-arrow-left" style="color: #c0392b;"></i> Back
  </button>

<!-- Merit List Selection -->
<label for="gradeSelect" style="font-size: 14px; font-weight: bold; color: #4CAF50;">
    <i class="fas fa-list-ol"></i> <strong>Merit List Here:</strong>
</label>

<select id="gradeSelect" style="
    padding: 5px;
    font-size: 12px;
    border: 2px solid #4CAF50;
    border-radius: 5px;
    background-color: #e8f5e9;
    color: #333;
    margin-right: 2px;">
    <option value="">--Select Grade--</option>
    <option value="7">Grade 7</option>
    <option value="7A">Grade 7A</option>
    <option value="7B">Grade 7B</option>
    <option value="7C">Grade 7C</option>
    <option value="8">Grade 8</option>
    <option value="8A">Grade 8A</option>
    <option value="8B">Grade 8B</option>
    <option value="8C">Grade 8C</option>
    <option value="9">Grade 9</option>
    <option value="9A">Grade 9A</option>
    <option value="9B">Grade 9B</option>
    <option value="9C">Grade 9C</option>
</select>
<div id="meritListContainer" style="display:none; margin-top:20px;"></div>

</div>
</div>

 <!-- Dropdown for selecting print options --> 
<div style="margin-top: 10px;">
    <label for="printOption">Select What to Print:</label>
    <select id="printOption">
        <option value="assessmentReport">Assessment Report</option>
        <option value="subjectChampions">Subject Champions</option>
        <option value="subjectRanking">Subject Ranking</option>
        <option value="subjectPerformance">Subject Performance</option>
        <option value="genderPerformance">Gender Performance</option> <!-- New option for Gender Performance -->
    </select>
</div>             
        </select>
        <button onclick="printSelectedOption()">Print</button>
    </div>

</div>
<!-- Parent Registration Section -->
<div id="parentRegistrationSection" style="display: none;">
    <h2 style="color: #1e88e5; font-family: 'Arial', sans-serif; text-align: center;">Register Parent</h2>
<form id="parentForm" style="width: 350px; margin: auto; padding: 20px; border: 2px solid #2196F3; border-radius: 10px; background: linear-gradient(135deg, #e3f2fd, #f1f8e9); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">
    <label for="parentName" style="display: block; margin-bottom: 5px; color: #0d47a1;">Parent Name:</label>
    <input type="text" id="parentsName" placeholder="Enter Parent Name" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #2196F3; border-radius: 5px; box-sizing: border-box;">
    
    <label for="parentPhone" style="display: block; margin-bottom: 5px; color: #0d47a1;">Phone Number:</label>
    <input type="text" id="parentPhone" placeholder="Enter Phone Number" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #2196F3; border-radius: 5px; box-sizing: border-box;">
    
    <label for="parentGrade" style="display: block; margin-bottom: 5px; color: #0d47a1;">Grade:</label>
    <select id="parentGrade" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #2196F3; border-radius: 5px; box-sizing: border-box;">

            <!-- Corrected Grades Dropdown -->
            <option value="1">Grade 1</option>
            <option value="2">Grade 2</option>
            <option value="3">Grade 3</option>
            <option value="4">Grade 4</option>
            <option value="5">Grade 5</option>
            <option value="6">Grade 6</option>
            <option value="7">Grade 7</option>
            <option value="8">Grade 8</option>
            <option value="9">Grade 9</option>
            <option value="10">Grade 10</option>
            <option value="11">Grade 11</option>
            <option value="12">Grade 12</option>
        </select><br>
        <button type="submit">Register Parent</button>
    </form>
</div>
<!-- Display Registered Parents -->
<div id="registeredParentsSection" style="display: none;">
    <h2>Registered Parents</h2>
    <label for="printGrade">Select Grade to Print:</label>
    <select id="printGrade">
 <option value="" disabled selected>Select Grade</option>
            <!-- Corrected Grades Dropdown -->
            <option value="1">Grade 1</option>
            <option value="2">Grade 2</option>
            <option value="3">Grade 3</option>
            <option value="4">Grade 4</option>
            <option value="5">Grade 5</option>
            <option value="6">Grade 6</option>
            <option value="7">Grade 7</option>
            <option value="8">Grade 8</option>
            <option value="9">Grade 9</option>
            <option value="10">Grade 10</option>
            <option value="11">Grade 11</option>
            <option value="12">Grade 12</option>
        </select><br>
  <div id="registeredParentsSection">
    <h2>Registered Parents</h2>
    <button onclick="printParentsTable()">Print Parent List</button>
    <table id="parentTable" class="learners-table">
        <thead>
            <tr>
                <th>No.</th>
                <th>Parent Name</th>
                <th>Phone Number</th>
                <th>Grade</th>
                <th>Actions</th> <!-- Column for delete button -->
            </tr>
        </thead>
        <tbody id="parentTableBody">
        </tbody>
    </table>
</div>
 </table>
</div>
<div id="championsForm" style="display: none; text-align: center; margin: auto; margin-top: 30px; width: 300px; padding: 20px; border: 2px solid #0288d1; border-radius: 10px; background: linear-gradient(135deg, #e0f7fa, #e3f2fd); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">
    <h2 style="color: #0277bd; font-family: 'Arial', sans-serif;">School Details Form</h2>
    <form id="championsDetailsForm">
        <label for="schoolName" style="display: block; margin-bottom: 5px; color: #01579b;">School:</label>
        <input type="text" id="schoolName" placeholder="Enter School Name" style="width: 90%; padding: 8px; margin-bottom: 15px; border: 1px solid #03a9f4; border-radius: 5px; box-sizing: border-box;">
        
        <label for="gradeLevel" style="display: block; margin-bottom: 5px; color: #01579b;">Grade:</label>
        <input type="text" id="gradeLevel" placeholder="Enter Grade" style="width: 90%; padding: 8px; margin-bottom: 15px; border: 1px solid #03a9f4; border-radius: 5px; box-sizing: border-box;">
        
        <label for="year" style="display: block; margin-bottom: 5px; color: #01579b;">Year:</label>
        <input type="text" id="year" placeholder="Enter Year" style="width: 90%; padding: 8px; margin-bottom: 15px; border: 1px solid #03a9f4; border-radius: 5px; box-sizing: border-box;">
        
        <label for="term" style="display: block; margin-bottom: 5px; color: #01579b;">Term:</label>
        <input type="text" id="term" placeholder="Enter Term" style="width: 90%; padding: 8px; margin-bottom: 15px; border: 1px solid #03a9f4; border-radius: 5px; box-sizing: border-box;">
        
            </form>
</div>
<!-- Staff Registration Section --> 
<div id="staffRegistrationSection" style="display: none; padding: 20px; background-color: #f4f4f9; border-radius: 8px; max-width: 400px; margin: 20px auto;">
    <h2 style="text-align: center; color: #333;">Register Staff</h2>
    <form id="staffForm" style="display: flex; flex-direction: column; gap: 15px;">
        <label for="staffName" style="font-size: 16px;">Staff Name:</label>
        <input type="text" id="staffName" required style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px;">

        <label for="staffPhone" style="font-size: 16px;">Phone Number:</label>
        <input type="text" id="staffPhone" required style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px;">

        <label for="staffPosition" style="font-size: 16px;">Position:</label>
        <input type="text" id="staffPosition" required style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px;">

        <label for="staffGrade" style="font-size: 16px;">Grade Assigned:</label>
        <select id="staffGrade" required style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px;">
            <option value="" disabled selected>Select Grade</option>
            <option value="All">Grade All</option>
            <option value="1">Grade 1</option>
            <option value="2">Grade 2</option>
            <option value="3">Grade 3</option>
            <option value="4">Grade 4</option>
            <option value="5">Grade 5</option>
            <option value="6">Grade 6</option>
            <option value="7">Grade 7</option>
            <option value="8">Grade 8</option>
            <option value="9">Grade 9</option>
            <option value="10">Grade 10</option>
            <option value="11">Grade 11</option>
            <option value="12">Grade 12</option>
        </select>
        
        <button type="submit" style="background-color: #4CAF50; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s;">
            Register Staff
        </button>
    </form>
</div>

<!-- Display Registered Staff -->
<div id="registeredStaffSection" style="display: none;">

    <h2>Registered Staff</h2>
    <button onclick="printStaffTable()">Print Staff List</button>
    <table id="staffTable" class="learners-table">
        <thead>
            <tr>
                <th>No.</th>
                <th>Staff Name</th>
                <th>Phone Number</th>
                <th>Position</th>
                <th>Grade Assigned</th>
            </tr>
        </thead>
        <tbody id="staffTableBody">
            <!-- Dynamically filled with JavaScript -->
        </tbody>
    </table>
</div>
<!-- Register Support Staff Section -->
<div id="supportStaffRegistrationSection" style="display: none;">
<div class="support-staff-section">
        <h1>Register Support Staff</h1>
        <div class="form-container">
            <form id="supportStaffForm">
                <input type="text" id="supportStaffId" placeholder="Staff ID" required>
                <input type="text" id="supportStaffName" placeholder="Name" required>
                <input type="text" id="supportStaffPhone" placeholder="Phone" required>
                <input type="text" id="supportStaffPosition" placeholder="Position" required>
                <input type="date" id="supportStaffHireDate" required>
                <input type="file" id="supportStaffPhoto" required>
                <button type="button" onclick="registerSupportStaff()">Register</button>
            </form>
        </div>

        <button onclick="viewRegisteredStaff()">View Registered Support Staff</button>
<button class="circle-button" onclick="printSupportStaffTable()">Print</button>


        <div class="table-container">
            <table id="supportStaffTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Staff ID</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Position</th>
                        <th>Hire Date</th>
                        <th>Photo</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="supportStaffTableBody"></tbody>
            </table>
        </div>

        <div id="generatedIdCardContainer"></div>

    </div>

    <!-- Container for Generated ID Card -->
    <div id="generatedIdCardContainer"></div>
 </div>
    <!-- Bulk Report Generation Section -->
    <div id="bulkReportGeneration" class="hidden-section">
        <h2>Bulk Report Generation</h2>
        <label for="bulkGradeSelect">Select Grade:</label>
        <select id="bulkGradeSelect"></select>
        <button onclick="generateBulkReports()">Generate Bulk Reports</button>
    </div>

    <!-- Generated Report Section -->
    <div id="report"></div>
 </div>
<div id="photoAlbumSection" style="display: none;">
 <h2 style="color: #4CAF50; background-color: #f0f8ff; padding: 5px 10px; border-radius: 5px; display: inline-block;">
    Photo Album</h2>
    <input type="file" id="photoInput" multiple accept="image/*" style="margin-bottom: 10px;">
   <button id="viewPhotosButton" class="btn-view-photos">
    <span class="material-icons">photo_camera</span> View Photos Now
</button>

<button id="clearPhotosButton" class="btn-clear-photos">
    <span class="material-icons">delete</span> Clear Photos
</button>

    <div id="photoGallery" style="display: none; flex-wrap: wrap; gap: 10px; justify-content: center;"></div>
</div>


<!-- Modal Overlay -->
<div id="modalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div id="learnerDetailsModal" style="background-color: white; padding: 20px; border-radius: 10px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">
        <!-- Learner details will be injected here -->
    </div>
</div>

<div id="alertContainer" style="position: fixed; top: 10%; left: 50%; transform: translateX(-50%); z-index: 1000; width: 90%; max-width: 400px;"></div>

<div id="savedTablesContainer"></div>
</div> 
</div>

<!-- Table Section -->
<div id="resultsSection" style="display: none; margin: 20px;">
    <h3>Career Pathways Results</h3>

    <!-- Print Report Button -->
    <button onclick="printPathwayReport()" style="padding: 8px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
        <i class="fas fa-print"></i> Print Career Pathway Report
    </button>

    <!-- Save Report Button -->
    <button onclick="saveReport()" style="padding: 8px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
        <i class="fas fa-save"></i> Save Report
    </button>

    <!-- View Saved Reports Button -->
    <button onclick="viewSavedReports()" style="padding: 8px 12px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer;">
        <i class="fas fa-folder-open"></i> View Saved Reports
    </button>

    <!-- Select Grade for Full Report -->
    <select id="selectFullReportGrade">
        <option value="">Select Grade</option>
        <option value="7">Grade 7</option>
        <option value="8">Grade 8</option>
        <option value="9">Grade 9</option>
    </select>

    <!-- View Full Career Report Button -->
    <button onclick="viewFullYearReport()" style="padding: 8px 12px; background: #673AB7; color: white; border: none; border-radius: 4px; cursor: pointer;">
        <i class="fas fa-chart-line"></i> View Full Report (Exam 1 - 6)
    </button>

    <table id="pathwaysResultsTable" class="report-table">
        <thead>
            <tr>
                <th rowspan="2">Learner</th>
                <th rowspan="2">Grade</th>
                <th colspan="6">STEM Subjects</th>
                <th colspan="4">Social Sciences Subjects</th>
                <th colspan="3">Sports, Arts & Science Subjects</th>
                <th rowspan="2">STEM Average</th>
                <th rowspan="2">Social Sciences Average</th>
                <th rowspan="2">Sports, Arts & Science Average</th>
                <th rowspan="2">Best Pathway</th>
            </tr>
            <tr>
                <!-- STEM Subjects -->
                <th>ENG</th>
                <th>MATHS</th>
                <th>PRE-TECH</th>
                <th>KISWA</th>
                <th>I Scie</th>
                <th>AGRIC</th>
                <!-- Social Sciences Subjects -->
                <th>Kiswa</th>
                <th>ENG</th>
                <th>SST</th>
                <th>CRE</th>
                <!-- Sports, Arts & Science Subjects -->
                <th>KISWA</th>
                <th>ENG</th>
                <th>C/A</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Saved Reports Section -->
    <div id="savedReportsSection" style="display: none; margin-top: 20px;">
        <h3>Saved Reports</h3>
        <table id="savedReportsTable" class="report-table">
            <thead></thead>
            <tbody></tbody>
<button id="printButton" onclick="printReport()" style="display:none;">Print Report</button>
<select id="selectGrade">
    <option value="">-- Select Grade --</option>
    <option value="7">Grade 7</option>
    <option value="8">Grade 8</option>
    <option value="9">Grade 9</option>
</select>
<button onclick="viewSavedReports()">View Report</button>
<button id="printButton" onclick="printReport()" style="display:none;">Print Report</button>

        </table>
    </div>

    <!-- Full Career Pathway Report -->
    <div id="fullReportSection" style="display: none; margin-top: 20px;">
        <h3>Full Career Pathway Report (Exam 1 - 6)</h3>
        <table id="fullReportTable" class="report-table">
            <thead>
                <tr>
<button id="printButton" onclick="printReport()" style="display:none;">Print Report</button>

                    <th>No.</th>
                    <th>Learner Name</th>
                    <th>Grade</th>
                    <th>Exam 1</th>
                    <th>Exam 2</th>
                    <th>Exam 3</th>
                    <th>Exam 4</th>
                    <th>Exam 5</th>
                    <th>Exam 6</th>
                    <th>Best Career Pathway</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<!-- Learner Count Display Section -->
<div id="learnerCountContainer" style="display: none; margin-top: 20px; font-weight: bold; text-align: center;">
    <table style="width: 100%; margin: auto; border-collapse: collapse; border: 1px solid black;">
        <thead>
            <tr style="background-color: #f2f2f2;">
                <th style="font-size: 20px;">No.</th>
                <th style="font-size: 20px;">Grade</th>
                <th style="font-size: 20px;">Boys</th>
                <th style="font-size: 20px;">Girls</th>
                <th style="font-size: 20px;">Total</th>
            </tr>
        </thead>
        <tbody id="learnerCountTableBody"></tbody>
    </table>
</div>

    <!-- Footer Section -->
    <footer id="footer" style="display: none; background-color: #2196F3; color: white; padding: 5px 0; text-align: center;">
        <p>&copy; 2025 NACHU COMPREHENSIVE SCHOOL | All Rights Reserved</p>
    </footer>
</body>
   
<script>
    // ... (Other existing JavaScript code)
   // Function to update the grade field based on the selected learner
    learnerSelect.addEventListener('change', function() {
        const selectedLearnerName = this.value;
        const selectedLearner = learners.find(learner => learner.name === selectedLearnerName);
        if (selectedLearner) {
            document.getElementById('marksGrade').value = selectedLearner.grade; // Set the grade field based on the selected learner
        } else {
            document.getElementById('marksGrade').value = ''; // Clear the grade field if no learner is selected
        }
    });
</script>

 <!-- Save Marks Button and Success Message -->
<div id="saveSuccessMessage" style="display: none; color: red; font-weight: bold; 
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);">
    Thank you Sir/Madam, marks saved successfully!
</div>
 <script>
    const learnersList = document.getElementById("learnersList");
    const marksList = document.getElementById("marksList");
    const learnerSelect = document.getElementById("learnerSelect");
    const bulkGradeSelect = document.getElementById("bulkGradeSelect");
    const groupedLearners = document.getElementById("groupedLearners");
    let learners = []; // Array to store learners locally

    // Open IndexedDB database
    const request = indexedDB.open("LearnersDB", 1);

    request.onerror = function(event) {
        console.error("Error opening IndexedDB:", event.target.error);
    };

    request.onsuccess = function(event) {
        const db = event.target.result;
        const transaction = db.transaction(["learners"], "readonly");
        const objectStore = transaction.objectStore("learners");
        const getAllRequest = objectStore.getAll();

        getAllRequest.onsuccess = function() {
            learners = getAllRequest.result; // Retrieve learners from IndexedDB
            updateLearnersTable();
            updateLearnerSelect();
            updateBulkGradeSelect();
            populateLearnerSuggestions();
        };

        getAllRequest.onerror = function(event) {
            console.error("Error retrieving learners:", event.target.error);
        };
    };

    // Initialize IndexedDB if it doesn't exist
    request.onupgradeneeded = function(event) {
        const db = event.target.result;
        const objectStore = db.createObjectStore("learners", { keyPath: "admissionNumber" });
        objectStore.createIndex("admissionNumber", "admissionNumber", { unique: true });
    };

    document.getElementById("learnerForm").addEventListener("submit", function (e) {
        e.preventDefault();

        // Capture learner details
        const photoFile = document.getElementById("learnerPhoto").files[0];
        const learner = {
        name: document.getElementById("learnerName").value,
        gender: document.getElementById("learnerGender").value,
        grade: document.getElementById("learnerGrade").value,
        age: document.getElementById("learnerAge").value,
        parentName: document.getElementById("parentName").value,
        phone: document.getElementById("learnerPhone").value,
        birthCertificateNo: document.getElementById("birthCertificate").value,
        admissionNumber: document.getElementById("admissionNumber").value,
        photo: null, // Placeholder for the photo
    };


        // Check for duplicate admission number
        if (isDuplicateLearner(learner)) {
            alert("Learner with this admission number already exists.");
            return;
        }

        // If a photo is uploaded, convert it to Base64
        if (photoFile) {
            const reader = new FileReader();
            reader.onload = function(event) {
                learner.photo = event.target.result; // Store the Base64 string of the photo

                // Open IndexedDB to store the new learner
                const request = indexedDB.open("LearnersDB", 1);
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    const transaction = db.transaction(["learners"], "readwrite");
                    const objectStore = transaction.objectStore("learners");

                    // Add the new learner to the IndexedDB
                    const addRequest = objectStore.add(learner);

                    addRequest.onsuccess = function() {
                        learners.push(learner); // Add learner to the local array
                        updateLearnersTable();
                        updateLearnerSelect();
                        document.getElementById("learnerForm").reset();

                        // Display success message
                        const successMessage = document.createElement("div");
                        successMessage.textContent = "Learner registered successfully!";
                        successMessage.style.color = "green";
                        successMessage.style.fontWeight = "bold";
                        successMessage.style.marginTop = "10px";

                        const formContainer = document.getElementById("registerLearnerSection");
                        formContainer.appendChild(successMessage);
                        setTimeout(() => successMessage.remove(), 3000);
                    };

                    addRequest.onerror = function(event) {
                        console.error("Error adding learner:", event.target.error);
                    };
                };

                request.onerror = function(event) {
                    console.error("Error opening IndexedDB:", event.target.error);
                };
            };
            reader.readAsDataURL(photoFile); // Convert photo to Base64
        } else {
            // If no photo, proceed with learner registration
            const request = indexedDB.open("LearnersDB", 1);

            request.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction(["learners"], "readwrite");
                const objectStore = transaction.objectStore("learners");

                // Add the new learner to the IndexedDB without photo
                const addRequest = objectStore.add(learner);

                addRequest.onsuccess = function() {
                    learners.push(learner); // Add learner to the local array
                    updateLearnersTable();
                    updateLearnerSelect();
                    document.getElementById("learnerForm").reset();

                    // Display success message
                    const successMessage = document.createElement("div");
                    successMessage.textContent = "Learner registered successfully!";
                    successMessage.style.color = "green";
                    successMessage.style.fontWeight = "bold";
                    successMessage.style.marginTop = "10px";

                    const formContainer = document.getElementById("registerLearnerSection");
                    formContainer.appendChild(successMessage);
                    setTimeout(() => successMessage.remove(), 3000);
                };

                addRequest.onerror = function(event) {
                    console.error("Error adding learner:", event.target.error);
                };
            };

            request.onerror = function(event) {
                console.error("Error opening IndexedDB:", event.target.error);
            };
        }
    });

    // Helper function to check for duplicates
    function isDuplicateLearner(learner) {
        return learners.some(l => l.admissionNumber === learner.admissionNumber);
    }

   // Function to update the learners table
function updateLearnersTable() {
    learnersList.innerHTML = ""; // Clear the current list
    learners.forEach((learner, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${index + 1}</td> <!-- Serial Number -->
            <td>${learner.name}</td>
            <td>${learner.gender}</td>
            <td>${learner.grade}</td>
            <td>${learner.age}</td>
            <td>${learner.parentName}</td>
            <td>${learner.phone}</td>
            <td>${learner.birthCertificateNo}</td>
            <td>${learner.admissionNumber}</td>
            <td><img src="${learner.photo}" alt="photo" style="width: 50px; height: 50px;" /></td>
        `;
        learnersList.appendChild(row);
    });
}
    // Function to update learner select options
    function updateLearnerSelect() {
        learnerSelect.innerHTML = "";
        learners.forEach(learner => {
            const option = document.createElement("option");
            option.value = learner.admissionNumber;
            option.textContent = learner.name;
            learnerSelect.appendChild(option);
        });
    }

    // Function to update bulk grade select options
    function updateBulkGradeSelect() {
        bulkGradeSelect.innerHTML = "";
        const grades = [...new Set(learners.map(learner => learner.grade))];
        grades.forEach(grade => {
            const option = document.createElement("option");
            option.value = grade;
            option.textContent = grade;
            bulkGradeSelect.appendChild(option);
        });
    }

    // Function to populate learner suggestions (if needed)
    function populateLearnerSuggestions() {
        // Implement any suggestions logic if required
    }

          
          // Hardcoded credentials (for demonstration purposes)
        const validUsername = "Nachu254";
        const validPassword = "Nm643PpQ@";

        // Login form submission
        document.getElementById("loginForm").addEventListener("submit", function (e) {
            e.preventDefault(); // Prevent form from refreshing the page

            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            if (username === validUsername && password === validPassword) {
                // Hide login section and show main content
                document.getElementById("loginSection").style.display = "none";
                document.getElementById("mainContent").style.display = "block";
            } else {
                // Show error message
                document.getElementById("loginError").style.display = "block";
            }
     });
        document.getElementById("marksForm").addEventListener("submit", function (e) {
    e.preventDefault();

    // Capture selected learner and scores
    const selectedLearner = learnerSelect.value;
    const scores = [
        parseInt(document.getElementById("english").value),
        parseInt(document.getElementById("math").value),
        parseInt(document.getElementById("preTech").value),
        parseInt(document.getElementById("kiswahili").value),
        parseInt(document.getElementById("science").value),
        parseInt(document.getElementById("social").value),
        parseInt(document.getElementById("agriculture").value),
        parseInt(document.getElementById("religion").value),
        parseInt(document.getElementById("art").value)
    ];

    // Validate scores
    if (scores.some(score => score < 0 || score > 100)) {
        showAlert("Please enter scores between 0 and 100.");
        return;
    }

    // Retrieve "champions form" details
    const schoolName = document.getElementById("schoolName").value || "N/A";
    const gradeLevel = document.getElementById("gradeLevel").value || "N/A";
    const year = document.getElementById("year").value || "N/A";
    const term = document.getElementById("term").value || "N/A";

    // Add header information to the marks table
    const marksHeader = document.getElementById("marksHeader");
    marksHeader.innerHTML = `
        <h3>Marks Table</h3>
        <p><strong>School:</strong> ${schoolName}</p>
        <p><strong>Grade:</strong> ${gradeLevel}</p>
        <p><strong>Year:</strong> ${year}</p>
        <p><strong>Term:</strong> ${term}</p>
    `;

    // Calculate total marks
    const totalMarks = scores.reduce((acc, score) => acc + score, 0);
    const grade = learners.find(l => l.name === selectedLearner).grade;

    // Create a new marks entry
    const marksEntry = { learner: selectedLearner, grade, scores, totalMarks };

    // Add marks to the marks array
    marks.push(marksEntry);

    // Save updated marks to localStorage
    saveMarksToStorage();

    // Update the marks table
    updateMarksTable();

    // Reset the form
    this.reset();
});

// Function to save marks to localStorage
function saveMarksToStorage() {
    const data = getStorageData();
    data.marks = marks;
    updateStorage(data);
}

// Function to show alerts
function showAlert(message) {
    alert(message); // Simple alert for demonstration
}

function updateLearnersTable() { 
    learnersList.innerHTML = learners.map((learner, index) => `
        <tr>
            <td>${index + 1}</td> <!-- Serial Number -->
            <td><img src="${learner.photo}" alt="Photo" width="50" height="50"></td>
            <td contenteditable="true">${learner.name}</td>
            <td contenteditable="true">${learner.gender}</td>
            <td contenteditable="true">${learner.grade}</td>
            <td contenteditable="true">${learner.age}</td>
            <td contenteditable="true">${learner.parentName}</td>
            <td contenteditable="true">${learner.phone}</td>
            <td contenteditable="true">${learner.birthCertificateNo}</td>
            <td contenteditable="true">${learner.admissionNumber}</td>
            <td><button onclick="removeLearner(${index})">Remove</button></td>
            <td><button onclick="saveLearners()">Save Changes</button></td>
        </tr>
    `).join("");

    updateLearnerSelect();      // Existing dropdown or UI update
    populateGradeDropdown();    // ? Dynamically fill the grade <select> based on learners
}

function toggleChampionsForm() {
    const form = document.getElementById("championsForm");
    form.style.display = form.style.display === "none" ? "block" : "none";
}
function sendToArchives() {
    showLoadingSpinner(); // Show spinner

    setTimeout(() => {
        let archivedMarks;
        
        // Retrieve existing archived marks safely
        try {
            archivedMarks = JSON.parse(localStorage.getItem("archivedMarks")) || [];
        } catch (e) {
            console.error("Error parsing archived marks:", e);
            archivedMarks = [];
        }

        // Ensure marks exist before archiving
        console.log("Marks before archiving:", marks);
        if (!marks || marks.length === 0) {
            alert("No marks available to archive!");
            hideLoadingSpinner();
            return;
        }

        // Archive the marks
        archivedMarks.push(...marks);
        localStorage.setItem("archivedMarks", JSON.stringify(archivedMarks));

        // Debugging: Verify saved data
        console.log("Archived Marks after archiving:", JSON.parse(localStorage.getItem("archivedMarks")));

        // Show success message
        const successMessage = document.getElementById("saveSuccessMessage");
        successMessage.textContent = "Marks successfully archived!";
        successMessage.style.display = "block";

        setTimeout(() => {
            successMessage.style.display = "none";
            hideLoadingSpinner(); // Hide spinner after saving
        }, 3000);

        updateArchivedMarksTable(); // Refresh archived marks display
    }, 2000); // Simulated delay for saving process
}
function updateArchivedMarksTable() {
    let archivedMarks = JSON.parse(localStorage.getItem("archivedMarks")) || [];
    const archivedMarksList = document.getElementById("archivedMarksList");

    if (!archivedMarksList) {
        console.error("Archived marks list container not found!");
        return;
    }

    archivedMarksList.innerHTML = archivedMarks.length === 0 
        ? "<tr><td colspan='10'>No archived marks available.</td></tr>"
        : archivedMarks.map((entry, index) => `
            <tr>
                <td>${index + 1}</td>
                <td>${entry.learner}</td>
                <td>${entry.grade}</td>
                ${Object.values(entry.scores).map(score => `<td>${score}</td>`).join("")}
                <td>${entry.totalMarks}</td>
            </tr>
        `).join("");

    console.log("Archived marks table updated!");
}


function startFireworks() {
    const fireworksOverlay = document.getElementById('fireworks-overlay');
    fireworksOverlay.style.display = 'block';

    // Function to create a firework
    function createFirework() {
        const firework = document.createElement('div');
        firework.className = 'firework';
        const size = Math.random() * 10 + 10;
        firework.style.width = `${size}px`;
        firework.style.height = `${size}px`;
        firework.style.left = `${Math.random() * 100}vw`;
        firework.style.top = `${Math.random() * 100}vh`;
        firework.style.animationDuration = `${Math.random() * 1 + 0.5}s`;
        fireworksOverlay.appendChild(firework);

        // Remove the firework after animation ends
        setTimeout(() => {
            firework.remove();
        }, 1000);
    }

    // Generate fireworks every 200ms
    const interval = setInterval(createFirework, 200);

    // Stop fireworks after 30 seconds
    setTimeout(() => {
        clearInterval(interval);
        fireworksOverlay.style.display = 'none';
        fireworksOverlay.innerHTML = ''; // Clear all fireworks
    }, 30000); // 30 seconds
}
function saveTableWithHeaders(grade, tableData) {
    const headers = {
        schoolName: document.getElementById("schoolName").value || "N/A",
        gradeLevel: grade || "N/A",
        year: document.getElementById("year").value || "N/A",
        term: document.getElementById("term").value || "N/A",
    };

    // Retrieve existing data from local storage
    let savedTables = JSON.parse(localStorage.getItem("savedTables")) || [];

    // Save the new table with its headers
    savedTables.push({
        headers: headers,
        data: tableData,
    });

    localStorage.setItem("savedTables", JSON.stringify(savedTables));
    alert("Table saved with unique headers!");
}
function loadTablesWithHeaders() {
    let savedTables = JSON.parse(localStorage.getItem("savedTables")) || [];
    const archivedMarksList = document.getElementById("archivedMarksList");
    archivedMarksList.innerHTML = ""; // Clear current display

    savedTables.forEach((table, index) => {
        const headers = table.headers;

        // Create a header section for this table
        const headerHtml = `
            <div>
                <h3>School: ${headers.schoolName}</h3>
                <h3>Grade: ${headers.gradeLevel}</h3>
                <h3>Year: ${headers.year}</h3>
                <h3>Term: ${headers.term}</h3>
            </div>
        `;

        // Create a table section
        const tableHtml = generateTableHtml(table.data); // Assume `generateTableHtml` generates table rows
        archivedMarksList.innerHTML += `
            ${headerHtml}
            <table class="report-table">
                ${tableHtml}
            </table>
            <button onclick="printTable(${index})">Print This Table</button>
            <hr>
        `;
    });
}

function combineMeritListsByGrade() {
    // Retrieve archived marks from localStorage
    const archivedMarks = JSON.parse(localStorage.getItem("archivedMarks")) || [];
    const storedLearners = JSON.parse(localStorage.getItem("learners")) || [];

    // Get all unique grades
    const uniqueGrades = [...new Set(archivedMarks.map(mark => mark.grade.match(/^\d+/)[0]))];

    let allCombinedHtml = '';

    uniqueGrades.forEach(gradeNumber => {
        // Filter learners for the current grade (e.g., Grade 7 includes 7A, 7B)
        const gradeMarks = archivedMarks.filter(mark => mark.grade.startsWith(gradeNumber));

        if (gradeMarks.length > 0) {
            // Combine all learners for the grade
            const combinedMeritList = [...gradeMarks];

            // Sort the combined list by total marks in descending order
            combinedMeritList.sort((a, b) => b.totalMarks - a.totalMarks);

            // Create the HTML for the combined merit list
            let combinedHtml = `
                <h3>Combined Merit List for Grade ${gradeNumber}</h3>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>Name</th>
                            <th>Grade</th>
                            <th>Eng</th><th>Lev</th>
                            <th>Math</th><th>Lev</th>
                            <th>Pre-Tech</th><th>Lev</th>
                            <th>Kiswahili</th><th>Lev</th>
                            <th>Science</th><th>Lev</th>
                            <th>Social</th><th>Lev</th>
                            <th>Agriculture</th><th>Lev</th>
                            <th>CRE</th><th>Lev</th>
                            <th>Creative Art</th><th>Lev</th>
                            <th>Total Marks</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            combinedMeritList.forEach((learnerData, index) => {
                // Get learner information
                const learnerInfo = storedLearners.find(l => l.admissionNumber === learnerData.admissionNumber);
                const learnerName = learnerInfo?.name || learnerData.learner || "Name Missing";
                const learnerGrade = learnerInfo?.grade || learnerData.grade || "Grade N/A";
                const scores = learnerData.scores || [];
                const totalMarks = learnerData.totalMarks || 0;

                // Add learner's data to the table
                combinedHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${learnerName}</td>
                        <td>${learnerGrade}</td>
                        ${scores.map(score => {
                            const numericScore = Number(score) || 0;
                            return `<td>${numericScore}</td><td>${getLevel(numericScore)}</td>`;
                        }).join('')}
                        <td style="font-weight: bold;">${totalMarks}</td>
                    </tr>
                `;
            });

            // Calculate subject totals and averages for the current grade
            const subjectTotals = Array(9).fill(0);
            let totalMarksSum = 0;
            combinedMeritList.forEach(learner => {
                learner.scores.forEach((score, index) => {
                    subjectTotals[index] += Number(score) || 0;
                });
                totalMarksSum += learner.totalMarks || 0;
            });

            const averages = subjectTotals.map(total => (total / combinedMeritList.length).toFixed(2));
            const overallAverage = (totalMarksSum / combinedMeritList.length).toFixed(2);

            // Add totals and averages rows
            combinedHtml += `
                <tr>
                    <td colspan="3" style="font-weight: bold;">Total</td>
                    ${subjectTotals.map(total => `<td style="font-weight: bold;">${total}</td><td></td>`).join('')}
                    <td style="font-weight: bold;">${totalMarksSum}</td>
                </tr>
                <tr>
                    <td colspan="3" style="font-weight: bold;">Average</td>
                    ${averages.map(avg => `<td style="font-weight: bold;">${avg}</td><td></td>`).join('')}
                    <td style="font-weight: bold;">${overallAverage}</td>
                </tr>
            `;

            combinedHtml += "</tbody></table>";
            allCombinedHtml += combinedHtml;
        }
    });

    // Display all combined merit lists for all grades
    document.getElementById("combinedMeritLists").innerHTML = allCombinedHtml;

    // Optionally, save the combined merit lists
    localStorage.setItem("combinedMeritLists", JSON.stringify(allCombinedHtml));
}
function logout() {
    // Hide main content and footer
    document.getElementById("mainContent").style.display = "none";
    document.getElementById("footer").style.display = "none";
    
    // Show login section
    document.getElementById("loginSection").style.display = "block";


    // Clear any session or user data if necessary
    // For example, if you're storing user info in localStorage, you can clear it:
    localStorage.removeItem("userData"); // Remove stored user data (if any)

    // Optionally, reset login form for next use
    document.getElementById("loginForm").reset();
}
function groupLearnersByGender() {
    const groupedByGender = learners.reduce((groups, learner) => {
        if (!groups[learner.gender]) {
            groups[learner.gender] = [];
        }
        groups[learner.gender].push(learner);
        return groups;
    }, {});

    let genderHtml = '';
    for (const gender in groupedByGender) {
        genderHtml += `
            <h3>${gender}</h3>
            <table class="learners-table">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Photo</th>
                         <th>Name</th>
                        <th>Gender</th>
                        <th>Grade</th>
                        <th>Age</th>
                       <th>Parent Name</th>
                        <th>Parent Phone No</th>
                        <th>Birth Certificate No</th>
                        <th>Admission Number</th>

                    </tr>
                </thead>
                <tbody>
                    ${groupedByGender[gender].map((learner, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td><img src="${learner.photo}" alt="Photo" width="50" height="50"></td>
                            <td>${learner.name}</td>
                            <td>${learner.gender}</td>
                            <td>${learner.grade}</td>
                            <td>${learner.age}</td>
                             <td>${learner.parentName}</td>
                            <td>${learner.phone}</td>
                           <td>${learner.birthCertificateNumber}</td>
                            <td>${learner.admissionNumber}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    document.getElementById('groupedByGender').innerHTML = genderHtml;
}
function printGroupedByGender() {
    const groupedContent = document.getElementById("groupedByGender").innerHTML;

    if (!groupedContent) {
        alert("No learners to print.");
        return;
    }

    // URL or base64 string of your logo
    const logoUrl = " https://i.imgur.com/UW65hfv.png"; // Replace with your logo's URL or base64 string

    const printWindow = window.open("", "_blank");
    printWindow.document.write(`
        <html>
            <head>
                <title>Grouped Learners by Gender</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                    }
                    h1 {
                        text-align: center;
                        margin-bottom: 20px;
                    }
                    .learners-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 20px;
                    }
                    .learners-table th, .learners-table td {
                        border: 1px solid black;
                        padding: 8px;
                        text-align: center;
                    }
                    .logo {
                        display: block;
                        margin: 0 auto;
                        width: 100px; /* Adjust logo size */
                        height: auto;
                    }
                </style>
            </head>
            <body>
                <img src="${logoUrl}" class="logo" alt="School Logo">
                <h1>Grouped Learners by Gender</h1>
                ${groupedContent}
            </body>
        </html>
    `);
    printWindow.document.close();  // Close the document to ensure it's fully loaded before printing
    printWindow.print();  // Print the document
}


// Function to print a specific table by grade 
function printArchivedTable(grade) {
    const tableHtml = document.getElementById(`archivedTable-${grade}`).outerHTML;

    // Retrieve information from the champions form fields
    const schoolName = document.getElementById("schoolName").value || "School Name";
    const gradeLevel = document.getElementById("gradeLevel").value || "Grade";
    const year = document.getElementById("year").value || "Year";
    const term = document.getElementById("term").value || "Term";

    // URL or base64 string of your logo
    const logoUrl = " https://i.imgur.com/UW65hfv.png"; // Replace with your logo's URL or base64 string

    const printWindow = window.open("", "_blank");
    printWindow.document.write(`
        <html>
            <head>
                <title>Archived Marks for Grade ${grade}</title>
                <style>
                    body { font-family: Arial, sans-serif; }
                    .report-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 20px 0;
                    }
                    .report-table th, .report-table td {
                        border: 2px solid black;
                        padding: 8px;
                        text-align: center;
                    }
                    .logo {
                        display: block;
                        margin: 0 auto;
                        width: 100px; /* Adjust logo size */
                        height: auto;
                    }
                </style>
            </head>
            <body>
                <img src="${logoUrl}" class="logo" alt="School Logo">
                <p>School: ${schoolName}</p>
                <p>Grade: ${gradeLevel}</p>
                <p>Year: ${year}</p>
                <p>Term: ${term}</p>
                ${tableHtml}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}
function saveLearners() { 
    const rows = learnersList.getElementsByTagName('tr');
    learners = Array.from(rows).map((row, index) => {
        const cells = row.getElementsByTagName('td');
        return {
            photo: cells[1].querySelector('img').src, // Retrieve photo source
            name: cells[2].textContent,
            gender: cells[3].textContent,
            grade: cells[4].textContent,
            age: cells[5].textContent,
            parentName: cells[6].textContent,
            phone: cells[7].textContent,
            birthCertificateNo: cells[8].textContent,
            admissionNumber: cells[9].textContent
        };
    });

    // Save updated learners list to local storage
    localStorage.setItem('learners', JSON.stringify(learners));
    alert("Changes saved successfully!");
}
function groupLearnersByGrade() {
    const groupedLearners = learners.reduce((groups, learner) => {
        if (!groups[learner.grade]) {
            groups[learner.grade] = [];
        }
        groups[learner.grade].push(learner);
        return groups;
    }, {});

    let groupedHtml = '';
    for (const grade in groupedLearners) {
        groupedHtml += `
            <h3>Grade: ${grade}</h3>
            <button onclick="saveGroupedChanges('${grade}')"><i class="fas fa-save"></i> Save Changes</button>
            <button onclick="printGroupedTable('${grade}')"><i class="fas fa-print"></i> Print Table</button>

            <table class="learners-table" id="groupedTable-${grade}">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Photo</th>
                        <th>Name</th>
                        <th>Gender</th>
                        <th>Grade</th>
                        <th>Age</th>
                        <th>Parent Name</th>
                        <th>Parent Phone No</th>
                        <th>Birth Certificate No</th>
                        <th>Admission Number</th>
                    </tr>
                </thead>
                <tbody>
                    ${groupedLearners[grade].map((learner, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td><img src="${learner.photo}" alt="Photo" width="50" height="50"></td>
                            <td contenteditable="true">${learner.name}</td>
                            <td contenteditable="true">${learner.gender}</td>
                            <td contenteditable="true">${learner.grade}</td>
                            <td contenteditable="true">${learner.age}</td>
                            <td contenteditable="true">${learner.parentName}</td>
                            <td contenteditable="true">${learner.phone}</td>
                            <td contenteditable="true">${learner.birthCertificateNo}</td>
                            <td contenteditable="true">${learner.admissionNumber}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    document.getElementById('groupedLearners').innerHTML = groupedHtml;
}

// Predefined security data (for demonstration purposes)
const userCredentials = {
    username: "Nachu254",
    password: "Nm643PpQ@", // Current password
    securityAnswer: "blue" // Security question answer
};

// Show reset password form
function showResetPasswordForm() {
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("resetPasswordSection").style.display = "block";
}
// Login form submission
document.getElementById("loginForm").addEventListener("submit", function (e) {
    e.preventDefault(); // Prevent form from refreshing the page

    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    if (username === validUsername && password === validPassword) {
        // Hide login section and show main content
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("mainContent").style.display = "block";

        // Show footer after successful login
        document.getElementById("footer").style.display = "block";
    } else {
        // Show error message
        document.getElementById("loginError").style.display = "block";
    }
});

// Handle password reset
document.getElementById("resetPasswordForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const username = document.getElementById("resetUsername").value;
    const securityAnswer = document.getElementById("securityAnswer").value.toLowerCase();
    const newPassword = document.getElementById("newPassword").value;
    const confirmPassword = document.getElementById("confirmPassword").value;

    // Check username and security question answer
    if (username === userCredentials.username && securityAnswer === userCredentials.securityAnswer) {
        if (newPassword === confirmPassword) {
            // Update the password
            userCredentials.password = newPassword;

            // Show success message
            document.getElementById("resetSuccess").style.display = "block";
            document.getElementById("resetError").style.display = "none";

            // Reset form and navigate back to login
            setTimeout(() => {
                document.getElementById("resetPasswordForm").reset();
                showLoginForm();
            }, 2000);
        } else {
            // Passwords do not match
            document.getElementById("resetError").textContent = "Passwords do not match.";
            document.getElementById("resetError").style.display = "block";
        }
    } else {
        // Invalid username or security answer
        document.getElementById("resetError").textContent = "Invalid username or security answer.";
        document.getElementById("resetError").style.display = "block";
    }
});
function printGroupedTable(grade) {
    const table = document.getElementById(`groupedTable-${grade}`).outerHTML;

    // URL or base64 string of your logo
    const logoUrl = "https://i.imgur.com/UW65hfv.png"; // Replace with your logo's URL or base64 string

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Grouped Learners for Grade ${grade}</title>
                <style>
                    body { font-family: Arial, sans-serif; }
                    h1 {
                        text-align: center;
                        margin-bottom: 20px;
                    }
                    .learners-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    .learners-table th, .learners-table td {
                        border: 2px solid black; padding: 10px; text-align: center;
                    }
                    .logo {
                        display: block;
                        margin: 0 auto;
                        width: 100px; /* Adjust logo size */
                        height: auto;
                    }
                </style>
            </head>
            <body>
                <img src="${logoUrl}" class="logo" alt="School Logo">
                <h1>Grouped Learners for Grade ${grade}</h1>
                ${table}
            </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.print();
}

function printCombinedMeritList() {  
    const schoolName = document.getElementById('schoolName').value || "School Name Not Provided";
    const grade = document.getElementById('gradeLevel').value || "Grade Not Provided";
    const term = document.getElementById('term').value || "Term Not Provided";
    const year = document.getElementById('year').value || "Year Not Provided";

    const customPrompt = document.createElement('div');
    customPrompt.style.position = 'fixed';
    customPrompt.style.top = '50%';
    customPrompt.style.left = '50%';
    customPrompt.style.transform = 'translate(-50%, -50%)';
    customPrompt.style.backgroundColor = '#f8d7da';
    customPrompt.style.color = '#721c24';
    customPrompt.style.padding = '20px';
    customPrompt.style.borderRadius = '10px';
    customPrompt.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';
    customPrompt.style.zIndex = '9999';
    customPrompt.innerHTML = `
        <h3>Enter the grades to print (comma-separated, e.g., 7, 8):</h3>
        <input type="text" id="gradeInput" placeholder="Enter grades..." style="padding: 10px; width: 80%; font-size: 16px;">
        <button onclick="submitGradeInput()" style="padding: 10px; font-size: 16px; margin-top: 10px;">Submit</button>
        <button onclick="cancelGradeInput()" style="padding: 10px; font-size: 16px; margin-top: 10px; background-color: #f1f1f1;">Cancel</button>
    `;
    document.body.appendChild(customPrompt);

    window.submitGradeInput = function() {
        const gradesInput = document.getElementById('gradeInput').value.trim();
        if (!gradesInput) {
            alert("No grades entered. Printing canceled.");
            return;
        }
        const selectedGrades = gradesInput.split(',').map(grade => grade.trim());

        const combinedContentElement = document.getElementById("combinedMeritLists");
        if (!combinedContentElement || combinedContentElement.innerHTML.trim() === "") {
            alert("No combined merit list to print.");
            return;
        }

        const filteredElements = [];
        const allElements = combinedContentElement.children;
        for (let i = 0; i < allElements.length; i++) {
            const element = allElements[i];
            if (element.tagName === "H3" && selectedGrades.some(grade => element.textContent.includes(`Grade ${grade}`))) {
                filteredElements.push(element.outerHTML);
                if (allElements[i + 1] && allElements[i + 1].tagName === "TABLE") {
                    filteredElements.push(allElements[i + 1].outerHTML);
                }
            }
        }

        const combinedHtml = filteredElements.join("");
        if (!combinedHtml) {
            alert("No merit lists found for the selected grades.");
            return;
        }

        const logoUrl = "https://i.imgur.com/UW65hfv.png ";
        const spinner = document.createElement('div');
        spinner.style.position = 'fixed';
        spinner.style.top = '50%';
        spinner.style.left = '50%';
        spinner.style.transform = 'translate(-50%, -50%)';
        spinner.style.border = '16px solid #f3f3f3';
        spinner.style.borderTop = '16px solid #3498db';
        spinner.style.borderRadius = '50%';
        spinner.style.width = '80px';
        spinner.style.height = '80px';
        spinner.style.animation = 'spin 2s linear infinite';
        spinner.style.zIndex = '9999';
        document.body.appendChild(spinner);

        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        const iframe = document.createElement('iframe');
        iframe.style.position = 'absolute';
        iframe.style.width = '0';
        iframe.style.height = '0';
        iframe.style.border = 'none';
        document.body.appendChild(iframe);

        iframe.contentWindow.document.open();
        iframe.contentWindow.document.write(`
            <html>
                <head>
                    <title>Combined Merit List - ${schoolName}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 20px;
                        }
                        h1, h2, h3 {
                            text-align: center;
                            margin: 10px 0;
                        }
                        .report-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                        }
                        .report-table th, .report-table td {
                            border: 1px solid black;
                            padding: 8px;
                            text-align: center;
                        }
                        .header-info {
                            font-weight: bold;
                            margin-bottom: 20px;
                        }
                        .logo {
                            display: block;
                            margin: 0 auto;
                            width: 100px;
                            height: auto;
                        }
                    </style>
                </head>
                <body>
                    <img src="${logoUrl}" class="logo" alt="School Logo">
                    <div class="header-info">
                        <p>School: ${schoolName}</p>
                        <p>Grade Level: ${grade}</p>
                        <p>Term: ${term}</p>
                        <p>Year: ${year}</p>
                    </div>
                    ${combinedHtml}
                </body>
            </html>
        `);
        iframe.contentWindow.document.close();

        iframe.onload = function () {
            iframe.contentWindow.print();
            document.body.removeChild(spinner);
            document.body.removeChild(iframe);
            document.body.removeChild(customPrompt);
        };
    };

    window.cancelGradeInput = function() {
        document.body.removeChild(customPrompt);
        alert("Grade selection canceled.");
    };
}



function saveGroupedChanges(grade) { 
    const table = document.getElementById(`groupedTable-${grade}`);
    const rows = table.querySelectorAll("tbody tr");

    // Update learners list based on grouped table edits
    rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        const admissionNumber = cells[9].textContent.trim(); // Adjusted index for Admission Number

        const learnerIndex = learners.findIndex(l => l.admissionNumber === admissionNumber);
        if (learnerIndex !== -1) {
            learners[learnerIndex] = {
                photo: cells[1].querySelector('img').src, // Retrieve photo source
                name: cells[2].textContent.trim(),
                gender: cells[3].textContent.trim(),
                grade: cells[4].textContent.trim(),
                age: parseInt(cells[5].textContent.trim()),
                parentName: cells[6].textContent.trim(),
                phone: cells[7].textContent.trim(),
                birthCertificateNo: cells[8].textContent.trim(),
                admissionNumber: cells[9].textContent.trim()
            };
        }
    });

    // Save updates to localStorage
    localStorage.setItem('learners', JSON.stringify(learners));
    alert(`Changes for Grade ${grade} have been saved successfully.`);
}
function updateMarksTable() {
    // Sort the marks by totalMarks in descending order
    marks.sort((a, b) => b.totalMarks - a.totalMarks);

    let subjectTotals = Array(9).fill(0); // Initialize totals for each subject
    let totalMarksSum = 0; // To accumulate total marks for average calculation

    marksList.innerHTML = marks.map((mark, index) => {
        // Update totals for each subject
        mark.scores.forEach((score, idx) => subjectTotals[idx] += score);
        totalMarksSum += mark.totalMarks;

        return `
            <tr>
                <td>${index + 1}</td> <!-- Row Number -->
                <td>${mark.learner}</td>
                <td>${mark.grade}</td>
                ${mark.scores.map(score => `<td>${score}</td><td>${getLevel(score)}</td>`).join('')}
                <td style="font-weight:bold; border: 2px solid black;">${mark.totalMarks}</td>
                <td>
                    <button onclick="deleteMarks(${index})" class="circle-button">
                        <i class="fas fa-trash-alt"></i> Del
                    </button>
                </td>
            </tr>
        `;
    }).join("");

    // Calculate averages and add totals to the table
    const averages = subjectTotals.map(total => (total / marks.length).toFixed(2));
    const totalRow = `
        <tr>
            <td colspan="3" style="font-weight:bold;">Total</td>
            ${subjectTotals.map(total => `<td style="font-weight:bold;">${total}</td><td></td>`).join('')}
            <td style="font-weight:bold;">${totalMarksSum}</td>
        </tr>`;
    const averageRow = `
        <tr>
            <td colspan="3" style="font-weight:bold;">Average</td>
            ${averages.map(avg => `<td style="font-weight:bold;">${avg}</td><td></td>`).join('')}
            <td style="font-weight:bold;">${(totalMarksSum / marks.length).toFixed(2)}</td>
        </tr>`;

    marksList.innerHTML += totalRow + averageRow;

    // ? Refresh the grade filter dropdown
    populateGradeDropdown();
}


        function deleteMarks(index) {
            marks.splice(index, 1);  // Remove the mark entry at the specified index
            updateMarksTable();  // Update the table to reflect changes
        }

        function getLevel(score) {
            if (score >= 75) return 4;
            if (score >= 50) return 3;
            if (score >= 25) return 2;
            if (score < 25) return 1;
            return 0; // Default level if score is invalid
       }

// Function to load data from localStorage
function loadFromStorage() {
    // Retrieve all data from localStorage
    const storedData = JSON.parse(localStorage.getItem("schoolData")) || {};

    // Return marks data (or an empty array if none is found)
    return storedData.marks || [];

  
};
// Function to view the archived marks grouped by grade
function viewArchives() {
    // Retrieve archived marks from localStorage
    const archivedMarks = JSON.parse(localStorage.getItem("archivedMarks")) || [];

    if (archivedMarks.length === 0) {
        showAlertMessage("No archived marks available.");
        return;
    }

    // Group marks by grade
    const marksByGrade = archivedMarks.reduce((acc, mark) => {
        if (!acc[mark.grade]) {
            acc[mark.grade] = [];
        }
        acc[mark.grade].push(mark);
        return acc;
    }, {});

    // Initialize the HTML for the View Archives section
    let archivedHtml = `<button onclick="printArchivedMarks()">Print Archived Marks</button>`;

    // Iterate through each grade and create a separate table
    for (const [grade, marks] of Object.entries(marksByGrade)) {
        const subjectTotals = Array(9).fill(0); // Assuming 9 subjects
        let totalMarksSum = 0;

        // Add the headers dynamically with editable school name, grade, and term
        archivedHtml += `
            <div>
                <h3 style="font-weight: bold; font-size: 16px;">Grade: ${grade}</h3>
                <label for="schoolName-${grade}">School:</label>
                <input type="text" id="schoolName-${grade}" value="${marks[0].schoolName || 'N/A'}" />
                <label for="grade-${grade}">Grade:</label>
                <input type="text" id="grade-${grade}" value="${marks[0].grade || 'N/A'}" />
                <label for="term-${grade}">Term:</label>
                <input type="text" id="term-${grade}" value="${marks[0].term || 'N/A'}" />
                <button onclick="saveChanges('${grade}')"><i class="fas fa-save"></i> Save Changes</button>

            </div>
           <button onclick="printArchivedTable('${grade}')"><i class="fas fa-print"></i> Print Grade ${grade}</button>
  <button onclick="deleteArchivedTable('${grade}')" class="btn-red">Delete</button>

            <table id="archivedTable-${grade}" class="report-table">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Learner</th>
                        <th>Grade</th>
                        <th>Eng</th><th>Lev</th>
                        <th>Math</th><th>Lev</th>
                        <th>Pre-Tech</th><th>Lev</th>
                        <th>Kisw</th><th>Lev</th>
                        <th>Scie</th><th>Lev</th>
                        <th>Sst</th><th>Lev</th>
                        <th>Agric</th><th>Lev</th>
                        <th>Cre</th><th>Lev</th>
                        <th>C/A</th><th>Lev</th>
                        <th>Total Marks</th>
                    </tr>
                </thead>
                <tbody>
        `;

        marks.forEach((mark, index) => {
            // Update totals for each subject and overall
            mark.scores.forEach((score, subjectIndex) => {
                subjectTotals[subjectIndex] += score;
            });
            totalMarksSum += mark.totalMarks;

            // Append each learner's row
            archivedHtml += `
                <tr>
                    <td>${index + 1}</td> <!-- Row Number -->
                    <td>${mark.learner}</td>
                    <td>${mark.grade}</td>
                    ${mark.scores.map((score, subjectIndex) => `
                        <td>${score}</td>
                        <td>${getLevel(score)}</td>
                    `).join('')}
                    <td style="font-weight:bold;">${mark.totalMarks}</td>
                    <td><button onclick="deleteArchivedMark(${index})">Delete</button></td>
                </tr>
            `;
        });

        // Calculate averages
        const averages = subjectTotals.map(total => (total / marks.length).toFixed(2));
        const overallAverageMarks = (totalMarksSum / marks.length).toFixed(2);

        // Add Totals row
        archivedHtml += `
            <tr>
                <td colspan="3"><strong>Total</strong></td>
                ${subjectTotals.map(total => `<td><strong>${total}</strong></td><td></td>`).join('')}
                <td><strong>${totalMarksSum}</strong></td>
            </tr>
        `;

        // Add Averages row
        archivedHtml += `
            <tr>
                <td colspan="3"><strong>Average</strong></td>
                ${averages.map(avg => `<td><strong>${avg}</strong></td><td></td>`).join('')}
                <td><strong>${overallAverageMarks}</strong></td>
            </tr>
        `;

        archivedHtml += "</tbody></table><hr>";
    }

    // Display the archived marks by grade
    document.getElementById("archivedMarksList").innerHTML = archivedHtml;
    document.getElementById("archivesSection").style.display = "block"; // Show the archives section
}
function deleteArchivedTable(grade) {
    var tableElement = document.getElementById(`archivedTable-${grade}`);

    if (tableElement) {
        showCustomConfirm(
            `Are you sure you want to delete <span style="color: red; font-weight: bold;">Grade ${grade} archived marks</span>?`, 
            () => {
                // Remove from UI
                tableElement.parentElement.remove();

                // Retrieve archived marks from local storage
                let archivedMarks = JSON.parse(localStorage.getItem("archivedMarks")) || [];

                // Filter out the deleted grade
                archivedMarks = archivedMarks.filter(mark => mark.grade !== grade);

                // Update local storage
                localStorage.setItem("archivedMarks", JSON.stringify(archivedMarks));

                showCustomAlert(`<span style="color: green; font-weight: bold;">Archived marks for Grade ${grade} deleted successfully!</span>`);
            }
        );
    } else {
        showCustomAlert(`<span style="color: red; font-weight: bold;">Error: Table not found.</span>`);
    }
}
 // Function to show a custom-styled alert box
function showCustomAlert(message) {
    let alertBox = document.createElement("div");
    alertBox.innerHTML = `<div style="
        position: fixed; 
        top: 20%; 
        left: 50%; 
        transform: translate(-50%, -50%);
        background-color: #f8f9fa;
        border: 2px solid green;
        padding: 15px;
        text-align: center;
        font-size: 16px;
        font-weight: bold;
        color: black;
        border-radius: 10px;
        box-shadow: 0px 4px 10px rgba(0,0,0,0.3);
        z-index: 1000;">
        ${message}
        <br><br>
        <button onclick="this.parentElement.remove()" style="
            background: green; 
            color: white; 
            padding: 8px 15px; 
            border: none; 
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;">OK</button>
    </div>`;
    document.body.appendChild(alertBox);
}

// Function to show a custom-styled confirmation box
function showCustomConfirm(message, onConfirm) {
    let confirmBox = document.createElement("div");
    confirmBox.innerHTML = `<div style="
        position: fixed; 
        top: 20%; 
        left: 50%; 
        transform: translate(-50%, -50%);
        background-color: #fff3cd;
        border: 2px solid orange;
        padding: 15px;
        text-align: center;
        font-size: 16px;
        font-weight: bold;
        color: black;
        border-radius: 10px;
        box-shadow: 0px 4px 10px rgba(0,0,0,0.3);
        z-index: 1000;">
        ${message}
        <br><br>
        <button onclick="onConfirm(); this.parentElement.remove()" style="
            background: red; 
            color: white; 
            padding: 8px 15px; 
            border: none; 
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;">Yes</button>
        <button onclick="this.parentElement.remove()" style="
            background: gray; 
            color: white; 
            padding: 8px 15px; 
            border: none; 
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;">No</button>
    </div>`;
    document.body.appendChild(confirmBox);
}    
// Function to display the alert message with custom styling
function showAlertMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.innerHTML = message;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '50%';
    alertDiv.style.left = '50%';
    alertDiv.style.transform = 'translate(-50%, -50%)';
    alertDiv.style.padding = '20px';
    alertDiv.style.backgroundColor = 'red';
    alertDiv.style.color = 'white';
    alertDiv.style.fontSize = '18px';
    alertDiv.style.fontWeight = 'bold';
    alertDiv.style.textAlign = 'center';
    alertDiv.style.borderRadius = '10px';
    alertDiv.style.zIndex = '1000';

    document.body.appendChild(alertDiv);

    // Remove the alert after 3 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

// Function to save the changes made to the school name, grade, and term
function saveChanges(grade) {
    const schoolName = document.getElementById(`schoolName-${grade}`).value;
    const gradeValue = document.getElementById(`grade-${grade}`).value;
    const term = document.getElementById(`term-${grade}`).value;

    // Retrieve archived marks and update the school name, grade, and term
    let archivedMarks = JSON.parse(localStorage.getItem("archivedMarks")) || [];

    archivedMarks = archivedMarks.map(mark => {
        if (mark.grade === grade) {
            mark.schoolName = schoolName;
            mark.grade = gradeValue;
            mark.term = term;
        }
        return mark;
    });

    // Save the updated archived marks back to localStorage
    localStorage.setItem("archivedMarks", JSON.stringify(archivedMarks));

    // Notify the user with a custom success message
    showAlertMessage("Changes saved successfully!", 'green');
    viewArchives(); // Re-render the archives section to show updated values
}

// Function to display a custom alert message with styling
function showAlertMessage(message, color) {
    const alertDiv = document.createElement('div');
    alertDiv.innerHTML = message;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '50%';
    alertDiv.style.left = '50%';
    alertDiv.style.transform = 'translate(-50%, -50%)';
    alertDiv.style.padding = '20px';
    alertDiv.style.backgroundColor = color || 'red'; // Default color is red
    alertDiv.style.color = 'white';
    alertDiv.style.fontSize = '18px';
    alertDiv.style.fontWeight = 'bold';
    alertDiv.style.textAlign = 'center';
    alertDiv.style.borderRadius = '10px';
    alertDiv.style.zIndex = '1000';

    document.body.appendChild(alertDiv);

    // Remove the alert after 3 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}



// Helper function to determine the level based on the score
function getLevel(score) {
    if (score >= 75) return 4;
    if (score >= 50) return 3;
    if (score >= 25) return 2;
    return 1; // Default level if score is below 25
}
function deleteArchivedMark(index) {
    // Retrieve the archived marks from localStorage
    let archivedMarks = JSON.parse(localStorage.getItem("archivedMarks")) || [];

    // Remove the selected mark
    archivedMarks.splice(index, 1);

    // Save the updated archived marks back to localStorage
    localStorage.setItem("archivedMarks", JSON.stringify(archivedMarks));

    // Refresh the archives view
    viewArchives();

    // Display the success message
    displaySuccessMessage("Archived mark deleted successfully.");
}

// Function to display a success message
function displaySuccessMessage(message) {
    // Create a success message element
    const successMessageDiv = document.createElement("div");
    successMessageDiv.textContent = message;
    successMessageDiv.style.backgroundColor = "#d4edda"; // Light green background
    successMessageDiv.style.color = "#155724"; // Dark green text
    successMessageDiv.style.border = "1px solid #c3e6cb"; // Green border
    successMessageDiv.style.padding = "10px";
    successMessageDiv.style.marginTop = "10px";
    successMessageDiv.style.borderRadius = "5px";
    successMessageDiv.style.fontWeight = "bold";
    successMessageDiv.style.textAlign = "center";

    // Append the success message to a designated container or the body
    const container = document.getElementById("archivesSection") || document.body;
    container.appendChild(successMessageDiv);

    // Automatically remove the message after 3 seconds
    setTimeout(() => {
        successMessageDiv.remove();
    }, 3000);
}

function printArchivedMarks() {
    // Retrieve information from the champions form fields
    const schoolName = document.getElementById("schoolName").value || "School Name";
    const gradeLevel = document.getElementById("gradeLevel").value || "Grade";
    const year = document.getElementById("year").value || "Year";
    const term = document.getElementById("term").value || "Term";

    // URL or base64 string of your logo
    const logoUrl = "https://i.imgur.com/UW65hfv.png"; // Replace with your logo's URL or base64 string

    // Get the content for Archived Marks
    const reportDiv = document.getElementById("report");
    const performanceHtml = reportDiv.innerHTML;

    // Open a new window to format and print the archived marks content
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Archived Marks</title>
                <style>
                    body { font-family: Arial, sans-serif; }
                    .report-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-bottom: 20px;
                    }
                    .report-table th, .report-table td {
                        border: 2px solid black;
                        padding: 10px;
                        text-align: center;
                    }
                    .header-info {
                        margin-bottom: 20px;
                        font-weight: bold;
                    }
                    .logo {
                        display: block;
                        margin: 0 auto;
                        width: 100px; /* Adjust logo size */
                        height: auto;
                    }
                </style>
            </head>
            <body>
                <img src="${logoUrl}" class="logo" alt="School Logo">
                <div class="header-info">
                    <p>School: ${schoolName}</p>
                    <p>Grade: ${gradeLevel}</p>
                    <p>Year: ${year}</p>
                    <p>Term: ${term}</p>
                </div>
                ${performanceHtml}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}


        function updateLearnerSelect() {
            learnerSelect.innerHTML = learners.map(learner => `<option>${learner.name}</option>`).join("");
        }

        function updateBulkGradeSelect() {
            const grades = [...new Set(learners.map(learner => learner.grade))];
            bulkGradeSelect.innerHTML = grades.map(grade => `<option>${grade}</option>`).join("");
        }
function populateLearnerSuggestions() {
    const learnerList = document.getElementById("learnerList");

    // Update learner options with name and grade
    learnerList.innerHTML = learners
        .map(learner => `<option value="${learner.name} (Grade: ${learner.grade})">`)
        .join("");
}


        function searchLearner() {
            const query = document.getElementById("searchLearner").value.toLowerCase();
            const rows = learnersList.getElementsByTagName("tr");
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName("td");
                const name = cells[1]?.textContent.toLowerCase();
                rows[i].style.display = name.includes(query) ? "" : "none";
            }
        }

        function searchMarks() {
            const query = document.getElementById("searchMarks").value.toLowerCase();
            const rows = marksList.getElementsByTagName("tr");
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName("td");
                const learnerName = cells[0]?.textContent.toLowerCase();
                rows[i].style.display = learnerName.includes(query) ? "" : "none";
            }
        }

        function toggleLearnersTable() {
            const table = document.querySelector('.learners-table');
            table.style.display = table.style.display === 'none' ? 'table' : 'none';
       
}
function confirmDeleteLearner(index) {
    const learnerName = learners[index].name; // Assumes 'learners' is your learners array

    // Create a custom confirmation dialog
    const confirmationDialog = document.createElement('div');
    confirmationDialog.style.position = 'fixed';
    confirmationDialog.style.top = '50%';
    confirmationDialog.style.left = '50%';
    confirmationDialog.style.transform = 'translate(-50%, -50%)';
    confirmationDialog.style.backgroundColor = '#f9f9f9';
    confirmationDialog.style.border = '2px solid #ccc';
    confirmationDialog.style.padding = '20px';
    confirmationDialog.style.textAlign = 'center';
    confirmationDialog.style.borderRadius = '10px';
    confirmationDialog.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
    confirmationDialog.style.zIndex = '1000';
    confirmationDialog.style.width = '300px';

    confirmationDialog.innerHTML = `
        <p style="color: red; font-weight: bold;">Are you sure you want to delete ${learnerName}?</p>
        <button id="confirmDelete" style="background-color: #f44336; color: white; padding: 10px; border: none; border-radius: 5px; margin-right: 10px;">Yes</button>
        <button id="cancelDelete" style="background-color: #4CAF50; color: white; padding: 10px; border: none; border-radius: 5px;">No</button>
    `;
    document.body.appendChild(confirmationDialog);

    // Handle confirmation
    document.getElementById('confirmDelete').addEventListener('click', () => {
        removeLearner(index); // Call your existing function to delete the learner

        // Show a success message
        confirmationDialog.innerHTML = `
            <p style="color: green; font-weight: bold;">Learner has been deleted successfully.</p>
        `;
        setTimeout(() => confirmationDialog.remove(), 3000); // Remove the dialog after 3 seconds
    });

    // Handle cancellation
    document.getElementById('cancelDelete').addEventListener('click', () => {
        confirmationDialog.remove(); // Close the dialog
    });
}

function removeLearner(index) {
    learners.splice(index, 1); // Remove the learner from the array
    updateLearnersTable(); // Update the table after deletion
    localStorage.setItem('learners', JSON.stringify(learners)); // Save the updated list to local storage
}
 // Reuse the custom grade-prompt helper (with inline CSS)
  function promptForGradeCustom(message) {
    return new Promise(resolve => {
      const ov = document.createElement('div');
      Object.assign(ov.style, {
        position: 'fixed', top: 0, left: 0,
        width: '100%', height: '100%',
        background: 'rgba(0,0,0,0.6)',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        zIndex: 9999
      });
      const box = document.createElement('div');
      Object.assign(box.style, {
        background: '#fff', padding: '20px',
        borderRadius: '8px', width: '320px', maxWidth: '90%',
        boxShadow: '0 4px 12px rgba(0,0,0,0.3)', textAlign: 'center'
      });
      box.innerHTML = `
        <p style="margin-bottom:12px;font-weight:bold;">${message}</p>
        <input id="gradePromptInput" type="text" placeholder="e.g. 7"
               style="width:100%;padding:8px;margin-bottom:12px;
                      border:1px solid #ccc;border-radius:4px;" />
        <div>
          <button id="gradePromptOk"
                  style="padding:8px 16px;margin:0 6px;
                         border:none;border-radius:4px;
                         background:#4CAF50;color:#fff;
                         cursor:pointer;">OK</button>
          <button id="gradePromptCancel"
                  style="padding:8px 16px;margin:0 6px;
                         border:none;border-radius:4px;
                         background:#f44336;color:#fff;
                         cursor:pointer;">Cancel</button>
        </div>`;
      ov.appendChild(box);
      document.body.appendChild(ov);
      const inp = document.getElementById('gradePromptInput');
      inp.focus();
      inp.addEventListener('keydown', e => {
        if (e.key === 'Enter') document.getElementById('gradePromptOk').click();
      });
      document.getElementById('gradePromptOk').onclick = () => {
        const val = inp.value.trim();
        document.body.removeChild(ov);
        resolve(val || null);
      };
      document.getElementById('gradePromptCancel').onclick = () => {
        document.body.removeChild(ov);
        resolve(null);
      };
    });
  }

function showSubjectPerformance() {
    const modal = document.createElement("div");
    modal.id = "subjectPerformanceModal";
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.6); display: flex;
        justify-content: center; align-items: center; z-index: 9999;
    `;

    const box = document.createElement("div");
    box.style.cssText = `
        background: white; padding: 20px; border-radius: 10px;
        width: 300px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    `;

    box.innerHTML = `
        <h3 style="color: #4CAF50;">Enter Grade</h3>
        <input id="performanceGradeInput" placeholder="e.g. 6" style="
            width: 80%; padding: 10px; margin-bottom: 15px;
            border: 1px solid #ccc; border-radius: 5px;
        "/>
        <br/>
        <button onclick="generateSubjectPerformance()" style="
            background: #4CAF50; color: white; padding: 10px 15px;
            border: none; border-radius: 5px; margin-right: 10px;">
            Generate
        </button>
        <button onclick="document.getElementById('subjectPerformanceModal').remove()" style="
            background: #f44336; color: white; padding: 10px 15px;
            border: none; border-radius: 5px;">
            Cancel
        </button>
    `;

    modal.appendChild(box);
    document.body.appendChild(modal);
}

function generateSubjectPerformance() {
    const grade = document.getElementById("performanceGradeInput").value.trim();
    document.getElementById("subjectPerformanceModal").remove();

    if (!grade) {
        alert("Please enter a grade.");
        return;
    }

    const filteredMarks = marks.filter(mark => mark.grade == grade);
    if (filteredMarks.length === 0) {
        alert("No records found for Grade " + grade);
        return;
    }

    const subjects = [
        'English', 'Mathematics', 'Pre-Technical Studies',
        'Kiswahili', 'Integrated Science', 'Social Studies',
        'Agriculture', 'Religious Education', 'Creative Art'
    ];

    const subjectScores = {};

    filteredMarks.forEach(mark => {
        mark.scores.forEach((score, index) => {
            const subject = subjects[index];
            if (!subject) return;

            score = Number(score);
            if (!isNaN(score)) {
                if (!subjectScores[subject]) {
                    subjectScores[subject] = { total: 0, count: 0 };
                }
                subjectScores[subject].total += score;
                subjectScores[subject].count++;
            }
        });
    });

    function getPerformanceLevel(score) {
        if (score >= 0 && score <= 25) return "Level 1 (BE)";
        if (score >= 26 && score <= 49) return "Level 2 (AE)";
        if (score >= 50 && score <= 75) return "Level 3 (ME)";
        if (score >= 76 && score <= 100) return "Level 4 (EE)";
        return "Invalid Score";
    }

    const meanScores = Object.keys(subjectScores).map(subject => {
        const { total, count } = subjectScores[subject];
        const mean = count > 0 ? (total / count).toFixed(2) : "0.00";
        return {
            subject,
            mean,
            level: getPerformanceLevel(mean)
        };
    }).sort((a, b) => b.mean - a.mean);

    const topSubjects = meanScores.slice(0, 3);

    let html = `<h3 style="color: #4CAF50; text-align: center;">Subject Performance - Grade ${grade}</h3>`;
    html += `<table style="
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        background-color: white;
        color: black;
        font-size: 16px;
    ">
        <thead>
            <tr style="background: #f2f2f2;">
                <th style="border: 1px solid black; padding: 10px;">No.</th>
                <th style="border: 1px solid black; padding: 10px;">Subject</th>
                <th style="border: 1px solid black; padding: 10px;">Mean Score</th>
                <th style="border: 1px solid black; padding: 10px;">Performance Level</th>
            </tr>
        </thead>
        <tbody>`;

    let count = 1;
    meanScores.forEach(({ subject, mean, level }) => {
        const isTop = topSubjects.find(top => top.subject === subject);
        html += `<tr style="${isTop ? 'background: #FFD700; font-weight: bold;' : ''}">
            <td style="border: 1px solid black; padding: 10px;">${count++}</td>
            <td style="border: 1px solid black; padding: 10px;">${subject}</td>
            <td style="border: 1px solid black; padding: 10px;">${mean}</td>
            <td style="border: 1px solid black; padding: 10px;">${level}</td>
        </tr>`;
    });

    html += `</tbody></table>`;
    document.getElementById("report").innerHTML = html;

    celebrateTopSubjects(topSubjects);
}


// Toggle visibility of the Registered Learners box
function toggleRegisteredLearners() {
    const section = document.getElementById('registeredLearnersBox');
    section.style.display = (section.style.display === 'none') ? 'block' : 'none';
}
// Toggle visibility of the View Archives
function toggleViewArchives() {
    const section = document.getElementById('viewArchives');
    section.style.display = (section.style.display === 'none') ? 'block' : 'none';
}
        function groupMarksByGrade() {
            const groupedMarks = marks.reduce((acc, mark) => {
                if (!acc[mark.grade]) {
                    acc[mark.grade] = [];
                }
                acc[mark.grade].push(mark);
                return acc;
            }, {});

            let groupedHtml = '';
            for (const grade in groupedMarks) {
                groupedHtml += `<h3>Grade: ${grade}</h3><button onclick="printGroupedMarks('${grade}')">Print ${grade} Marks</button><table class="report-table"><thead><tr><th>Learner</th><th>Grade</th>${Array(9).fill('<th>Subject</th><th>Level</th>').join('')}<th>Total Marks</th></tr></thead><tbody>`;
                const subjectTotals = Array(9).fill(0);

                groupedMarks[grade].forEach(mark => {
                    groupedHtml += `<tr><td>${mark.learner}</td><td>${mark.grade}</td>${mark.scores.map(score => `<td>${score}</td><td>${getLevel(score)}</td>`).join('')}<td>${mark.totalMarks}</td></tr>`;
                    mark.scores.forEach((score, index) => subjectTotals[index] += score);
                });

                // Calculate totals and averages
                const averages = subjectTotals.map(total => (total / groupedMarks[grade].length).toFixed(2));
                groupedHtml += `<tr><td colspan="2"><strong>Total</strong></td>${subjectTotals.map(total => `<td><strong>${total}</strong></td><td></strong></td>`).join('')}<td><strong></strong></td></tr>`;
                groupedHtml += `<tr><td colspan="2"><strong>Average</strong></td>${averages.map(avg => `<td><strong>${avg}</strong></td><td></td>`).join('')}<td><strong></strong></td></tr>`;
                groupedHtml += '</tbody></table>';
            }
            groupedLearners.innerHTML = groupedHtml; // Update the grouped learners div
        }
    function clearForm() {
    document.getElementById("learnerForm").reset();
}

// Then modify the event listener to call this function:
document.getElementById("learnerForm").addEventListener("submit", function (e) {
    e.preventDefault();
    // ... code to add learner
    clearForm(); // Clears form fields
});

function printSubjectPerformance() {
    // Retrieve information from the champions form fields
    const schoolName = document.getElementById("schoolName").value || "School Name";
    const gradeLevel = document.getElementById("gradeLevel").value || "Grade";
    const year = document.getElementById("year").value || "Year";
    const term = document.getElementById("term").value || "Term";

    // URL or base64 string of your logo
    const logoUrl = " https://i.imgur.com/UW65hfv.png"; // Replace with your logo's URL or base64 string

    // Get the content for Subject Performance
    const reportDiv = document.getElementById("report");
    const performanceHtml = reportDiv.innerHTML;

    // Open a new window to format and print the performance content
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Subject Performance</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                    }
                    .header-info {
                        text-align: left;
                        margin-bottom: 20px;
                        font-weight: bold;
                    }
                    .report-table {
                        width: 100%;
                        border-collapse: collapse;
                    }
                    .report-table th, .report-table td {
                        border: 2px solid black;
                        padding: 10px;
                        text-align: center;
                    }
                    .stamp {
                        border: 2px solid blue;
                        color: blue;
                        text-align: center;
                        width: 200px;
                        height: 70px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 10px auto;
                        font-weight: bold;
                    }
                    .logo {
                        display: block;
                        margin: 0 auto;
                        width: 100px; /* Adjust logo size */
                        height: auto;
                    }
                </style>
            </head>
            <body>
                <img src="${logoUrl}" class="logo" alt="School Logo">
                <div class="header-info">
                    <p>School: ${schoolName}</p>
                    <p>Grade: ${gradeLevel}</p>
                    <p>Year: ${year}</p>
                    <p>Term: ${term}</p>
                </div>
                ${performanceHtml}
                <div class="stamp">NACHU JUNIOR SCHOOL JUNIOR  SCHOOL<br>561-00902 Kikuyu</div>
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Toggle visibility of the Bulk Report Generation section
function toggleBulkReportGeneration() {
    const section = document.getElementById('bulkReportGeneration');
    section.style.display = (section.style.display === 'none') ? 'block' : 'none';
}

// Toggle visibility of the Marks Table section
function toggleMarksTable() {
    const section = document.getElementById('marksTableSection');
    section.style.display = (section.style.display === 'none') ? 'block' : 'none';
}

// Toggle visibility of the Junior School Marks Entry Section
function toggleJuniorMarksEntry() {
    const section = document.getElementById('juniorMarksEntrySection');
    section.style.display = (section.style.display === 'none') ? 'block' : 'none';
}

// Toggle visibility of the Register Learner form
function toggleRegisterLearner() {
    const section = document.getElementById('registerLearnerSection');
    section.style.display = (section.style.display === 'none') ? 'block' : 'none';
}

// Toggle visibility of the Actions For Junior School section
function toggleJuniorSchoolActions() {
    const section = document.getElementById('juniorSchoolActions');
    section.style.display = (section.style.display === 'none') ? 'block' : 'none';
}
function generateBulkReports() { 
    const selectedGrade = bulkGradeSelect.value;
    const learnersInGrade = marks.filter(mark => mark.grade === selectedGrade);

    getDynamicDetails((details) => {
        getTeacherNames((teacherNames) => {
            const bulkReportsContainer = learnersInGrade.map(learnerData => {
                // Find the learner and their photo
                const learner = learners.find(l => l.name === learnerData.learner);
                const photo = learner && learner.photo
                    ? `<img src="${learner.photo}" alt="Photo" style="width:80px; height:80px; border-radius:5px; object-fit:cover;">`
                    : '<div style="width:100px; height:100px; border:1px solid #ccc; text-align:center; line-height:100px;">No Photo</div>';

                // Current date and time
                const currentDate = new Date();
                const formattedDate = currentDate.toLocaleDateString();
                const formattedTime = currentDate.toLocaleTimeString();

                // Logos
                const schoolLogo = `<img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo" style="max-width:100px; display:block; margin-bottom:10px; float:left;">`;
                const centeredLogo = `<div style="text-align:center; margin-bottom:20px;">
                    <img src="https://i.imgur.com/KkbIFjL.png" alt="New Logo" style="max-width:100px; height:auto;">
                </div>`;

                // Generate the report template
                return `
                    ${centeredLogo}
                    <div style="clear:both; padding-bottom:10px;">
                        ${schoolLogo}
                        <div style="margin-left:110px;">
                          <h2 style="margin:0; font-size:20px;"> NACHU JUNIOR SCHOOL LEARNER'S  PROGRESS  REPORT</h2>
                            <h3 style="margin:0; font-size:20px;">PO BOX 561-00902 KIKUYU, KENYA </h3>
                            <h4 style="margin:0; font-size:20px;">MINISTRY OF EDUCATION SCIENCE AND TECHNOLOGY</h4>
                            <h5 style="margin:0; font-size:20px;">SCHOOL MOTTO :HARD WORK PAYS </h5>
                                     </div>
                    </div>
                    <div class="report-details" style="display: flex; align-items: flex-start; justify-content: space-between; margin-top: 10px;">
                        <div>
                            <strong>Year:</strong> ${details.year || '2024'}<br>
                            <strong>Term:</strong> ${details.term || '...'}<br>
                            <strong>Grade:</strong> ${learnerData.grade}<br>
                            <strong>Learner's Name:</strong> ${learnerData.learner}
                        </div>
                        <div id="learnerPhotoContainer-${learnerData.learner}">
                            ${photo}
                        </div>
                    </div>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Scores</th>
                                <th>Levels</th>
                                <th>Subject Teacher</th>
                                <th>Signature</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generateSubjectRows(learnerData, teacherNames)}
                        </tbody>
                    </table>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 10px; gap: 10px;">
                        <div style="border: 3px solid #000; padding: 8px; flex: 1; text-align: center;">
                            <strong>Total Marks: ${learnerData.totalMarks}</strong>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <span style="font-size: 14px;">
           KEY:1 Below Expectation, 2 Approaching Expectation, 3 Meeting Expectation, 4 Exceeding Expectation

                            </span>
                        </div>
                    </div>
                    <div class="comment-section">
                        Teacher Comments On Competencies Achieved/Acquisition Of Values: <br>
                        ${getComment(learnerData.totalMarks)}
                    </div>
                    <div class="comment-section">
                        Learner's General Performance Level: <br>
                        <strong>${getPerformanceLevel(learnerData.totalMarks)}</strong>
                    </div>
                    <div>
                        Closing Date: ${details.closingDate || 'N/A'}<br>
                        Opening Date: ${details.openingDate || 'N/A'}<br>
                        Class Teacher Signature: ${details.classTeacherSignature || '_____________'}<br>
                        Principal Signature: ${details.principalSignature || '_____________'}<br>
                        Official Stamp: <div class="stamp">
                             Nachu Junior  School <br>
                          Po Box  561-00902 Kikuyu<br>
                            Date: ${formattedDate}<br>
                        </div>
                    </div>
                    <div style="page-break-after: always;"></div>
                `;
            }).join("");

            const reportDiv = document.getElementById("report");
            reportDiv.innerHTML = bulkReportsContainer;
        });
    });
}

function generateSubjectRows(learnerData, teacherNames) { 
    const subjects = [
         'English', 'Mathematics', 'Pre-Technical Studies', 'Kiswahili', 
        'Integrated Science', 'Social Studies', 'Agriculture', 
        'Religious Education', 'Creative Arts & Sports'
    ];

    return subjects.map((subject, index) => {
        const teacherName = teacherNames[subject] || "Unknown Teacher";
        
        // Extract the initials of the teacher's name
        const initials = teacherName
            .split(" ") // Split the name into parts
            .map(word => word.charAt(0)) // Take the first letter of each part
            .join(""); // Combine the initials
        
        return `
            <tr>
                <td>${subject}</td>
                <td>${learnerData.scores[index]}</td>
                <td>${getLevel(learnerData.scores[index])}</td>
                <td>${teacherName}</td>
                <td>${initials}</td> <!-- Automatically filled signature -->
            </tr>
        `;
    }).join('');
}

function getDynamicDetails(callback) {
    const details = {};
    const prompts = [
        { key: "year", message: "Enter the Year:" },
        { key: "term", message: "Enter the Term:" },
        { key: "closingDate", message: "Enter the Closing Date:" },
        { key: "openingDate", message: "Enter the Opening Date:" },
        { key: "classTeacherSignature", message: "Enter the Class Teacher's Signature:" },
        { key: "principalSignature", message: "Enter the Principal's Signature:" }
    ];
    let currentPromptIndex = 0;

    function showNextPrompt() {
        if (currentPromptIndex >= prompts.length) {
            closeModal();
            callback(details);
            return;
        }

        const modal = document.getElementById("teacherPromptModal");
        const overlay = document.getElementById("overlay");
        const subjectPromptText = document.getElementById("subjectPromptText");

        subjectPromptText.textContent = prompts[currentPromptIndex].message;

        modal.style.display = "block";
        overlay.style.display = "block";

        document.getElementById("teacherNameInput").focus();
    }

    document.getElementById("submitTeacherName").onclick = function () {
        const input = document.getElementById("teacherNameInput");
        details[prompts[currentPromptIndex].key] = input.value.trim() || 'N/A';
        input.value = "";
        currentPromptIndex++;
        showNextPrompt();
    };

    function closeModal() {
        document.getElementById("teacherPromptModal").style.display = "none";
        document.getElementById("overlay").style.display = "none";
    }

    showNextPrompt();
}

function getTeacherNames(callback) {
    const subjects = [
       'English', 'Mathematics', 'Pre-Technical Studies', 'Kiswahili', 
        'Integrated Science', 'Social Studies', 'Agriculture', 
        'Religious Education', 'Creative Arts & Sports'
    ];
    const teacherNames = {};
    let currentSubjectIndex = 0;

    function showTeacherPrompt() {
        if (currentSubjectIndex >= subjects.length) {
            closeModal();
            callback(teacherNames);
            return;
        }

        const modal = document.getElementById("teacherPromptModal");
        const overlay = document.getElementById("overlay");
        const subjectPromptText = document.getElementById("subjectPromptText");

        subjectPromptText.textContent = `Enter the teacher's name for ${subjects[currentSubjectIndex]}:`;

        modal.style.display = "block";
        overlay.style.display = "block";

        document.getElementById("teacherNameInput").focus();
    }

    document.getElementById("submitTeacherName").onclick = function () {
        const input = document.getElementById("teacherNameInput");
        teacherNames[subjects[currentSubjectIndex]] = input.value.trim() || 'N/A';
        input.value = "";
        currentSubjectIndex++;
        showTeacherPrompt();
    };

    function closeModal() {
        document.getElementById("teacherPromptModal").style.display = "none";
        document.getElementById("overlay").style.display = "none";
    }

    showTeacherPrompt();
}

function getLevel(score) {
    if (score >= 75) return 4;
    if (score >= 50) return 3;
    if (score >= 25) return 2;
    if (score < 25) return 1;
    return 0;
}

        function getComment(totalMarks) {
           if (totalMarks >= 0 && totalMarks <= 20) 
    return "Needs significant improvement. Should seek help and put in extra effort.";
if (totalMarks >= 21 && totalMarks <= 30) 
    return "Shows some understanding but needs to work harder and focus on their studies.";
if (totalMarks >= 31 && totalMarks <= 50) 
    return "Displays potential but requires more dedication to reach higher performance.";
if (totalMarks >= 51 && totalMarks <= 70) 
    return "Making steady progress. Should maintain focus to improve further.";
if (totalMarks >= 71 && totalMarks <= 85) 
    return "Demonstrates good understanding but should aim for consistent excellence.";
if (totalMarks >= 86 && totalMarks <= 140) 
    return "Shows dedication and effort but can aim for even higher performance.";
if (totalMarks >= 141 && totalMarks <= 199) 
    return "Displays self-discipline; however, should put extra effort to achieve higher scores.";
if (totalMarks >= 200 && totalMarks <= 205)  
    return "Shows enthusiasm for learning but needs to focus on grasping foundational concepts. Encouraged to seek clarification when in doubt.";  
if (totalMarks >= 206 && totalMarks <= 215)  
    return "Demonstrates interest in academics but requires more consistency in applying knowledge. Should practice regularly to build confidence.";  
if (totalMarks >= 216 && totalMarks <= 225)  
    return "Has potential to improve but needs to work on time management and study habits. Encouraged to engage more in revision and discussions.";  
if (totalMarks >= 226 && totalMarks <= 235)  
    return "Engages with class activities but should refine problem-solving techniques. Needs to develop a structured approach to answering questions.";  
if (totalMarks >= 236 && totalMarks <= 245)  
    return "Displays curiosity and willingness to learn but struggles with applying concepts. Should focus on understanding rather than memorization.";  
if (totalMarks >= 246 && totalMarks <= 255)  
    return "Puts in effort but must aim for greater accuracy in assignments and tests. Reviewing mistakes carefully will enhance performance.";  
if (totalMarks >= 256 && totalMarks <= 265)  
    return "Shows eagerness to learn but needs to work on building confidence when answering questions. Should participate more in class discussions.";  
if (totalMarks >= 266 && totalMarks <= 275)  
    return "Participates in class activities but requires a stronger grasp of core subjects. Encouraged to ask more questions and seek additional resources.";  
if (totalMarks >= 276 && totalMarks <= 285)  
    return "Makes steady progress and shows improvement in understanding concepts. Should challenge themselves further by attempting advanced problems.";  
if (totalMarks >= 286 && totalMarks <= 295)  
    return "Displays motivation and a desire to improve. Needs to focus on critical thinking and applying knowledge to real-world scenarios.";  
if (totalMarks >= 296 && totalMarks <= 300)  
    return "Committed to learning and shows perseverance. Should refine study techniques for better retention and comprehension.";  
if (totalMarks >= 301 && totalMarks <= 350)  
    return "Actively participates in class discussions and collaborates well with peers. Demonstrates growing confidence in expressing ideas.";  
if (totalMarks >= 351 && totalMarks <= 400)  
    return "Shows steady academic progress and a willingness to learn. Encouraged to maintain a consistent study schedule to reinforce learning.";  
if (totalMarks >= 401 && totalMarks <= 449)  
    return "Consistently performs above expectations, demonstrating strong analytical and problem-solving skills. A well-rounded student.";  
if (totalMarks >= 450 && totalMarks <= 500)  
    return "Exhibits leadership qualities and a solid grasp of concepts. Should continue exploring challenging material to push beyond comfort zones.";  
if (totalMarks >= 501 && totalMarks <= 550)  
    return "A high-achieving student who takes initiative in group discussions. Sets a great example for peers through disciplined study habits.";  
if (totalMarks >= 551 && totalMarks <= 599)  
    return "Excels academically and demonstrates a strong ability to grasp new concepts. Should continue nurturing curiosity and exploring deeper learning.";  
if (totalMarks >= 600 && totalMarks <= 630)  
    return "A highly motivated learner who consistently delivers outstanding results. Shows great potential for further academic excellence.";  
if (totalMarks >= 631 && totalMarks <= 670)  
    return "Displays deep subject mastery and strong analytical skills. Should take on advanced challenges to further enhance learning.";  
if (totalMarks >= 671 && totalMarks <= 700)  
    return "Demonstrates critical thinking and a keen ability to apply knowledge. Shows promise in problem-solving and independent learning.";  
if (totalMarks >= 701 && totalMarks <= 750)  
    return "Achieves remarkable academic performance with a strong work ethic. Should continue to challenge themselves with complex concepts.";  
if (totalMarks >= 751 && totalMarks <= 800)  
    return "Displays outstanding problem-solving skills and an in-depth understanding of subjects. A top performer with great potential.";  
if (totalMarks >= 801 && totalMarks <= 850)  
    return "Excels in all areas and consistently exceeds expectations. Should consider mentoring peers to reinforce knowledge.";  
if (totalMarks >= 851 && totalMarks <= 900)  
    return "An exceptional learner who sets a high standard for academic excellence. Demonstrates leadership, discipline, and an advanced understanding of concepts.";  
return "";


}

function getPerformanceLevel(totalMarks) {
             if (totalMarks >= 1 && totalMarks <= 200) return "Below expectations";
            if (totalMarks >= 201 && totalMarks <= 400) return "Approaching expectations";
            if (totalMarks >= 401 && totalMarks <= 600) return "Meeting expectations";
            if (totalMarks >= 601 && totalMarks <= 800) return "Exceeding expectations";
            return "";
}
function printAssessmentReport() {
    const selectedLearnerName = document.getElementById("learnerSelect").value;
    const learner = learners.find(l => l.name === selectedLearnerName);

    // Get the report content
    const reportDiv = document.getElementById("report");
    const assessmentReportHtml = reportDiv.innerHTML;

    // Open a new window for printing
    const printWindow = window.open('', '_blank');

    // Write the content for the print window
    printWindow.document.write(`
        <html>
            <head>
                <title>Assessment Report</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        margin: 0;
                        padding: 20px;
                    }
                    .report-table {
                        width: 100%;
                        border-collapse: collapse;
                    }
                    .report-table th, .report-table td {
                        border: 2px solid black;
                        padding: 10px;
                        text-align: center;
                    }
                    .stamp {
                        border: 2px solid blue;
                        color: blue;
                        width: 160px;
                        height: 60px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 10px auto;
                        text-align: center;
                        font-weight: bold;
                        page-break-inside: avoid;
                        page-break-before: avoid;
                        page-break-after: avoid;
                        position: relative;
                        display: inline-block;
                    }
                    @media print {
                        body {
                            font-size: 12px;
                            line-height: 1.5;
                        }
                        .stamp {
                            position: relative;
                            bottom: 0;
                        }
                    }
                </style>
            </head>
            <body>
                ${learner && learner.photo ? `
                    <div class="learner-photo-container" style="text-align: center; margin-bottom: 10px;">
                        <img src="${learner.photo}" alt="Learner Photo" class="learner-photo" 
                            style="width:70px; height:70px; object-fit:cover; border-radius:50%; border:1px solid #ccc;">
                    </div>` : ''
                }

                <div>${assessmentReportHtml}</div>

                <div class="stamp">
                   NACHU COMPREHENSIVE SCHOOL <br>
                   561-00902 Kikuyu
                </div>
            </body>
        </html>
    `);

    // Finalize the print window setup and print
    printWindow.document.close();
    printWindow.print();
}
        function printRegisteredLearners() {
    // Retrieve input values from the form
    const schoolName = document.getElementById("schoolName").value || "School Name";
    const year = document.getElementById("year").value || "Year";
    const term = document.getElementById("term").value || "Term";

    // URL or base64 string of your logo
    const logoUrl = " https://i.imgur.com/UW65hfv.png"; // Replace with your logo's URL or base64 string

    // Generate the table content for registered learners
    const tableHtml = `
        <table class="learners-table">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Photo</th>
                        <th>Name</th>
                        <th>Gender</th>
                        <th>Grade</th>
                        <th>Age</th>
                       <th>Parent Name</th>
                        <th>Parent Phone No</th>
                        <th>Birth Certificate No</th>
                        <th>Admission Number</th>
                </tr>
            </thead>
            <tbody>
                ${learners.map((learner, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td><img src="${learner.photo}" alt="Photo" width="50" height="50"></td>
                       <td>${learner.name}</td>
<td>${learner.gender}</td>
<td>${learner.grade}</td>
<td>${learner.age}</td>
<td>${learner.parentName}</td>
<td>${learner.phone}</td>
<td>${learner.birthCertificateNo}</td>
<td>${learner.admissionNumber}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

    // Open a new window for printing
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Registered Learners</title>
                <style>
                    body { font-family: Arial, sans-serif; }
                    .header-info { text-align: left; margin-bottom: 20px; font-weight: bold; }
                    .learners-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                    .learners-table th, .learners-table td { border: 2px solid black; padding: 10px; text-align: center; }
                    .logo {
                        display: block;
                        margin: 0 auto;
                        width: 100px; /* Adjust logo size */
                        height: auto;
                    }
                </style>
            </head>
            <body>
                <img src="${logoUrl}" class="logo" alt="School Logo">
                <div class="header-info">
                    <p>School: ${schoolName}</p>
                    <p>Year: ${year}</p>
                    <p>Term: ${term}</p>
                </div>
                ${tableHtml}
            </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.print();
}

function getPerformanceLevel(totalMarks) {
    if (totalMarks >= 1 && totalMarks <= 200) return "Below expectations";
    if (totalMarks >= 201 && totalMarks <= 400) return "Approaching expectations";
    if (totalMarks >= 401 && totalMarks <= 600) return "Meeting expectations";
    if (totalMarks >= 601 && totalMarks <= 800) return "Exceeding expectations";
    return "";
}

function getPerformanceLevel(totalMarks) {
    if (totalMarks >= 1 && totalMarks <= 200) return "Below expectations";
    if (totalMarks >= 201 && totalMarks <= 400) return "Approaching expectations";
    if (totalMarks >= 401 && totalMarks <= 600) return "Meeting expectations";
    if (totalMarks >= 601 && totalMarks <= 800) return "Exceeding expectations";
    return "";
}
function printGroupedTable(grade) {
    const schoolName = document.getElementById("schoolName").value || "School Name";
    const year = document.getElementById("year").value || "Year";
    const term = document.getElementById("term").value || "Term";

    const table = document.getElementById(`groupedTable-${grade}`).outerHTML;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Grouped Learners for Grade ${grade}</title>
                <style>
                    body { font-family: Arial, sans-serif; }
                    .header-info { text-align: left; margin-bottom: 20px; font-weight: bold; }
                    .learners-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                    .learners-table th, .learners-table td { border: 2px solid black; padding: 10px; text-align: center; }
                </style>
            </head>
            <body>
                <div class="header-info">
                    <p>School: ${schoolName}</p>
                    <p>Grade: ${grade}</p>
                    <p>Year: ${year}</p>
                    <p>Term: ${term}</p>
                </div>
                ${table}
            </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.print();

     
        }

function showSubjectChampions() {
    // Create modal wrapper
    const modal = document.createElement('div');
    modal.id = "subjectChampionsModal";
    modal.style.cssText = `
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    `;

    // Modal content
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: white;
        padding: 20px;
        border-radius: 10px;
        width: 300px;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    `;

    modalContent.innerHTML = `
        <h3 style="color: #4CAF50; margin-bottom: 15px;">Enter Grade</h3>
        <input type="text" id="gradeInput" placeholder="e.g., 6" 
            style="padding: 10px; width: 80%; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc;" />
        <br>
        <button style="background: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 5px; margin-right: 10px;"
            onclick="generateChampionsFromManualInput()">Generate</button>
        <button style="background: #f44336; color: white; padding: 10px 15px; border: none; border-radius: 5px;"
            onclick="document.getElementById('subjectChampionsModal').remove()">Cancel</button>
    `;

    modal.appendChild(modalContent);
    document.body.appendChild(modal);
}
function generateChampionsFromManualInput() {
    const grade = document.getElementById("gradeInput").value.trim();
    if (!grade) {
        alert("Please enter a grade.");
        return;
    }

    document.getElementById("subjectChampionsModal").remove();

    const filteredMarks = marks.filter(mark => mark.grade == grade);
    if (filteredMarks.length === 0) {
        alert("No data found for Grade " + grade);
        return;
    }

    const champions = filteredMarks.reduce((acc, mark) => {
        mark.scores.forEach((score, index) => {
            const subjects = [
                'English', 'Mathematics', 'Pre-Technical Studies', 
                'Kiswahili', 'Integrated Science', 'Social Studies', 
                'Agriculture', 'Religious Education', 'Creative Art'
            ];
            const subject = subjects[index];
            if (!acc[subject] || score > acc[subject].score) {
                acc[subject] = { name: mark.learner, score };
            }
        });
        return acc;
    }, {});

    function getPerformanceLevel(score) {
        if (score >= 0 && score <= 25) return "Level 1 (BE)";
        if (score >= 26 && score <= 49) return "Level 2 (AE)";
        if (score >= 50 && score <= 75) return "Level 3 (ME)";
        if (score >= 76 && score <= 100) return "Level 4 (EE)";
        return "Invalid Score";
    }

    let championsHtml = `<h3 style="color: #4CAF50; text-align: center;">Subject Champions - Grade ${grade}</h3>`;
    championsHtml += `<table style="width: 100%; border-collapse: collapse; text-align: center; margin-top: 10px; background-color: #e6f7ff;">
                        <thead>
                            <tr style="background-color: #f2f2f2;">
                                <th style="padding: 10px; border: 1px solid black;">No.</th>
                                <th style="padding: 10px; border: 1px solid black;">Subject</th>
                                <th style="padding: 10px; border: 1px solid black;">Champion</th>
                                <th style="padding: 10px; border: 1px solid black;">Score</th>
                                <th style="padding: 10px; border: 1px solid black;">Performance Level</th>
                            </tr>
                        </thead>
                        <tbody>`;

    let number = 1;
    for (const subject in champions) {
        const { name, score } = champions[subject];
        const level = getPerformanceLevel(score);
        championsHtml += `<tr>
                            <td style="padding: 10px; border: 1px solid black;">${number++}</td>
                            <td style="padding: 10px; border: 1px solid black;">${subject}</td>
                            <td style="padding: 10px; border: 1px solid black;">${name}</td>
                            <td style="padding: 10px; border: 1px solid black;">${score}</td>
                            <td style="padding: 10px; border: 1px solid black;">${level}</td>
                          </tr>`;
    }

    championsHtml += `</tbody></table>`;

    const reportDiv = document.getElementById("report");
    reportDiv.innerHTML = championsHtml;

    const championNames = Object.values(champions).map(c => c.name).join(", ");
    showCelebration(`Congratulations to our Champions: ${championNames}!`, 7000);
}

  // 2) Updated ranking function with inline styling
  async function showSubjectRanking() {
    const grade = await promptForGradeCustom('Enter grade for Subject Rankings:');
    if (grade === null) return;  // user cancelled

    const filtered = marks.filter(m => m.grade === grade);
    if (filtered.length === 0) {
      alert(`No records found for grade ${grade}.`);
      return;
    }

    // Build per-subject lists
    const rankings = filtered.reduce((acc, mark) => {
      mark.scores.forEach((score, idx) => {
        const subjects = [
          'English','Mathematics','Pre-Technical Studies',
          'Kiswahili','Integrated Science','Social Studies',
          'Agriculture','Religious Education','Creative Art'
        ];
        const subj = subjects[idx];
        acc[subj] = acc[subj] || [];
        acc[subj].push({ name: mark.learner, score });
      });
      return acc;
    }, {});

    // Sort descending
    for (let subj in rankings) {
      rankings[subj].sort((a,b) => b.score - a.score);
    }

    // Level helper
    function getPerformanceLevel(score) {
      if (score <= 25)  return "Level 1 (BE)";
      if (score <= 49)  return "Level 2 (AE)";
      if (score <= 75)  return "Level 3 (ME)";
      if (score <= 100) return "Level 4 (EE)";
      return "Invalid Score";
    }

    // Render HTML
    let html = `<h3 style="color:#4CAF50;text-align:center;
                            margin-bottom:16px;">
                  Subject Rankings  Grade ${grade}
                </h3>`;
    for (let subj in rankings) {
      html += `<h4 style="color:#2E86C1;margin-top:16px;">${subj}</h4>
               <table class="learners-table"
                      style="width:100%;border-collapse:collapse;
                             text-align:center;margin-bottom:24px;">
                 <thead>
                   <tr style="background:#f2f2f2;">
                     <th style="padding:8px;border:1px solid #ddd;">Rank</th>
                     <th style="padding:8px;border:1px solid #ddd;">Name</th>
                     <th style="padding:8px;border:1px solid #ddd;">Score</th>
                     <th style="padding:8px;border:1px solid #ddd;">Level</th>
                   </tr>
                 </thead>
                 <tbody>`;
      rankings[subj].forEach((ent,i) => {
        html += `<tr>
                   <td style="padding:6px;border:1px solid #ddd;">${i+1}</td>
                   <td style="padding:6px;border:1px solid #ddd;">${ent.name}</td>
                   <td style="padding:6px;border:1px solid #ddd;">${ent.score}</td>
                   <td style="padding:6px;border:1px solid #ddd;">
                     ${getPerformanceLevel(ent.score)}
                   </td>
                 </tr>`;
      });
      html += `</tbody></table>`;
    }

    document.getElementById('report').innerHTML = html;
  }

 function printSubjectChampions() {
    // Retrieve input values
    const schoolName = document.getElementById("schoolName").value || "School Name";
    const gradeLevel = document.getElementById("gradeLevel").value || "Grade";
    const year = document.getElementById("year").value || "Year";
    const term = document.getElementById("term").value || "Term";

    // Generate the subject champions content
    const reportDiv = document.getElementById("report");
    const championsHtml = reportDiv.innerHTML;

    // Open a new window for printing and inject the HTML with the input data at the top
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Subject Champions</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                    }
                    .learners-table, .learners-table th, .learners-table td {
                        border: 2px solid black;
                        padding: 10px;
                        text-align: center;
                        border-collapse: collapse;
                    }
                    .header-info {
                        text-align: left;
                        margin-bottom: 20px;
                        font-weight: bold;
                    }
                    .stamp {
                        border: 2px solid blue;
                        color: blue;
                        text-align: center;
                        width: 200px;
                        height: 70px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 10px auto;
                        font-weight: bold;
                    }
                </style>
            </head>
            <body>
                <div class="header-info">
                    <p>School: ${schoolName}</p>
                    <p>Grade: ${gradeLevel}</p>
                    <p>Year: ${year}</p>
                    <p>Term: ${term}</p>
                </div>
                ${championsHtml}
                <div class="stamp">NACHU COMPREHENSIVE SCHOOL<br>561-00902 Kikuyu</div>
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();

        }

function printSubjectRanking() {
    // Retrieve dynamic information from input fields
    const schoolName = document.getElementById("schoolName").value || "School Name";
    const gradeLevel = document.getElementById("gradeLevel").value || "Grade";
    const year = document.getElementById("year").value || "Year";
    const term = document.getElementById("term").value || "Term";

    // Retrieve the content for Subject Rankings
    const reportDiv = document.getElementById("report");
    const rankingsHtml = reportDiv.innerHTML;

    // Open a new window to format and print the rankings content with visible borders
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Subject Rankings</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                    }
                    .header-info {
                        text-align: left;
                        margin-bottom: 20px;
                        font-weight: bold;
                    }
                    .learners-table {
                        width: 100%;
                        border-collapse: collapse;
                    }
                    .learners-table th, .learners-table td {
                        border: 2px solid black; /* Visible table borders for rows and columns */
                        padding: 10px;
                        text-align: center;
                    }
                    .stamp {
                        border: 2px solid blue;
                        color: blue;
                        text-align: center;
                        width: 200px;
                        height: 70px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 10px auto;
                        font-weight: bold;
                    }
                </style>
            </head>
            <body>
                <div class="header-info">
                    <p>School: ${schoolName}</p>
                    <p>Grade: ${gradeLevel}</p>
                    <p>Year: ${year}</p>
                    <p>Term: ${term}</p>
                </div>
                ${rankingsHtml}
                <div class="stamp">NACHU COMPREHENSIVE SCHOOL<br>561-00902 Kikuyu</div>
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
 
}
     function updateLearnerSelect() {
    const learnersWithoutMarks = learners.filter(learner =>
        !marks.some(mark => mark.learner === learner.name)
    );

    learnerSelect.innerHTML = learnersWithoutMarks.map(learner =>
        `<option value="${learner.name}">${learner.name} (Grade ${learner.grade})</option>`
    ).join("");

    if (learnersWithoutMarks.length === 0) {
        learnerSelect.innerHTML = `<option value="" disabled>No learners available</option>`;
    }
}

     
    document.getElementById("marksForm").addEventListener("submit", function (e) {
        e.preventDefault();
        // Existing logic for form submission...
        updateLearnerSelect(); // Refresh the dropdown after submission
    });

  function showLoadingSpinner() {
    document.getElementById("loadingSpinner").style.display = "block";
}

function hideLoadingSpinner() {
    document.getElementById("loadingSpinner").style.display = "none";
}
let currentOpenSection = null; // Global variable to track the currently open section

// Generic toggle function
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);

    // If there is an open section, hide it
    if (currentOpenSection && currentOpenSection !== section) {
        currentOpenSection.style.display = 'none';
    }

    // Toggle the clicked section
    if (section.style.display === 'none' || section.style.display === '') {
        section.style.display = 'block';
        currentOpenSection = section; // Update the current open section
    } else {
        section.style.display = 'none';
        currentOpenSection = null; // Reset if it's closed
    }
}
// Function to toggle archived tables and button text
function toggleArchives() {
    const archivesSection = document.getElementById("archivesSection");
    const toggleButton = document.querySelector("button[onclick='toggleArchives()']"); // Select the button

    if (archivesSection.style.display === "none" || archivesSection.style.display === "") {
        archivesSection.style.display = "block"; // Show archives
        toggleButton.textContent = "Hide Archived"; // Change button text
    } else {
        archivesSection.style.display = "none"; // Hide archives
        toggleButton.textContent = "View Archived"; // Change button text
    }
}
function showTables() {
    // List of IDs for the sections/tables to show
    const elementsToShow = [
        "report", // ID for Assessment Report
        "archivesSection" // ID for Archived Marks
    ];

    // Show each element in the list
    elementsToShow.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = "block"; // Change from 'none' to 'block'
            console.log(`Showing element with ID: ${id}`);
        } else {
            console.warn(`No element found with ID: ${id}`);
        }
    });

    alert("All tables and sections have been displayed!");
}
function printSelectedOption() {
    const selectedOption = document.getElementById("printOption").value;

    switch (selectedOption) {
        case "assessmentReport":
            printAssessmentReport();
            break;
        case "subjectChampions":
            printSubjectChampions();
            break;
        case "subjectRanking":
            printSubjectRanking();
            break;
        case "subjectPerformance":
            printSubjectPerformance();
            break;
        case "subjectDeviation":
            printSubjectDeviationReport();
            break;
        case "scoreDeviations":
            printScoreDeviations();
            break;
        case "genderPerformance": // New case for gender performance
            printGenderPerformance(); // Add your gender performance printing function here
            break;
        default:
            alert("Please select a valid option to print.");
    }
}


  let parents = JSON.parse(localStorage.getItem("parents")) || []; // Load parents from storage

    // Function to update the table with registered parents
    function updateParentTable(searchQuery = "") {
        const parentTableBody = document.getElementById("parentTableBody");

        // Filter parents based on the search query
        const filteredParents = parents.filter(parent => 
            parent.name.toLowerCase().includes(searchQuery.toLowerCase()) || 
            parent.grade.toString().includes(searchQuery)
        );

        // Sort parents by grade (Grade 1 to 12)
        filteredParents.sort((a, b) => a.grade - b.grade);

        // Populate the table
        parentTableBody.innerHTML = filteredParents.map((parent, index) => `
            <tr>
                <td>${index + 1}</td>
                <td>${parent.name}</td>
                <td>${parent.phone}</td>
                <td>Grade ${parent.grade}</td>
                <td>
                    <button onclick="deleteParent(${index})">Delete</button>
                </td>
            </tr>
        `).join("");
    }

    // Event listener for parent form submission
    document.getElementById("parentForm").addEventListener("submit", function (e) {
        e.preventDefault();

        // Capture parent details
        const parent = {
            name: document.getElementById("parentsName").value,
            phone: document.getElementById("parentPhone").value,
            grade: document.getElementById("parentGrade").value
        };

        // Add the parent to the list
        parents.push(parent);

        // Save parents to local storage
        localStorage.setItem("parents", JSON.stringify(parents));

        // Update the table and reset the form
        updateParentTable();
        this.reset();
     // Display success message
            showAlert('Parent registered successfully!', 'success');
    });

    // Function to delete a parent entry
    function deleteParent(index) {
        if (confirm("Are you sure you want to delete this parent?")) {
            parents.splice(index, 1); // Remove parent from the list
            localStorage.setItem("parents", JSON.stringify(parents)); // Update storage
            updateParentTable(); // Refresh table
        }

  }

    // Initialize the table on page load
    document.addEventListener("DOMContentLoaded", () => updateParentTable());
    let staff = JSON.parse(localStorage.getItem("staff")) || []; // Load staff data from local storage

    // Function to update the staff table
    function updateStaffTable(searchQuery = "") {
        const staffTableBody = document.getElementById("staffTableBody");

        // Filter staff based on the search query
        const filteredStaff = staff.filter(member =>
            member.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
            member.position.toLowerCase().includes(searchQuery.toLowerCase()) ||
            member.grade.toString().includes(searchQuery)
        );

        // Populate the table
        staffTableBody.innerHTML = filteredStaff.map((member, index) => `
            <tr>
                <td>${index + 1}</td>
                <td>${member.name}</td>
                <td>${member.phone}</td>
                <td>${member.position}</td>
                <td>Grade ${member.grade}</td>
                <td>
                    <button onclick="deleteStaff(${index})">Delete</button>
                </td>
            </tr>
        `).join("");
    }

    // Event listener for staff form submission
    document.getElementById("staffForm").addEventListener("submit", function (e) {
        e.preventDefault();

        // Capture staff details
        const member = {
            name: document.getElementById("staffName").value,
            phone: document.getElementById("staffPhone").value,
            position: document.getElementById("staffPosition").value,
            grade: document.getElementById("staffGrade").value
        };

        // Add the staff member to the list
        staff.push(member);

        // Save staff data to local storage
        localStorage.setItem("staff", JSON.stringify(staff));

        // Update the table and reset the form
        updateStaffTable();
        this.reset();
      // Display success message
            showAlert('Staff registered successfully!', 'success');

    });

    // Function to delete a staff member entry
    function deleteStaff(index) {
        if (confirm("Are you sure you want to delete this staff member?")) {
            staff.splice(index, 1); // Remove staff member from the list
            localStorage.setItem("staff", JSON.stringify(staff)); // Update storage
            updateStaffTable(); // Refresh table
        }
    }

  
 // Function to display a custom prompt box for input and print the staff table
function printStaffTable() {
    // Create the custom prompt box
    const promptBox = document.createElement('div');
    promptBox.style.position = 'fixed';
    promptBox.style.top = '0';
    promptBox.style.left = '0';
    promptBox.style.width = '100%';
    promptBox.style.height = '100%';
    promptBox.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
    promptBox.style.display = 'flex';
    promptBox.style.justifyContent = 'center';
    promptBox.style.alignItems = 'center';
    promptBox.style.zIndex = '9999';

    // Create the inner modal content
    const modal = document.createElement('div');
    modal.style.backgroundColor = '#fff';
    modal.style.padding = '20px';
    modal.style.borderRadius = '8px';
    modal.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
    modal.style.textAlign = 'center';
    modal.style.width = '300px';

    // Create the inputs for school name, year, and date
    const schoolNameInput = createInputField('School Name:', 'schoolName', '2E8B57'); // Green
    const yearInput = createInputField('Year:', 'year', 'FF6347'); // Red
    const dateInput = createInputField('Date:', 'date', '1E90FF'); // Blue

    // Append inputs and button to the modal
    modal.appendChild(schoolNameInput.label);
    modal.appendChild(schoolNameInput.input);
    modal.appendChild(document.createElement('br'));
    modal.appendChild(yearInput.label);
    modal.appendChild(yearInput.input);
    modal.appendChild(document.createElement('br'));
    modal.appendChild(dateInput.label);
    modal.appendChild(dateInput.input);
    modal.appendChild(document.createElement('br'));
    const submitButton = document.createElement('button');
    submitButton.textContent = 'Submit';
    submitButton.style.marginTop = '20px';
    submitButton.style.padding = '10px 20px';
    submitButton.style.backgroundColor = '#4CAF50';
    submitButton.style.color = '#fff';
    submitButton.style.border = 'none';
    submitButton.style.borderRadius = '4px';
    modal.appendChild(submitButton);

    // Append modal to prompt box
    promptBox.appendChild(modal);
    document.body.appendChild(promptBox);

    // Handle form submission
    submitButton.onclick = function () {
        const schoolName = schoolNameInput.input.value;
        const year = yearInput.input.value;
        const date = dateInput.input.value;

        if (!schoolName || !year || !date) {
            alert("Please provide all the details (School Name, Year, and Date) to proceed with printing.");
            return;
        }

        // Close the prompt box
        document.body.removeChild(promptBox);

        // Get the staff table HTML content
        const table = document.getElementById("staffTable").outerHTML;

        // Open a new print window
        const printWindow = window.open("", "_blank");

        // Write the content for printing including the prompt details
        printWindow.document.write(`
            <html>
                <head>
                    <title>Registered Staff</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f9f9f9; }
                        table { width: 100%; border-collapse: collapse; background-color: #ffffff; }
                        th, td { border: 1px solid #dddddd; padding: 8px; text-align: center; }
                        th { background-color: #4CAF50; color: white; font-size: 16px; } /* Set header background and text color */
                        td { font-size: 14px; color: #333333; }
                        .header-info { font-weight: bold; margin-bottom: 20px; font-size: 16px; color: #2C3E50; }
                        h1 { color: #2C3E50; font-size: 18px; }
                        p { font-size: 14px; }
                        .school-name { color: #2E8B57; font-weight: bold; }
                        .year { color: #FF6347; font-weight: bold; }
                        .date { color: #1E90FF; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="header-info">
                        <p><strong>School:</strong> <span class="school-name">${schoolName}</span></p>
                        <p><strong>Year:</strong> <span class="year">${year}</span></p>
                        <p><strong>Date:</strong> <span class="date">${date}</span></p>
                    </div>
                    <h1>Registered Staff</h1>
                    ${table}
                </body>
            </html>
        `);

        // Close the document and trigger the print dialog
        printWindow.document.close();
        printWindow.print();
    };

    // Function to create input fields with labels and colors
    function createInputField(labelText, id, color) {
        const label = document.createElement('label');
        label.textContent = labelText;
        label.style.color = `#${color}`;
        label.style.fontWeight = 'bold';

        const input = document.createElement('input');
        input.type = 'text';
        input.id = id;
        input.style.padding = '8px';
        input.style.margin = '5px 0';
        input.style.border = '1px solid #ccc';
        input.style.borderRadius = '4px';

        return { label, input };
    }
}


    function printTable(content) {
        const printWindow = window.open("", "_blank");
        printWindow.document.write(`
            <html>
                <head>
                    <title>Print</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { 
                            border: 2px solid black; 
                            padding: 8px; 
                            text-align: center; 
                        }
                        th { 
                            background-color: #4CAF50; 
                            color: white; 
                            font-weight: bold; 
                        }
                        td { 
                            font-size: 14px; 
                            font-weight: normal; 
                        }
                        h2, h3, p { margin: 0; padding: 5px; }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }

    function hideDeleteButtons() {
        document.querySelectorAll("button").forEach(button => {
            if (button.textContent.trim() === "Delete") {
                button.style.display = "none";
            }
        });
    }

    function showDeleteButtons() {
        document.querySelectorAll("button").forEach(button => {
            if (button.textContent.trim() === "Delete") {
                button.style.display = "inline-block";
            }
        });
    }


    // Function to search staff
    function searchStaff() {
        const searchQuery = document.getElementById("searchStaff").value;
        updateStaffTable(searchQuery);
    }
    // Initialize the staff table on page load
    document.addEventListener("DOMContentLoaded", () => updateStaffTable());
const reportDiv = document.getElementById("report");
const footer = document.getElementById("footer");

// Ensure reportDiv is before footer
footer.parentNode.insertBefore(reportDiv, footer);

 const schoolEmail = "info@QUEENOFROSARYCOMPREHENSIVESCHOOL.com"; // School email address
function registerSupportStaff() {
    const fields = {
        staffId: document.getElementById("supportStaffId").value,
        name: document.getElementById("supportStaffName").value,
        phone: document.getElementById("supportStaffPhone").value,
        position: document.getElementById("supportStaffPosition").value,
        hireDate: document.getElementById("supportStaffHireDate").value,
        photoFile: document.getElementById("supportStaffPhoto").files[0],
    };

    // Validate fields
    for (const [key, value] of Object.entries(fields)) {
        if (!value) {
            alert(`Please fill in the ${key.replace("photoFile", "photo")}.`);
            return;
        }
    }

    const reader = new FileReader();
    reader.onload = function (event) {
        const photo = event.target.result;

        const supportStaffList = getSupportStaffList();

        // Check for duplicate Staff ID
        if (supportStaffList.some(staff => staff.staffId === fields.staffId)) {
            alert("Staff with this ID already exists.");
            return;
        }

        // Add new staff
        const newStaff = {
            staffId: fields.staffId,
            name: fields.name,
            phone: fields.phone,
            position: fields.position,
            hireDate: fields.hireDate,
            photo,
        };
        supportStaffList.push(newStaff);
        saveSupportStaffList(supportStaffList);

        updateSupportStaffTable();
        document.getElementById("supportStaffForm").reset();
        showFeedbackMessage("Support staff registered successfully!", "success");
    };

    reader.readAsDataURL(fields.photoFile);
}

// Function to retrieve the staff list from localStorage
function getSupportStaffList() {
    return JSON.parse(localStorage.getItem("supportStaff")) || [];
}

// Function to save the staff list to localStorage
function saveSupportStaffList(supportStaffList) {
    localStorage.setItem("supportStaff", JSON.stringify(supportStaffList));
}

// Function to update the support staff table
function updateSupportStaffTable() {
    const supportStaffTableBody = document.getElementById("supportStaffTableBody");
    const supportStaffList = getSupportStaffList();
    supportStaffTableBody.innerHTML = "";

    supportStaffList.forEach((staff, index) => {
        const row = `
            <tr>
                <td>${index + 1}</td>
                <td>${staff.staffId}</td>
                <td>${staff.name}</td>
                <td>${staff.phone}</td>
                <td>${staff.position}</td>
                <td>${staff.hireDate}</td>
                <td><img src="${staff.photo}" alt="Staff Photo" class="staff-photo"></td>
                <td>
                    <button onclick="generateIdCard('${staff.staffId}')">Generate ID</button>
                    <button onclick="deleteStaff('${staff.staffId}')">Delete</button>
                    <button onclick="printIdCard('${staff.staffId}')">Print</button>
                </td>
            </tr>
        `;
        supportStaffTableBody.innerHTML += row;
    });
}

// Function to show feedback messages
function showFeedbackMessage(message, type = "success") {
    const feedback = document.createElement("div");
    feedback.textContent = message;
    feedback.style.color = type === "success" ? "green" : "red";
    feedback.style.fontWeight = "bold";
    feedback.style.marginTop = "10px";
    feedback.style.transition = "opacity 0.3s";
    document.querySelector(".form-container").appendChild(feedback);

    setTimeout(() => feedback.remove(), 3000);
}
    // Delete Staff
    function deleteStaff(staffId) {
        let supportStaffList = JSON.parse(localStorage.getItem("supportStaff")) || [];
        supportStaffList = supportStaffList.filter(staff => staff.staffId !== staffId);
        localStorage.setItem("supportStaff", JSON.stringify(supportStaffList));

        updateSupportStaffTable();
    }

  // Generate ID Card
    function generateIdCard(staffId) {
        const supportStaffList = JSON.parse(localStorage.getItem("supportStaff")) || [];
        const staff = supportStaffList.find(staff => staff.staffId === staffId);

        if (!staff) {
            alert("Staff member not found!");
            return;
        }

        const idCardHtml = `
            <div class="id-card">
                <div class="header">
                    <h1> Nachu Junior School </h1>
                    <p class="school-tagline">"Excellence and Integrity"</p>
                </div>
                <div class="id-card-content">
                    <img src="${staff.photo}" alt="Staff Photo" class="id-card-photo">
                    <h2>Support Staff ID Card</h2>
                    <p><strong>Name:</strong> ${staff.name}</p>
                    <p><strong>Position:</strong> ${staff.position}</p>
                    <p><strong>Staff ID:</strong> ${staff.staffId}</p>
                    <p><strong>Phone:</strong> ${staff.phone}</p>
                    <p><strong>Date of Hire:</strong> ${staff.hireDate}</p>
                </div>
                <div class="id-card-footer">
                    This ID is generated from online powered by RASM.
                    <p class="school-email">Email: ${schoolEmail}</p>
                </div>
            </div>
        `;

        document.getElementById("generatedIdCardContainer").innerHTML = idCardHtml;
    }

    // Print ID Card
    function printIdCard(staffId) {
        const supportStaffList = JSON.parse(localStorage.getItem("supportStaff")) || [];
        const staff = supportStaffList.find(staff => staff.staffId === staffId);

        if (!staff) {
            alert("Staff member not found!");
            return;
        }

        const printWindow = window.open("", "Print", "width=600,height=400");
        printWindow.document.write(`
            <html>
                <head>
                    <title>Print ID Card</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        .id-card {
                            width: 350px;
                            border: 2px solid #007bff;
                            padding: 20px;
                            background-color: #e0f7fa;
                            margin: 20px auto;
                            border-radius: 10px;
                            text-align: center;
                        }
                        .header {
                            background-color: #007bff;
                            color: white;
                            padding: 15px;
                            border-radius: 10px 10px 0 0;
                        }
                        .id-card-content h2 {
                            font-size: 20px;
                            color: #007bff;
                        }
                        .school-email {
                            font-size: 10px;
                            color: #007bff;
                            margin-top: 10px;
                        }
                    </style>
                </head>
                <body>
                    <div class="id-card">
                        <div class="header">
                            <h1>NACHU COMPREHENSIVE SCHOOL</h1>
                            <p class="school-tagline">"Excellence and Integrity"</p>
                        </div>
                        <div class="id-card-content">
                            <img src="${staff.photo}" alt="Staff Photo" style="width:100px;height:100px;border-radius:50%;border:2px solid #007bff;">
                            <h2>Support Staff ID Card</h2>
                            <p><strong>Name:</strong> ${staff.name}</p>
                            <p><strong>Position:</strong> ${staff.position}</p>
                            <p><strong>Staff ID:</strong> ${staff.staffId}</p>
                            <p><strong>Phone:</strong> ${staff.phone}</p>
                            <p><strong>Date of Hire:</strong> ${staff.hireDate}</p>
                        </div>
                        <div class="id-card-footer">
                            This ID is generated from online powered by RASM.
                            <p class="school-email">Email: ${schoolEmail}</p>
                        </div>
                    </div>
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }

    // CSS for success message
    const style = document.createElement("style");
    style.innerHTML = `
        .success-message {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            margin-top: 10px;
            text-align: center;
            border-radius: 5px;
            font-weight: bold;
        }
    `;
    document.head.appendChild(style);

// Function to print the support staff list
function printSupportStaffList() {
    const table = document.getElementById("supportStaffTable").outerHTML;

    // URL or base64 string of your logo
    const logoUrl = " https://i.imgur.com/UW65hfv.png"; // Replace with your logo's URL or base64 string

    const printWindow = window.open("", "_blank");
    printWindow.document.write(`
        <html>
            <head>
                <title>Support Staff List</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h1 { text-align: center; margin-bottom: 20px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid black; padding: 8px; text-align: center; }
                    th { background-color: #f2f2f2; font-size: 16px; }
                    td { font-size: 14px; }
                    .logo { display: block; margin: 0 auto; width: 100px; height: auto; }
                </style>
            </head>
            <body>
                <img src="${logoUrl}" class="logo" alt="School Logo">
                <h1>Registered Support Staff</h1>
                ${table}
            </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.print();
}

// Function to toggle visibility of the registration section
function toggleRegisterSupportStaff() {
    const registerSection = document.getElementById("supportStaffRegistrationSection");
    const viewSection = document.getElementById("supportStaffListSection");

    // Show the registration section and hide the view section
    registerSection.style.display = registerSection.style.display === "none" ? "block" : "none";
    viewSection.style.display = "none";
}

// Function to toggle visibility of the view section
function toggleViewSupportStaff() {
    const registerSection = document.getElementById("supportStaffRegistrationSection");
    const viewSection = document.getElementById("supportStaffListSection");

    // Show the view section and hide the registration section
    viewSection.style.display = viewSection.style.display === "none" ? "block" : "none";
    registerSection.style.display = "none";
}

// Function to remove a learner
function removeLearner(index) {
    learners.splice(index, 1); // Remove the learner from the array
    updateLearnersTable(); // Update the table to reflect changes
    localStorage.setItem('learners', JSON.stringify(learners)); // Persist changes in local storage

}

// Function to update the learners table after deletion
function updateLearnersTable() {
    const learnersList = document.getElementById("learnersList");
    learnersList.innerHTML = learners.map((learner, index) => `
        <tr>
          <td>${index + 1}</td> <!-- Serial Number -->
            <td><img src="${learner.photo}" alt="Photo" width="50" height="50"></td>
            <td contenteditable="true">${learner.name}</td>
            <td contenteditable="true">${learner.gender}</td>
            <td contenteditable="true">${learner.grade}</td>
            <td contenteditable="true">${learner.age}</td>
            <td contenteditable="true">${learner.parentName}</td>
            <td contenteditable="true">${learner.phone}</td>
            <td contenteditable="true">${learner.birthCertificateNo}</td>
            <td contenteditable="true">${learner.admissionNumber}</td>
            <td><button onclick="confirmDeleteLearner(${index})">Remove</button></td>
        </tr>
    `).join("");
}


document.getElementById("marksForm").addEventListener("submit", function (e) {
    e.preventDefault();

    // Capture form data
    const learnerName = document.getElementById("learnerSelect").value;
    const grade = document.getElementById("marksGrade").value;
    const english = parseInt(document.getElementById("english").value);
    const math = parseInt(document.getElementById("math").value);
    const preTech = parseInt(document.getElementById("preTech").value);
    const kiswahili = parseInt(document.getElementById("kiswahili").value);
    const science = parseInt(document.getElementById("science").value);
    const social = parseInt(document.getElementById("social").value);
    const agriculture = parseInt(document.getElementById("agriculture").value);
    const religion = parseInt(document.getElementById("religion").value);
    const art = parseInt(document.getElementById("art").value);

    // Validate marks input
    const scores = [english, math, preTech, kiswahili, science, social, agriculture, religion, art];
    if (scores.some(score => score < 0 || score > 100)) {
        // Display error message
            showAlert("Please enter scores between 0 and 100.");
        return;
    
    }

    // Process marks submission
    const totalMarks = scores.reduce((acc, score) => acc + score, 0);
    const submittedMarks = {
        learner: learnerName,
        grade,
        scores,
        totalMarks
    };

    console.log("Submitted Marks:", submittedMarks); // Log or save the submitted data

    // Display success message
    const successMessage = document.getElementById("successMessage");
    successMessage.style.display = "block";

    // Hide the success message after 3 seconds
    setTimeout(() => {
        successMessage.style.display = "none";
    }, 3000);

    // Reset the form
    this.reset();
});
// Object to store original grades before promotion
let previousGrades = {};

// Function to promote learners
function promoteLearners() {
    console.log("Starting promotion process...");

    // Check if learners data exists
    if (!learners || learners.length === 0) {
        console.error("Learners data is not available.");
        alert("No learners available for promotion.");
        return;
    }

    // Iterate through learners and promote eligible ones
    learners.forEach((learner, index) => {
        console.log(`Processing learner: ${learner.name}, Grade: ${learner.grade}`);

        const gradeMatch = learner.grade.match(/^(\d+)([A-Z]*)$/);
        if (gradeMatch) {
            const currentGrade = parseInt(gradeMatch[1]);
            const stream = gradeMatch[2];
            console.log(`Current Grade: ${currentGrade}, Stream: ${stream}`);

            // Store the original grade before promotion
            if (!previousGrades[learner.name]) {
                previousGrades[learner.name] = learner.grade;
            }

            // Promote learners in grades 7, 8, and 9
            if (currentGrade >= 7 && currentGrade <= 9) {
                const newGrade = (currentGrade + 1) + stream;
                learner.grade = newGrade;
                console.log(`Promoted to: ${learner.grade}`);
            }
        } else {
            console.warn(`Grade format not recognized for learner: ${learner.name}`);
        }
    });

    // Update storage and UI
    if (useIndexedDB) {
        saveLearnersToIndexedDB();
    } else {
        saveLearnersToLocalStorage();
    }
    updateLearnersTable();

    // Display success message
    const promotionMessage = document.getElementById('promotionMessage');
    if (promotionMessage) {
        promotionMessage.style.display = 'block';
        setTimeout(() => {
            promotionMessage.style.display = 'none';
        }, 3000);
    } else {
        alert("Eligible learners have been promoted to the next grade!");
    }
}

// Function to undo promotion
function undoPromotion() {
    console.log("Undoing promotion...");

    if (Object.keys(previousGrades).length === 0) {
        alert("No previous promotion records found!");
        return;
    }

    // Iterate and revert grades
    learners.forEach(learner => {
        if (previousGrades[learner.name]) {
            learner.grade = previousGrades[learner.name]; // Restore original grade
            console.log(`Reverted ${learner.name} to ${learner.grade}`);
        }
    });

    // Update storage and UI
    if (useIndexedDB) {
        saveLearnersToIndexedDB();
    } else {
        saveLearnersToLocalStorage();
    }
    updateLearnersTable();

    // Clear the stored previous grades
    previousGrades = {};

    alert("Promotion undone successfully!");
}
// Helper to detect storage type
const useIndexedDB = window.indexedDB ? true : false;

// Save to IndexedDB
function saveLearnersToIndexedDB() {
    const request = indexedDB.open("LearnersDB", 1);

    request.onsuccess = function (event) {
        const db = event.target.result;
        const transaction = db.transaction(["learners"], "readwrite");
        const objectStore = transaction.objectStore("learners");

        // Save each learner
        learners.forEach(learner => objectStore.put(learner));

        transaction.oncomplete = function () {
            console.log("Learners data updated in IndexedDB.");
        };

        transaction.onerror = function (event) {
            console.error("Error updating IndexedDB:", event.target.error);
        };
    };

    request.onerror = function (event) {
        console.error("Error opening IndexedDB:", event.target.error);
    };
}

// Save to localStorage
function saveLearnersToLocalStorage() {
    try {
        localStorage.setItem('learners', JSON.stringify(learners));
        console.log("Learners data saved to localStorage.");
    } catch (error) {
        console.error("Error saving to localStorage:", error);
    }
}


function groupLearnersByGender() {
    const groupedByGender = learners.reduce((groups, learner) => {
        if (!groups[learner.gender]) {
            groups[learner.gender] = [];
        }
        groups[learner.gender].push(learner);
        return groups;
    }, {});

    let genderHtml = '';
    for (const gender in groupedByGender) {
        genderHtml += `
            <h3>${gender}</h3>
            <table class="learners-table">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Photo</th>
                        <th>Name</th>
                        <th>Gender</th>
                        <th>Grade</th>
                        <th>Age</th>
                       <th>Parent Name</th>
                        <th>Parent Phone No</th>
                        <th>Birth Certificate No</th>
                        <th>Admission Number</th>
                    </tr>
                </thead>
                <tbody>
                    ${groupedByGender[gender].map((learner, index) => `
                        <tr>
                            <td>${index + 1}</td> 
<td><img src="${learner.photo}" alt="Photo" width="50" height="50"></td>
<td>${learner.name}</td>
<td>${learner.gender}</td>
<td>${learner.grade}</td>
<td>${learner.age}</td>
<td>${learner.parentName}</td>
<td>${learner.phone}</td>
<td>${learner.birthCertificateNo}</td>
<td>${learner.admissionNumber}</td>

                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    document.getElementById('groupedByGender').innerHTML = genderHtml;

    // Display success message
    const genderGroupMessage = document.getElementById("genderGroupMessage");
    genderGroupMessage.style.display = "block";
    setTimeout(() => {
        genderGroupMessage.style.display = "none";
    }, 3000);
}
function groupLearnersByGrade() {
    const groupedLearners = learners.reduce((groups, learner) => {
        if (!groups[learner.grade]) {
            groups[learner.grade] = [];
        }
        groups[learner.grade].push(learner);
        return groups;
    }, {});

    let groupedHtml = '';
    for (const grade in groupedLearners) {
        groupedHtml += `
            <h3>Grade: ${grade}</h3>
            <button onclick="saveGroupedChanges('${grade}')">Save Changes</button>
            <button onclick="printGroupedTable('${grade}')">Print Table</button>
            <table class="learners-table" id="groupedTable-${grade}">
                <thead>
                    <tr>
                       <th>No.</th>
                        <th>Photo</th>
                        <th>Name</th>
                        <th>Gender</th>
                        <th>Grade</th>
                        <th>Age</th>
                       <th>Parent Name</th>
                        <th>Parent Phone No</th>
                        <th>Birth Certificate No</th>
                        <th>Admission Number</th>
                    </tr>
                </thead>
                <tbody>
                    ${groupedLearners[grade].map((learner, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td><img src="${learner.photo}" alt="Photo" width="50" height="50"></td>
                           <td>${learner.name}</td>
<td>${learner.gender}</td>
<td>${learner.grade}</td>
<td>${learner.age}</td>
<td>${learner.parentName}</td>
<td>${learner.phone}</td>
<td>${learner.birthCertificateNo}</td>
<td>${learner.admissionNumber}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    document.getElementById('groupedLearners').innerHTML = groupedHtml;

    // Display success message
    const gradeGroupMessage = document.getElementById("gradeGroupMessage");
    gradeGroupMessage.style.display = "block";
    setTimeout(() => {
        gradeGroupMessage.style.display = "none";
    }, 3000);
}
function showAlert(message, type = 'success') {
    // Create the alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;

    // Append to the body
    document.body.appendChild(alertDiv);

    // Show the alert
    alertDiv.style.display = 'block';

    // Remove the alert after 3 seconds
    setTimeout(() => {
        alertDiv.style.display = 'none';
        document.body.removeChild(alertDiv);
    }, 3000);
}

  function showAlert(message, type = 'success') {
            // Create the alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;

            // Append to the body
            document.body.appendChild(alertDiv);

            // Show the alert
            alertDiv.style.display = 'block';

            // Remove the alert after 3 seconds
            setTimeout(() => {
                alertDiv.style.display = 'none';
                document.body.removeChild(alertDiv);
            }, 3000);
        }
function displayMessage() {
    document.getElementById('messageContainer').innerHTML = `
        <p style="color: green; font-weight: bold;">All tables and sections have been displayed!</p>
        <p style="color: red; font-weight: bold;">No archived marks available.</p>
    `;
}
    // Print Entire Support Staff Table
    function printSupportStaffTable() {
        const supportStaffList = JSON.parse(localStorage.getItem("supportStaff")) || [];

        if (supportStaffList.length === 0) {
            alert("No support staff to print.");
            return;
        }

        const tableHtml = `
            <html>
                <head>
                    <title>Support Staff List</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                        }
                        table th, table td {
                            border: 1px solid #ddd;
                            padding: 10px;
                            text-align: center;
                        }
                        table th {
                            background-color: #4CAF50;
                            color: white;
                        }
                        table td img {
                            width: 50px;
                            height: 50px;
                            border-radius: 50%;
                            object-fit: cover;
                        }
                    </style>
                </head>
                <body>
                    <h1>Support Staff List -Nachu Junior School  </h1>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Staff ID</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Position</th>
                                <th>Hire Date</th>
                                <th>Photo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${supportStaffList.map((staff, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${staff.staffId}</td>
                                    <td>${staff.name}</td>
                                    <td>${staff.phone}</td>
                                    <td>${staff.position}</td>
                                    <td>${staff.hireDate}</td>
                                    <td><img src="${staff.photo}" alt="Staff Photo"></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
            </html>
        `;

        // Open a new window and write the table HTML to it
        const printWindow = window.open("", "Print", "width=800,height=600");
        printWindow.document.write(tableHtml);
        printWindow.document.close();
        printWindow.print();
    }
function hideGeneratedReports() {
    // IDs of all sections that may display reports
    const reportSections = [
        "report",                // Assessment Report Section
        "subjectChampions",      // Subject Champions Section
        "subjectRanking",        // Subject Ranking Section
        "subjectPerformance",    // Subject Performance Section
        "juniorMarksEntrySection", // Junior Marks Entry Section
        "marksTableSection",     // Merit List Section
        "bulkReportGeneration"   // Bulk Report Generation Section
    ];

    // Hide all sections
    reportSections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
            section.style.display = "none";
        }
    });

    // Optionally, scroll to the top of the page or reset focus
    window.scrollTo(0, 0);
}

// Centralized Storage Key
const STORAGE_KEY = "schoolData";

// Initialize storage if not present
function initializeStorage() {
    const existingData = JSON.parse(localStorage.getItem(STORAGE_KEY));
    if (!existingData) {
        const initialData = {
            learners: [],
            marks: []
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(initialData));
    }
}

// Retrieve all data from storage
function getStorageData() {
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { learners: [], marks: [] };
}

// Update storage with new data
function updateStorage(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

// Load marks from storage
function loadMarks() {
    const data = getStorageData();
    marks = data.marks || [];
    updateMarksTable();
}

// Save marks to storage
function saveMarksToStorage() {
    const data = getStorageData();
    data.marks = marks;
    updateStorage(data);
}
function updateMarksTable() {
    // Sort the marks by totalMarks in descending order
    marks.sort((a, b) => b.totalMarks - a.totalMarks);

    let subjectTotals = Array(9).fill(0); // Initialize totals for each subject
    let totalMarksSum = 0; // To accumulate total marks for average calculation

    marksList.innerHTML = marks.map((mark, index) => {
        // Update totals for each subject
        mark.scores.forEach((score, idx) => subjectTotals[idx] += score);
        totalMarksSum += mark.totalMarks;

        return `
            <tr>
                <td>${index + 1}</td> <!-- Row Number -->
                <td>${mark.learner}</td>
                <td>${mark.grade}</td>
                ${mark.scores.map(score => `<td>${score}</td><td>${getLevel(score)}</td>`).join('')}
                <td style="font-weight:bold; border: 2px solid black;">${mark.totalMarks}</td>
                <td>
                    <button onclick="deleteMarks(${index})" class="circle-button">
                        <i class="fas fa-trash-alt"></i> Del
                    </button>
                </td>
            </tr>
        `;
    }).join("");

    // Calculate averages and add totals to the table
    const averages = subjectTotals.map(total => (total / marks.length).toFixed(2));
    const totalRow = `
        <tr>
            <td colspan="3" style="font-weight:bold;">Total</td>
            ${subjectTotals.map(total => `<td style="font-weight:bold;">${total}</td><td></td>`).join('')}
            <td style="font-weight:bold;">${totalMarksSum}</td>
        </tr>`;
    const averageRow = `
        <tr>
            <td colspan="3" style="font-weight:bold;">Average</td>
            ${averages.map(avg => `<td style="font-weight:bold;">${avg}</td><td></td>`).join('')}
            <td style="font-weight:bold;">${(totalMarksSum / marks.length).toFixed(2)}</td>
        </tr>`;

    marksList.innerHTML += totalRow + averageRow;

    // ? Refresh the grade filter dropdown
    populateGradeDropdown();
}


// Delete a mark entry
function deleteMarks(index) {
    marks.splice(index, 1); // Remove the mark entry at the specified index
    saveMarksToStorage(); // Save updated marks to storage
    updateMarksTable(); // Update the table to reflect changes
}

// Function to determine performance level
function getLevel(score) {
    if (score >= 75) return 4;
    if (score >= 50) return 3;
    if (score >= 25) return 2;
    if (score < 25) return 1;
    return 0; // Default level if score is invalid
}

// Event to initialize on DOM load
document.addEventListener("DOMContentLoaded", function() {
    initializeStorage(); // Ensure storage is initialized
    loadMarks(); // Load marks from storage
});
function generateGenderPerformance() {
    const marksTableBody = document.getElementById("marksList");
    const learnersTableBody = document.getElementById("learnersList");

    if (!marksTableBody || !learnersTableBody) {
        alert("Marks table or learners table not found.");
        return;
    }

    // Extract learners' details (Name, Gender)
    const learners = Array.from(learnersTableBody.querySelectorAll("tr")).map(row => {
        const cells = row.querySelectorAll("td");
        return {
            name: cells[2]?.textContent.trim(),
            gender: cells[3]?.textContent.trim().toLowerCase(),
        };
    });

    // Extract marks data
    const marks = Array.from(marksTableBody.querySelectorAll("tr")).map(row => {
        const cells = row.querySelectorAll("td");
        return {
            learner: cells[1]?.textContent.trim(),
            grade: cells[2]?.textContent.trim(),
            english: parseInt(cells[3]?.textContent.trim()) || 0,
            englishLevel: cells[4]?.textContent.trim() || "-",
            math: parseInt(cells[5]?.textContent.trim()) || 0,
            mathLevel: cells[6]?.textContent.trim() || "-",
            preTech: parseInt(cells[7]?.textContent.trim()) || 0,
            preTechLevel: cells[8]?.textContent.trim() || "-",
            kiswahili: parseInt(cells[9]?.textContent.trim()) || 0,
            kiswahiliLevel: cells[10]?.textContent.trim() || "-",
            science: parseInt(cells[11]?.textContent.trim()) || 0,
            scienceLevel: cells[12]?.textContent.trim() || "-",
            social: parseInt(cells[13]?.textContent.trim()) || 0,
            socialLevel: cells[14]?.textContent.trim() || "-",
            agriculture: parseInt(cells[15]?.textContent.trim()) || 0,
            agricultureLevel: cells[16]?.textContent.trim() || "-",
            religion: parseInt(cells[17]?.textContent.trim()) || 0,
            religionLevel: cells[18]?.textContent.trim() || "-",
            art: parseInt(cells[19]?.textContent.trim()) || 0,
            artLevel: cells[20]?.textContent.trim() || "-",
            totalMarks: parseInt(cells[cells.length - 2]?.textContent.trim()) || 0,
        };
    });

    // Group marks by gender
    const genderPerformance = { Male: [], Female: [] };

    marks.forEach(markEntry => {
        const learner = learners.find(l => l.name === markEntry.learner);
        if (learner) {
            markEntry.gender = learner.gender;
            if (learner.gender === "male") {
                genderPerformance.Male.push(markEntry);
            } else if (learner.gender === "female") {
                genderPerformance.Female.push(markEntry);
            }
        }
    });

    // Sort learners within each gender by total marks (Descending order)
    genderPerformance.Male.sort((a, b) => b.totalMarks - a.totalMarks);
    genderPerformance.Female.sort((a, b) => b.totalMarks - a.totalMarks);

    // Determine performance level based on total marks
    function getPerformanceLevel(totalMarks) {
        if (totalMarks >= 1 && totalMarks <= 200) return "BE";
        if (totalMarks >= 201 && totalMarks <= 400) return "AE";
        if (totalMarks >= 401 && totalMarks <= 600) return "ME";
        if (totalMarks >= 601 && totalMarks <= 800) return "EE";
        return "";
    }

    // Function to calculate correct totals and averages
    function calculateSubjectStats(data) {
        let totals = {
            english: 0, math: 0, preTech: 0, kiswahili: 0, science: 0,
            social: 0, agriculture: 0, religion: 0, art: 0, totalMarks: 0
        };

        data.forEach(entry => {
            totals.english += entry.english;
            totals.math += entry.math;
            totals.preTech += entry.preTech;
            totals.kiswahili += entry.kiswahili;
            totals.science += entry.science;
            totals.social += entry.social;
            totals.agriculture += entry.agriculture;
            totals.religion += entry.religion;
            totals.art += entry.art;
            totals.totalMarks += entry.totalMarks;
        });

        let count = data.length;
        let averages = count > 0 ? {
            english: (totals.english / count).toFixed(1),
            math: (totals.math / count).toFixed(1),
            preTech: (totals.preTech / count).toFixed(1),
            kiswahili: (totals.kiswahili / count).toFixed(1),
            science: (totals.science / count).toFixed(1),
            social: (totals.social / count).toFixed(1),
            agriculture: (totals.agriculture / count).toFixed(1),
            religion: (totals.religion / count).toFixed(1),
            art: (totals.art / count).toFixed(1),
            totalMarks: (totals.totalMarks / count).toFixed(1)
        } : totals;

        return { totals, averages };
    }

    // Function to generate performance tables with numbering, print buttons, and performance level
    function createPerformanceTable(data, gender) {
        if (data.length === 0) return `<h3>No ${gender} learners with recorded marks.</h3>`;

        let { totals, averages } = calculateSubjectStats(data);

        let tableId = `${gender.toLowerCase()}PerformanceTable`;

        let tableHtml = `
            <h2 style="color: ${gender === "Male" ? "blue" : "purple"}; text-align: center;">
                ${gender} Performance Report
            </h2>
            <table id="${tableId}" border="1" style="width:100%; border-collapse: collapse; margin-bottom: 10px;">
                <thead>
                    <tr style="background: #4CAF50; color: white;">
                        <th>No.</th>
                        <th>Name</th>
                        <th>Grade</th>
                        <th>Eng</th><th>Lev</th>
                        <th>Math</th><th>Lev</th>
                        <th>Pre-Tech</th><th>Lev</th>
                        <th>Kisw</th><th>Lev</th>
                        <th>Scie</th><th>Lev</th>
                        <th>Sst</th><th>Lev</th>
                        <th>Agric</th><th>Lev</th>
                        <th>Cre</th><th>Lev</th>
                        <th>C/A</th><th>Lev</th>
                        <th>Total Marks</th>
                        <th>Perf Lev</th>
                    </tr>
                </thead>
                <tbody>`;

        // Add learners' data with numbering and performance level
        data.forEach((entry, index) => {
            tableHtml += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${entry.learner}</td>
                    <td>${entry.grade}</td>
                    <td>${entry.english}</td><td>${entry.englishLevel}</td>
                    <td>${entry.math}</td><td>${entry.mathLevel}</td>
                    <td>${entry.preTech}</td><td>${entry.preTechLevel}</td>
                    <td>${entry.kiswahili}</td><td>${entry.kiswahiliLevel}</td>
                    <td>${entry.science}</td><td>${entry.scienceLevel}</td>
                    <td>${entry.social}</td><td>${entry.socialLevel}</td>
                    <td>${entry.agriculture}</td><td>${entry.agricultureLevel}</td>
                    <td>${entry.religion}</td><td>${entry.religionLevel}</td>
                    <td>${entry.art}</td><td>${entry.artLevel}</td>
                    <td><strong>${entry.totalMarks}</strong></td>
                    <td><strong>${getPerformanceLevel(entry.totalMarks)}</strong></td>
                </tr>`;
        });

        // Add totals and averages rows
        tableHtml += `
            <tr style="background: yellow; font-weight: bold;">
                <td colspan="3">Totals</td>
                <td>${totals.english}</td><td>-</td>
                <td>${totals.math}</td><td>-</td>
                <td>${totals.preTech}</td><td>-</td>
                <td>${totals.kiswahili}</td><td>-</td>
                <td>${totals.science}</td><td>-</td>
                <td>${totals.social}</td><td>-</td>
                <td>${totals.agriculture}</td><td>-</td>
                <td>${totals.religion}</td><td>-</td>
                <td>${totals.art}</td><td>-</td>
                <td><strong>${totals.totalMarks}</strong></td>
                <td>-</td>
            </tr>
            <tr style="background: lightblue; font-weight: bold;">
                <td colspan="3">Averages</td>
                <td>${averages.english}</td><td>-</td>
                <td>${averages.math}</td><td>-</td>
                <td>${averages.preTech}</td><td>-</td>
                <td>${averages.kiswahili}</td><td>-</td>
                <td>${averages.science}</td><td>-</td>
                <td>${averages.social}</td><td>-</td>
                <td>${averages.agriculture}</td><td>-</td>
                <td>${averages.religion}</td><td>-</td>
                <td>${averages.art}</td><td>-</td>
                <td><strong>${averages.totalMarks}</strong></td>
                <td>-</td>
            </tr>
        </tbody>
        </table>
        <button onclick="printTable('${tableId}')" style="margin: 10px; padding: 10px; background-color: #FF9800; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Print ${gender} Performance
        </button>`;

        return tableHtml;
    }

    // Updated printTable function with headers
    window.printTable = function (tableId) {
        const table = document.getElementById(tableId);
        if (!table) {
            alert("Table not found for printing.");
            return;
        }

        const currentYear = new Date().getFullYear(); // Dynamically fetch the year
        const grade = table.querySelector("tbody tr td:nth-child(3)")?.textContent.trim() || "N/A"; // Fetch the grade dynamically

        const printWindow = window.open("", "_blank");
        printWindow.document.write(`
            <html>
                <head>
                    <title>Print Performance Report</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 20px;
                            text-align: center;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 20px;
                        }
                        .header img {
                            width: 80px;
                            margin-bottom: 10px;
                        }
                        .header h1 {
                            font-size: 22px;
                            font-weight: bold;
                            color: black;
                            margin: 5px 0;
                        }
                        .header p {
                            font-size: 16px;
                            margin: 3px 0;
                            font-weight: bold;
                            color: black;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                        }
                        th, td {
                            border: 1px solid black;
                            padding: 8px;
                            text-align: center;
                        }
                        th {
                            background: #4CAF50;
                            color: white;
                            font-weight: bold;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo">
                        <h1>NACHU COMPREHENSIVE SCHOOL GENDER PERFORMANCE REPORT</h1>
                        <p>PO BOX 561-00902 KIKUYU, KENYA</p>
                        <p>Phone: +254-700-123456</p>
                        <p>School Motto: "HARD WORK PAYS"</p>
                        <p>Year: ${currentYear}</p>
                        <p>Grade: ${grade}</p>
                    </div>
                    ${table.outerHTML}
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    };

    // Display the reports
    document.getElementById("report").innerHTML = `
        ${createPerformanceTable(genderPerformance.Male, "Male")}
        ${createPerformanceTable(genderPerformance.Female, "Female")}
    `;
}


document.getElementById('photoInput').addEventListener('change', function (event) {
    const files = event.target.files;
    const gallery = document.getElementById('photoGallery');

    Array.from(files).forEach((file) => {
        const reader = new FileReader();
        reader.onload = function (e) {
            const imgContainer = document.createElement('div');
            imgContainer.style.position = 'relative';
            imgContainer.style.width = '150px';
            imgContainer.style.height = '150px';

            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            img.style.cursor = 'pointer';

            img.addEventListener('click', () => {
                const fullView = document.createElement('div');
                fullView.style.position = 'fixed';
                fullView.style.top = '0';
                fullView.style.left = '0';
                fullView.style.width = '100vw';
                fullView.style.height = '100vh';
                fullView.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                fullView.style.display = 'flex';
                fullView.style.justifyContent = 'center';
                fullView.style.alignItems = 'center';

                const fullImg = document.createElement('img');
                fullImg.src = e.target.result;
                fullImg.style.maxWidth = '90%';
                fullImg.style.maxHeight = '90%';

                fullView.appendChild(fullImg);

                fullView.addEventListener('click', () => {
                    fullView.remove();
                });

                document.body.appendChild(fullView);
            });

            imgContainer.appendChild(img);
            gallery.appendChild(imgContainer);
        };

        reader.readAsDataURL(file);
    });
});
document.getElementById("loginForm").addEventListener("submit", function (e) {
    e.preventDefault(); // Prevent form refresh

    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    // Validate credentials (replace with your logic)
    const validUsername = "Nachu254";
    const validPassword = "Nm643PpQ@";

    if (username === validUsername && password === validPassword) {
        // Hide login section and show main content
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("mainContent").style.display = "block";

        // Show Photo Album section
        document.getElementById("photoAlbumSection").style.display = "block";
    } else {
        // Show error message
        document.getElementById("loginError").style.display = "block";
    }
});
// Function to show colored alerts
function showAlert(message, type = 'info') {
    const alertContainer = document.getElementById('alertContainer');

// Create the alert div
    const alert = document.createElement('div');
    alert.style.display = 'inline-block'; // Dynamic width based on content
    alert.style.padding = '8px'; // Compact padding
    alert.style.marginBottom = '5px'; // Reduced margin
    alert.style.borderRadius = '3px'; // Smaller rounded corners
    alert.style.textAlign = 'center';
    alert.style.fontSize = '14px'; // Smaller font size
    alert.style.fontWeight = 'normal'; // Normal font weight
    alert.style.color = '#fff';
    alert.style.boxShadow = '0px 2px 4px rgba(0, 0, 0, 0.1)'; // Subtle shadow
    alert.style.transition = 'opacity 0.2s ease'; // Faster transition


    // Set background color based on the alert type
    switch (type) {
        case 'success':
            alert.style.backgroundColor = '#4CAF50'; // Green
            break;
        case 'error':
            alert.style.backgroundColor = '#F44336'; // Red
            break;
        case 'warning':
            alert.style.backgroundColor = '#FFC107'; // Yellow
            alert.style.color = '#333'; // Dark text for yellow background
            break;
        default:
            alert.style.backgroundColor = '#2196F3'; // Blue (info)
    }

    alert.textContent = message;

    // Append the alert to the container
    alertContainer.appendChild(alert);

    // Remove the alert after 3 seconds
    setTimeout(() => {
        alert.style.opacity = '0';
        setTimeout(() => alert.remove(), 300);
    }, 3000);
}

// Load photos from localStorage when the DOM content is fully loaded
document.addEventListener("DOMContentLoaded", function () {
    const savedPhotos = JSON.parse(localStorage.getItem('photoAlbum')) || [];
    if (savedPhotos.length > 0) {
        populatePhotoGallery(savedPhotos);
    }
});


// Handle photo uploads and save to localStorage
document.getElementById('photoInput').addEventListener('change', function (event) {
    const files = event.target.files;
    const savedPhotos = JSON.parse(localStorage.getItem('photoAlbum')) || [];

    if (files.length === 0) {
        showAlert('No files selected!', 'warning');
        return;
    }

    Array.from(files).forEach((file) => {
        const reader = new FileReader();
        reader.onload = function (e) {
            savedPhotos.push(e.target.result); // Save Base64 string
            populatePhotoGallery(savedPhotos); // Update gallery
            localStorage.setItem('photoAlbum', JSON.stringify(savedPhotos)); // Save to localStorage
            showAlert('Photo uploaded successfully!', 'success');
        };
        reader.readAsDataURL(file);
    });
});
// Function to populate the photo gallery
function populatePhotoGallery(photos) {
    const gallery = document.getElementById('photoGallery');
    gallery.innerHTML = ''; // Clear existing photos

    photos.forEach((photo, index) => {
        const imgContainer = document.createElement('div');
        imgContainer.style.position = 'relative';
        imgContainer.style.width = '150px';
        imgContainer.style.height = '150px';

        const img = document.createElement('img');
        img.src = photo;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.cursor = 'pointer';

        // Fullscreen view on click
        img.addEventListener('click', () => {
            const fullView = document.createElement('div');
            fullView.style.position = 'fixed';
            fullView.style.top = '0';
            fullView.style.left = '0';
            fullView.style.width = '100vw';
            fullView.style.height = '100vh';
            fullView.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            fullView.style.display = 'flex';
            fullView.style.justifyContent = 'center';
            fullView.style.alignItems = 'center';

            const fullImg = document.createElement('img');
            fullImg.src = photo;
            fullImg.style.maxWidth = '90%';
            fullImg.style.maxHeight = '90%';

            fullView.appendChild(fullImg);
            fullView.addEventListener('click', () => {
                fullView.remove();
            });
            document.body.appendChild(fullView);
        });

        imgContainer.appendChild(img);
        gallery.appendChild(imgContainer);
    });
}

// Toggle gallery visibility
document.getElementById('viewPhotosButton').addEventListener('click', function () {
    const gallery = document.getElementById('photoGallery');
    if (gallery.style.display === 'none' || gallery.style.display === '') {
        gallery.style.display = 'flex';
        showAlert('Displaying photos...', 'info');
    } else {
        gallery.style.display = 'none';
        showAlert('Photos hidden.', 'info');
    }
});

// Clear all saved photos with a custom confirmation
document.getElementById('clearPhotosButton').addEventListener('click', function () {
    customConfirm('Are you sure you want to clear all photos?', function (confirmed) {
        if (confirmed) {
            localStorage.removeItem('photoAlbum');
            document.getElementById('photoGallery').innerHTML = '';
            showAlert('All photos cleared!', 'error');
        }
    });
});

// Custom confirmation function
function customConfirm(message, callback) {
    let alertContainer = document.getElementById('customAlertContainer');
    if (!alertContainer) {
        alertContainer = document.createElement('div');
        alertContainer.id = 'customAlertContainer';
        document.body.appendChild(alertContainer);
    }

    // Clear existing content
    alertContainer.innerHTML = '';

    // Create confirmation dialog
    const confirmBox = document.createElement('div');
    confirmBox.style.backgroundColor = '#FF9800'; // Orange for confirmation
    confirmBox.style.color = '#FFF';
    confirmBox.style.padding = '20px';
    confirmBox.style.margin = '10px 0';
    confirmBox.style.borderRadius = '5px';
    confirmBox.style.textAlign = 'center';
    confirmBox.style.fontSize = '16px';
    confirmBox.style.position = 'fixed';
    confirmBox.style.top = '30%';
    confirmBox.style.left = '50%';
    confirmBox.style.transform = 'translateX(-50%)';
    confirmBox.style.zIndex = '1000';

    confirmBox.innerHTML = `
        <p>${message}</p>
        <button style="margin-right: 10px; padding: 10px 20px; background-color: #4CAF50; color: #FFF; border: none; border-radius: 5px; cursor: pointer;">Yes</button>
        <button style="padding: 10px 20px; background-color: #F44336; color: #FFF; border: none; border-radius: 5px; cursor: pointer;">No</button>
    `;

    alertContainer.appendChild(confirmBox);

    // Add button functionality
    const yesButton = confirmBox.querySelector('button:first-of-type');
    const noButton = confirmBox.querySelector('button:last-of-type');

    yesButton.addEventListener('click', () => {
        callback(true);
        confirmBox.remove();
    });

    noButton.addEventListener('click', () => {
        callback(false);
        confirmBox.remove();
    });
}
function toggleLearnersMenu() {
  const menu = document.getElementById('learnersMenu');
  menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
}
function toggleRegistrationMenu() {
  const menu = document.getElementById('registrationMenu');
  menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
}
function toggleJuniorSchoolMenu() {
  const menu = document.getElementById('juniorSchoolMenu');
  menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
}
function viewSavedTables() {
    const container = document.getElementById('savedTablesContainer');
    container.innerHTML = ""; // Clear the container

    const transaction = dbRequest.result.transaction(["examTables"], "readonly");
    const store = transaction.objectStore("examTables");
    const getAllRequest = store.getAll();

    getAllRequest.onsuccess = function() {
        const tables = getAllRequest.result;

        if (tables.length === 0) {
            container.innerHTML = "<p style='color: red; font-weight: bold;'>No saved exam tables found.</p>";
            return;
        }

        tables.forEach((tableData, index) => {
            const tableWrapper = document.createElement("div");
            tableWrapper.style.marginBottom = "20px";

            // Add a timestamp and unique ID
            const timestamp = new Date(tableData.timestamp).toLocaleString();
            const heading = document.createElement("h3");
            heading.textContent = `Exam Table ${index + 1} (Saved on ${timestamp})`;
            tableWrapper.appendChild(heading);

            // Insert the saved table
            const table = document.createElement("div");
            table.innerHTML = tableData.tableHTML;
            tableWrapper.appendChild(table);

            // Add a button to download this table as an Excel file
            const downloadButton = document.createElement("button");
            downloadButton.textContent = "Download Table as Excel";
            downloadButton.onclick = function() {
                const workbook = XLSX.utils.table_to_book(table.querySelector("table"), { sheet: "Marks Table" });
                XLSX.writeFile(workbook, `ExamTable_${index + 1}.xlsx`);
            };
            tableWrapper.appendChild(downloadButton);

            // Append to the container
            container.appendChild(tableWrapper);
        });
    };

    getAllRequest.onerror = function(event) {
        console.error("Error retrieving saved exam tables:", event.target.error);
    };
}
// IndexedDB setup
const dbRequest = indexedDB.open("ExamTablesDB", 1);

dbRequest.onupgradeneeded = function (event) {
    const db = event.target.result;
    db.createObjectStore("examTables", { keyPath: "id", autoIncrement: true });
};

function saveCurrentMarksTable() {
    const table = document.querySelector('.report-table');
    if (!table) {
        alertWithStyle("No marks table found to save!", 'color: red; font-weight: bold;');
        return;
    }

    // Retrieve data from the champions form
    const schoolName = document.getElementById("schoolName")?.value || "N/A";
    const gradeLevel = document.getElementById("gradeLevel")?.value || "N/A";
    const year = document.getElementById("year")?.value || "N/A";
    const term = document.getElementById("term")?.value || "N/A";

    // Generate the header dynamically
    const tableHeader = `
        <h3>Marks Table</h3>
        <p><strong>School:</strong> ${schoolName}</p>
        <p><strong>Grade:</strong> ${gradeLevel}</p>
        <p><strong>Year:</strong> ${year}</p>
        <p><strong>Term:</strong> ${term}</p>
    `;

    // Combine the header and the table
    const combinedHTML = `<div>${tableHeader}</div>${table.outerHTML}`;

    // Save the table to IndexedDB
    const transaction = dbRequest.result.transaction(["examTables"], "readwrite");
    const store = transaction.objectStore("examTables");
    const saveRequest = store.add({ combinedHTML, timestamp: new Date() });

    saveRequest.onsuccess = function () {
        alertWithStyle("Marks table saved successfully!", 'color: green; font-weight: bold;');
        viewSavedTables(); // Refresh the list of saved tables
    };

    saveRequest.onerror = function (event) {
        console.error("Error saving marks table:", event.target.error);
    };
}

function viewSavedTables() {
    const container = document.getElementById('savedTablesContainer');
    container.innerHTML = ""; // Clear the container

    const transaction = dbRequest.result.transaction(["examTables"], "readonly");
    const store = transaction.objectStore("examTables");
    const getAllRequest = store.getAll();

    getAllRequest.onsuccess = function () {
        const tables = getAllRequest.result;

        if (tables.length === 0) {
            container.innerHTML = "<p style='color: red; font-weight: bold;'>No saved exam tables found.</p>";
            return;
        }

        tables.forEach((tableData, index) => {
            const tableWrapper = document.createElement("div");
            tableWrapper.style.marginBottom = "20px";
            tableWrapper.style.position = 'relative';

            // Add a timestamp and unique ID
            const timestamp = new Date(tableData.timestamp).toLocaleString();
            const heading = document.createElement("h3");
            heading.textContent = `Exam Table ${index + 1} (Saved on ${timestamp})`;
            tableWrapper.appendChild(heading);

            // Insert the saved table
            const table = document.createElement("div");
            table.innerHTML = tableData.combinedHTML;
            tableWrapper.appendChild(table);

            // Add buttons (download, delete, print)
            addControlButtons(tableWrapper, tableData, table, index);

            // Append to the container
            container.appendChild(tableWrapper);
        });
    };

    getAllRequest.onerror = function (event) {
        console.error("Error retrieving saved exam tables:", event.target.error);
    };
}

function addControlButtons(wrapper, tableData, table, index) {
    // Download button
    const downloadButton = document.createElement("button");
    downloadButton.textContent = "Download Table as Excel";
    downloadButton.onclick = function () {
        const workbook = XLSX.utils.table_to_book(table.querySelector("table"), { sheet: "Marks Table" });
        XLSX.writeFile(workbook, `ExamTable_${index + 1}.xlsx`);
    };
    wrapper.appendChild(downloadButton);

    // Delete button
    const deleteButton = createStyledButton("Delete Table", "red", "white", () => confirmDelete(tableData.id));
    deleteButton.style.right = '10px';
    deleteButton.style.top = '10px';
    wrapper.appendChild(deleteButton);

    // Print button
    const printButton = createStyledButton("Print Table", "#4CAF50", "white", () => printTable(table));
    printButton.style.right = '100px';
    printButton.style.top = '10px';
    wrapper.appendChild(printButton);
}

function createStyledButton(text, bgColor, textColor, onClick) {
    const button = document.createElement("button");
    button.textContent = text;
    button.style.backgroundColor = bgColor;
    button.style.color = textColor;
    button.style.border = 'none';
    button.style.padding = '3px 6px';
    button.style.fontSize = '12px';
    button.style.cursor = 'pointer';
    button.style.borderRadius = '3px';
    button.style.position = 'absolute';
    button.onclick = onClick;
    return button;
}

function confirmDelete(tableId) {
    if (confirm("Are you sure you want to delete this table?")) {
        deleteExamTable(tableId);
    }
}

function deleteExamTable(tableId) {
    const transaction = dbRequest.result.transaction(["examTables"], "readwrite");
    const store = transaction.objectStore("examTables");
    const deleteRequest = store.delete(tableId);

    deleteRequest.onsuccess = function () {
        alertWithStyle("Exam table deleted successfully!", 'color: green; font-weight: bold; background-color: #f2f2f2; border: 1px solid green; padding: 10px;');
        viewSavedTables(); // Refresh the view
    };

    deleteRequest.onerror = function (event) {
        console.error("Error deleting exam table:", event.target.error);
    };
}

 // Function to show a confirmation prompt with Yes/No options
        function confirmDelete(tableId) {
            const confirmationBox = document.createElement('div');
            confirmationBox.style.position = 'fixed';
            confirmationBox.style.top = '50%';
            confirmationBox.style.left = '50%';
            confirmationBox.style.transform = 'translate(-50%, -50%)';
            confirmationBox.style.zIndex = '1000';
            confirmationBox.style.backgroundColor = '#f8f8f8';
            confirmationBox.style.border = '2px solid #007BFF';
            confirmationBox.style.borderRadius = '10px';
            confirmationBox.style.padding = '20px';
            confirmationBox.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.2)';
            confirmationBox.style.textAlign = 'center';
            confirmationBox.style.fontFamily = 'Arial, sans-serif';
            
            confirmationBox.innerHTML = `<p style="font-size: 16px; color: #333;">Are you sure you want to delete this exam table? This action cannot be undone.</p>`;
            
            // Yes button
            const yesButton = document.createElement('button');
            yesButton.textContent = 'Yes';
            yesButton.style.backgroundColor = '#007BFF';
            yesButton.style.color = 'white';
            yesButton.style.border = 'none';
            yesButton.style.padding = '10px 20px';
            yesButton.style.margin = '10px';
            yesButton.style.cursor = 'pointer';
            yesButton.style.borderRadius = '5px';
            
            // No button
            const noButton = document.createElement('button');
            noButton.textContent = 'No';
            noButton.style.backgroundColor = '#f44336';
            noButton.style.color = 'white';
            noButton.style.border = 'none';
            noButton.style.padding = '10px 20px';
            noButton.style.margin = '10px';
            noButton.style.cursor = 'pointer';
            noButton.style.borderRadius = '5px';

            yesButton.onclick = function() {
                deleteExamTable(tableId);
                confirmationBox.remove(); // Remove confirmation box
            };

            noButton.onclick = function() {
                confirmationBox.remove(); // Remove confirmation box if No is clicked
            };

            confirmationBox.appendChild(yesButton);
            confirmationBox.appendChild(noButton);

            document.body.appendChild(confirmationBox);
        }

        // Custom alert function with inline styling
        function alertWithStyle(message, style) {
            const alertDiv = document.createElement('div');
            alertDiv.textContent = message;
            alertDiv.style = style;
            alertDiv.style.padding = '10px';
            alertDiv.style.margin = '10px 0';
            alertDiv.style.border = '1px solid';
            alertDiv.style.borderRadius = '5px';
            alertDiv.style.fontFamily = 'Arial, sans-serif';
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '50%';
            alertDiv.style.left = '50%';
            alertDiv.style.transform = 'translate(-50%, -50%)';
            alertDiv.style.zIndex = '1000'; // Ensure the alert is above other content
            alertDiv.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.2)';

            document.body.appendChild(alertDiv); // Appending to body, or you can append to a specific container

            // Remove the alert after 2 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 2000);
        }
  // Function to toggle visibility of saved tables
        function toggleTableVisibility() {
            const container = document.getElementById('savedTablesContainer');
            container.style.display = (container.style.display === 'none' || container.style.display === '') ? 'block' : 'none';
        }
// Function to print the specific table with black borders for rows and columns
function printTable(tableElement) {
    const printWindow = window.open('', '_blank');
    printWindow.document.write('<html><head><title>Print Exam Table</title>');
    printWindow.document.write('<style>');
    printWindow.document.write('table { width: 100%; border-collapse: collapse; }');
    printWindow.document.write('th, td { padding: 8px; border: 1px solid black; text-align: left; }');
    printWindow.document.write('</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(tableElement.outerHTML);
    printWindow.document.write('</body></html>');
    
    printWindow.document.close();
    printWindow.print();
}
// Function to display a custom prompt box for input and print the registered parents table
function printParentsTable() {
    // Create the custom prompt box
    const promptBox = document.createElement('div');
    promptBox.style.position = 'fixed';
    promptBox.style.top = '0';
    promptBox.style.left = '0';
    promptBox.style.width = '100%';
    promptBox.style.height = '100%';
    promptBox.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
    promptBox.style.display = 'flex';
    promptBox.style.justifyContent = 'center';
    promptBox.style.alignItems = 'center';
    promptBox.style.zIndex = '9999';

    // Create the inner modal content
    const modal = document.createElement('div');
    modal.style.backgroundColor = '#fff';
    modal.style.padding = '20px';
    modal.style.borderRadius = '8px';
    modal.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
    modal.style.textAlign = 'center';
    modal.style.width = '300px';

    // Create the inputs for school name, year, and date
    const schoolNameInput = createInputField('School Name:', 'schoolName', '2E8B57'); // Green
    const yearInput = createInputField('Year:', 'year', 'FF6347'); // Red
    const dateInput = createInputField('Date:', 'date', '1E90FF'); // Blue

    // Append inputs and button to the modal
    modal.appendChild(schoolNameInput.label);
    modal.appendChild(schoolNameInput.input);
    modal.appendChild(document.createElement('br'));
    modal.appendChild(yearInput.label);
    modal.appendChild(yearInput.input);
    modal.appendChild(document.createElement('br'));
    modal.appendChild(dateInput.label);
    modal.appendChild(dateInput.input);
    modal.appendChild(document.createElement('br'));
    const submitButton = document.createElement('button');
    submitButton.textContent = 'Submit';
    submitButton.style.marginTop = '20px';
    submitButton.style.padding = '10px 20px';
    submitButton.style.backgroundColor = '#4CAF50';
    submitButton.style.color = '#fff';
    submitButton.style.border = 'none';
    submitButton.style.borderRadius = '4px';
    modal.appendChild(submitButton);

    // Append modal to prompt box
    promptBox.appendChild(modal);
    document.body.appendChild(promptBox);

    // Handle form submission
    submitButton.onclick = function () {
        const schoolName = schoolNameInput.input.value;
        const year = yearInput.input.value;
        const date = dateInput.input.value;

        if (!schoolName || !year || !date) {
            alert("Please provide all the details (School Name, Year, and Date) to proceed with printing.");
            return;
        }

        // Close the prompt box
        document.body.removeChild(promptBox);

        // Get the registered parents table HTML content
        let table = document.getElementById("parentTable").outerHTML;

        // Remove the delete button for each row using forEach
        const rows = document.querySelectorAll("#parentTable tbody tr");
        rows.forEach(row => {
            const deleteButtonCell = row.querySelector('td button');
            if (deleteButtonCell) {
                deleteButtonCell.parentNode.innerHTML = '';  // Remove the delete button cell
            }
        });

        // Get the updated table HTML after removing delete buttons
        table = document.getElementById("parentTable").outerHTML;

        // Open a new print window
        const printWindow = window.open("", "_blank");

        // Write the content for printing including the prompt details
        printWindow.document.write(`
            <html>
                <head>
                    <title>Registered Parents</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f9f9f9; }
                        table { width: 100%; border-collapse: collapse; background-color: #ffffff; }
                        th, td { border: 1px solid #dddddd; padding: 8px; text-align: center; }
                        th { background-color: #4CAF50; color: white; font-size: 16px; } /* Set header background and text color */
                        td { font-size: 14px; color: #333333; }
                        .header-info { font-weight: bold; margin-bottom: 20px; font-size: 16px; color: #2C3E50; }
                        h1 { color: #2C3E50; font-size: 18px; }
                        p { font-size: 14px; }
                        .school-name { color: #2E8B57; font-weight: bold; }
                        .year { color: #FF6347; font-weight: bold; }
                        .date { color: #1E90FF; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="header-info">
                        <p><strong>School:</strong> <span class="school-name">${schoolName}</span></p>
                        <p><strong>Year:</strong> <span class="year">${year}</span></p>
                        <p><strong>Date:</strong> <span class="date">${date}</span></p>
                    </div>
                    <h1>Registered Parents</h1>
                    ${table}
                </body>
            </html>
        `);

        // Close the document and trigger the print dialog
        printWindow.document.close();
        printWindow.print();
    };

    // Function to create input fields with labels and colors
    function createInputField(labelText, id, color) {
        const label = document.createElement('label');
        label.textContent = labelText;
        label.style.color = `#${color}`;
        label.style.fontWeight = 'bold';

        const input = document.createElement('input');
        input.type = 'text';
        input.id = id;
        input.style.padding = '8px';
        input.style.margin = '5px 0';
        input.style.border = '1px solid #ccc';
        input.style.borderRadius = '4px';

        return { label, input };
    }
}
function logout() {
    const logoutButton = document.getElementById("logoutButton");
    // Change button text to "Logging Out..."
    if (logoutButton) {
        logoutButton.textContent = "Logging Out...";
        logoutButton.disabled = true; // Disable the button to prevent multiple clicks
    }

    // Hide all sections that might be visible
    const sectionsToHide = [
        "mainContent",
        "registeredLearnersBox",
        "registerLearnerSection",
        "juniorMarksEntrySection",
        "marksTableSection",
        "archivesSection",
        "juniorSchoolActions",
        "parentRegistrationSection",
        "registeredParentsSection",
        "staffRegistrationSection",
        "supportStaffRegistrationSection",
        "bulkReportGeneration",
        "photoAlbumSection",
        "menuActions",
        "championsForm",
    ];

    sectionsToHide.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
            section.style.display = "none";
        }
    });

    // Show only the login section
    const loginSection = document.getElementById("loginSection");
    if (loginSection) {
        loginSection.style.display = "block";
    }

    // Display styled success message
    const successMessage = document.createElement("div");
    successMessage.textContent = "You have been logged out successfully!";
    successMessage.style.color = "green"; // Set text color to green
    successMessage.style.fontWeight = "bold"; // Make it bold
    successMessage.style.fontSize = "16px"; // Adjust font size
    successMessage.style.textAlign = "center"; // Center the message
    successMessage.style.marginTop = "20px";

    loginSection.appendChild(successMessage);

    // Simulate a short delay to reset the button
    setTimeout(() => {
        // Reset button text and enable it again
        if (logoutButton) {
            logoutButton.textContent = "Logout";
            logoutButton.disabled = false;
        }

        // Remove the success message after a few seconds
        setTimeout(() => successMessage.remove(), 3000); // Message disappears after 3 seconds
    }, 1000); // Delay for 1 second
}
// Function to search learners by name or admission number
function searchLearner() {
    const searchInput = document.getElementById("searchLearner").value.toLowerCase();
    const learnerRows = document.querySelectorAll("#learnersList tr");

    learnerRows.forEach(row => {
        const learnerName = row.cells[2].textContent.toLowerCase(); // Assuming the name is in the third column
        const admissionNumber = row.cells[9].textContent.toLowerCase(); // Assuming the admission number is in the tenth column

        if (learnerName.includes(searchInput) || admissionNumber.includes(searchInput)) {
            row.style.display = ""; // Show row
        } else {
            row.style.display = "none"; // Hide row
        }
    });
}
    // Function to optimize the app by loading assets dynamically
    function optimizeApp() {
        // Array of scripts to load lazily
        const libraries = [
            "https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js",
            "https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.0/docx.min.js",
            "https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js",
            "https://cdn.sheetjs.com/xlsx-latest/xlsx.full.min.js"
        ];

        // Load each script dynamically
        libraries.forEach((src) => {
            const script = document.createElement('script');
            script.src = src;
            script.async = true;
            script.onload = () => console.log(`${src} loaded successfully`);
            document.body.appendChild(script);
        });

        // Array of stylesheets to load
        const styles = [
            "https://fonts.googleapis.com/icon?family=Material+Icons",
            "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
        ];

        // Load each stylesheet dynamically
        styles.forEach((href) => {
            const link = document.createElement('link');
            link.rel = "stylesheet";
            link.href = href;
            link.onload = () => console.log(`${href} loaded successfully`);
            document.head.appendChild(link);
        });

        console.log("Optimization script executed.");
    }

    // Run optimization when the page is loaded
    window.addEventListener('load', optimizeApp);

    // Lazy load sections (e.g., large datasets or heavy elements)
    function lazyLoadSections() {
        const sections = document.querySelectorAll('.hidden-section');
        const observer = new IntersectionObserver(
            (entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.display = "block";
                        observer.unobserve(entry.target);
                    }
                });
            },
            { rootMargin: "0px", threshold: 0.1 }
        );

        sections.forEach(section => observer.observe(section));
    }

    // Run lazy loading for hidden sections
    document.addEventListener('DOMContentLoaded', lazyLoadSections);
function deleteLearner(admissionNumber) {
    const request = indexedDB.open("LearnersDB", 1);
    request.onsuccess = function (event) {
        const db = event.target.result;
        const transaction = db.transaction(["learners"], "readwrite");
        const objectStore = transaction.objectStore("learners");

        const deleteRequest = objectStore.delete(admissionNumber);
        deleteRequest.onsuccess = function () {
            learners = learners.filter(learner => learner.admissionNumber !== admissionNumber); // Update local array
            updateLearnersTable(); // Refresh table
            alert("Learner deleted successfully.");
        };
        deleteRequest.onerror = function (event) {
            console.error("Error deleting learner:", event.target.error);
        };
    };
    request.onerror = function (event) {
        console.error("Error opening IndexedDB:", event.target.error);
    };
}
function updateLearnerField(index, field, value) {
    learners[index][field] = value; // Update local array
    const admissionNumber = learners[index].admissionNumber;

    const request = indexedDB.open("LearnersDB", 1);
    request.onsuccess = function (event) {
        const db = event.target.result;
        const transaction = db.transaction(["learners"], "readwrite");
        const objectStore = transaction.objectStore("learners");

        const getRequest = objectStore.get(admissionNumber);
        getRequest.onsuccess = function () {
            const learner = getRequest.result;
            learner[field] = value;

            const updateRequest = objectStore.put(learner);
            updateRequest.onsuccess = function () {
                console.log(`Updated ${field} for learner ${admissionNumber}`);
            };
            updateRequest.onerror = function (event) {
                console.error(`Error updating ${field}:`, event.target.error);
            };
        };
    };
}
function updateLearnersTable() {
    learnersList.innerHTML = learners.map((learner, index) => `
        <tr>
            <td>${index + 1}</td> <!-- Serial Number -->
            <td>
                <img src="${learner.photo || 'default.png'}" alt="Photo" width="40" height="40">
                <br>
                <button onclick="viewLearnerDetails(${index})" class="small-btn btn-green">
                    <i class="fas fa-eye"></i> <!-- View Icon -->
                </button>
            </td>
            <td contenteditable="true" onblur="updateLearnerField(${index}, 'name', this.textContent)">${learner.name}</td>
            <td contenteditable="true" onblur="updateLearnerField(${index}, 'gender', this.textContent)">${learner.gender}</td>
            <td contenteditable="true" onblur="updateLearnerField(${index}, 'grade', this.textContent)">${learner.grade}</td>
            <td contenteditable="true" onblur="updateLearnerField(${index}, 'age', this.textContent)">${learner.age}</td>
            <td contenteditable="true" onblur="updateLearnerField(${index}, 'parentName', this.textContent)">${learner.parentName}</td>
            <td contenteditable="true" onblur="updateLearnerField(${index}, 'phone', this.textContent)">${learner.phone}</td>
            <td contenteditable="true" onblur="updateLearnerField(${index}, 'birthCertificateNo', this.textContent)">${learner.birthCertificateNo}</td>
            <td>${learner.admissionNumber}</td>
            <td>
                <input type="file" accept="image/*" style="display: none;" onchange="changePhoto(event, '${learner.admissionNumber}')">
                <button onclick="this.previousElementSibling.click()" class="small-btn btn-blue">
                    <i class="fas fa-camera"></i> <!-- Change Photo Icon -->
                </button>
                <button onclick="deleteLearner('${learner.admissionNumber}')" class="small-btn btn-red">
                    <i class="fas fa-trash"></i> <!-- Delete Icon -->
                </button>
            </td>
        </tr>
    `).join("");

    updateLearnerSelect();       // (Your existing helper)
    populateGradeDropdown();     // ?? Add this line to dynamically update grade list
}

// Function to show learner details in a modal
function viewLearnerDetails(index) {
    // Get the learner from the array
    const learner = learners[index];
    if (!learner) {
        alert("Learner not found!");
        return;
    }

    // Populate the modal with learner details
    const modalContent = `
        <h2>${learner.name}'s Details</h2>
        <img src="${learner.photo || 'placeholder.jpg'}" alt="Learner Photo" style="width: 150px; height: 150px; border-radius: 50%;" />
        <p><strong>Gender:</strong> ${learner.gender}</p>
        <p><strong>Grade:</strong> ${learner.grade}</p>
        <p><strong>Age:</strong> ${learner.age}</p>
        <p><strong>Parent Name:</strong> ${learner.parentName}</p>
        <p><strong>Parent Phone No:</strong> ${learner.phone}</p>
        <p><strong>Birth Certificate No:</strong> ${learner.birthCertificateNo}</p>
        <p><strong>Admission Number:</strong> ${learner.admissionNumber}</p>
        <button onclick="closeModal()" class="btn-red">Close</button>
    `;

    // Insert content into the modal and display it
    document.getElementById("learnerDetailsModal").innerHTML = modalContent;
    document.getElementById("modalOverlay").style.display = "flex";
}

// Function to close the modal
function closeModal() {
    document.getElementById("modalOverlay").style.display = "none";
}
// Function to enable editing and saving updates
function makeTableEditable() {
    const table = document.querySelector("#learnersList"); // Select the learners table
    table.addEventListener("input", function(event) {
        const cell = event.target;
        const row = cell.parentElement;
        const admissionNumber = row.dataset.admission; // Retrieve admission number from row attribute
        
        // Get updated values
        const updatedLearner = {
            name: row.children[1].textContent,
            gender: row.children[2].textContent,
            grade: row.children[3].textContent,
            age: row.children[4].textContent,
            parentName: row.children[5].textContent,
            phone: row.children[6].textContent,
            birthCertificateNo: row.children[7].textContent,
            admissionNumber: admissionNumber,
            photo: row.children[8].querySelector("img").src
        };

        // Open IndexedDB and update the learner
        const request = indexedDB.open("LearnersDB", 1);
        request.onsuccess = function(event) {
            const db = event.target.result;
            const transaction = db.transaction(["learners"], "readwrite");
            const objectStore = transaction.objectStore("learners");
            objectStore.put(updatedLearner);
        };
    });
}

// Call this function after the table is populated
document.addEventListener("DOMContentLoaded", makeTableEditable);

function changePhoto(event, admissionNumber) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            updateLearnerPhoto(admissionNumber, e.target.result); // Update IndexedDB with new photo
        };
        reader.readAsDataURL(file);
    }
}

// Function to update IndexedDB when photo is changed
function updateLearnerPhoto(admissionNumber, newPhoto) {
    const request = indexedDB.open("LearnersDB", 1);

    request.onsuccess = function (event) {
        const db = event.target.result;
        const transaction = db.transaction(["learners"], "readwrite");
        const objectStore = transaction.objectStore("learners");

        const getRequest = objectStore.get(admissionNumber);
        getRequest.onsuccess = function () {
            const learner = getRequest.result;
            if (learner) {
                learner.photo = newPhoto; // Update the learner's photo
                
                const updateRequest = objectStore.put(learner);
                updateRequest.onsuccess = function () {
                    updateLearnersTable(); // Refresh the table
                };
            }
        };
    };
}
// Function to display learner's photo when selected in dropdown
document.getElementById("learnerSelect").addEventListener("change", function () {
    const selectedLearnerName = this.value; // Get selected learner name
    const request = indexedDB.open("LearnersDB", 1);

    request.onsuccess = function (event) {
        const db = event.target.result;
        const transaction = db.transaction(["learners"], "readonly");
        const objectStore = transaction.objectStore("learners");

        const getAllRequest = objectStore.getAll();
        getAllRequest.onsuccess = function () {
            const learners = getAllRequest.result;
            const selectedLearner = learners.find(learner => learner.name === selectedLearnerName);

            if (selectedLearner && selectedLearner.photo) {
                document.getElementById("learnerPhotoDisplay").src = selectedLearner.photo;
                document.getElementById("learnerPhotoDisplay").style.display = "block"; // Show photo
            } else {
                document.getElementById("learnerPhotoDisplay").src = "default.png"; // Show default image if no photo
            }
        };
    };
});

function calculateSubjectLevels() {
    let subjects = ["english", "math", "preTech", "kiswahili", "science", "social", "agriculture", "religion", "art"];
    let subjectLevels = {};

    // Initialize level counters for each subject
    subjects.forEach(subject => {
        subjectLevels[subject] = { level1: 0, level2: 0, level3: 0, level4: 0 };
    });

    let marksRows = document.querySelectorAll("#marksList tr");

    // If no marks are present, reset the summary table
    if (marksRows.length === 0) {
        document.getElementById("subjectLevels").innerHTML = "<tr><td colspan='5'>No data available</td></tr>";
        return;
    }

    // Process each row in the marks table
    marksRows.forEach(row => {
        let cells = row.querySelectorAll("td");

        subjects.forEach((subject, index) => {
            let levelCellIndex;

            // Fix the column index for Maths and English (adjust their position)
            if (subject === "english") {
                levelCellIndex = 4; // "Lev" column for English
            } else if (subject === "math") {
                levelCellIndex = 6; // "Lev" column for Math
            } else {
                levelCellIndex = (index * 2) + 4; // General calculation for other subjects
            }

            let levelText = cells[levelCellIndex]?.innerText.trim(); // Extract level text

            if (levelText) {
                let level = parseInt(levelText, 10); // Convert to a number

                // Count learners for each level
                if (level === 1) {
                    subjectLevels[subject].level1++;
                } else if (level === 2) {
                    subjectLevels[subject].level2++;
                } else if (level === 3) {
                    subjectLevels[subject].level3++;
                } else if (level === 4) {
                    subjectLevels[subject].level4++;
                }
            }
        });
    });

    // Update the Subject Level Summary Table
    let subjectLevelsTable = document.getElementById("subjectLevels");
    subjectLevelsTable.innerHTML = ""; // Clear existing data

    subjects.forEach(subject => {
        let row = `<tr>
            <td>${subject.toUpperCase()}</td>
            <td>${subjectLevels[subject].level1} learners (BE)</td>
            <td>${subjectLevels[subject].level2} learners (AE)</td>
            <td>${subjectLevels[subject].level3} learners (ME)</td>
            <td>${subjectLevels[subject].level4} learners (EE)</td>
        </tr>`;
        subjectLevelsTable.innerHTML += row;
    });
}

// Call function after marks are loaded
document.addEventListener("DOMContentLoaded", function () {
    calculateSubjectLevels();
});

// Attach this function to events like adding/editing marks dynamically
function refreshLevels() {
    calculateSubjectLevels();
}

function printSubjectLevels() {
    const subjectTable = document.getElementById("subjectLevels");
    if (!subjectTable) {
        alert("No subject level data available to print.");
        return;
    }

    // Get the first available grade dynamically
    const firstRow = document.querySelector("#marksTableSection .report-table tbody tr");
    const grade = firstRow ? firstRow.children[2].textContent.trim() : "N/A";

    let printContents = `
        <html>
        <head>
            <title>Nachu Junior School Subject Level Summary Report</title>
            <style>
                body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
                h2, p { margin: 5px 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                th, td { border: 1px solid black; padding: 8px; text-align: center; }
                th { background-color: #4CAF50; color: white; }
                .school-logo { max-width: 100px; display: block; margin: 0 auto; }
            </style>
        </head>
        <body>
            <div>
                <img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo" class="school-logo">
                <h2>Nachu Junior School  Subject Level Summary Report</h2>
                <p><strong>561-00902 Kikuyu KENYA</strong></p>
                <p><strong>Phone: +254-700-123456</strong></p>
                <p><em>School Motto: "Excellence Through Knowledge"</em></p>
                <p><strong>Year: 2025</strong></p>
                <p><strong>Grade: ${grade}</strong></p>
            </div>
            <hr>
            <table>
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Level 1</th>
                        <th>Level 2</th>
                        <th>Level 3</th>
                        <th>Level 4</th>
                    </tr>
                </thead>
                <tbody>
                    ${subjectTable.innerHTML}
                </tbody>
            </table>
            <br>
            <button onclick="window.print()">Print Report</button>
        </body>
        </html>
    `;

    let newWindow = window.open("", "_blank");
    newWindow.document.write(printContents);
    newWindow.document.close();
}
// Reuse custom prompt
function promptForGradeCustom(message) {
    return new Promise(resolve => {
        const overlay = document.createElement('div');
        Object.assign(overlay.style, {
            position: 'fixed', top: '0', left: '0',
            width: '100%', height: '100%',
            background: 'rgba(0,0,0,0.6)',
            display: 'flex', justifyContent: 'center', alignItems: 'center',
            zIndex: '9999'
        });

        const box = document.createElement('div');
        Object.assign(box.style, {
            background: '#fff', padding: '20px',
            borderRadius: '8px', width: '320px',
            maxWidth: '90%', boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
            textAlign: 'center'
        });

        box.innerHTML = `
            <p style="margin-bottom:12px;font-weight:bold;">${message}</p>
            <input id="gradePromptInput" type="text"
                   placeholder="e.g. 7"
                   style="width:100%;padding:8px;margin-bottom:12px;
                          border:1px solid #ccc;border-radius:4px;" />
            <div>
                <button id="gradePromptOk"
                        style="padding:8px 16px;margin:0 6px;
                               border:none;border-radius:4px;
                               background:#4CAF50;color:#fff;
                               cursor:pointer;">OK</button>
                <button id="gradePromptCancel"
                        style="padding:8px 16px;margin:0 6px;
                               border:none;border-radius:4px;
                               background:#f44336;color:#fff;
                               cursor:pointer;">Cancel</button>
            </div>`;
        overlay.appendChild(box);
        document.body.appendChild(overlay);

        const input = document.getElementById('gradePromptInput');
        input.focus();

        document.getElementById('gradePromptOk').onclick = () => {
            const value = input.value.trim();
            document.body.removeChild(overlay);
            resolve(value || null);
        };

        document.getElementById('gradePromptCancel').onclick = () => {
            document.body.removeChild(overlay);
            resolve(null);
        };

        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') document.getElementById('gradePromptOk').click();
        });
    });
}

// Updated pathway grouping function
async function groupLearnersByPathways() {
    const grade = await promptForGradeCustom("Enter grade for Career Pathway Report:");
    if (grade === null) return;

    const learnersTable = document.querySelector("#marksTableSection .report-table tbody");
    const learnersRows = Array.from(learnersTable.querySelectorAll("tr"));
    const resultsTable = document.querySelector("#pathwaysResultsTable tbody");

    resultsTable.innerHTML = "";
    const existingSummary = document.getElementById("summaryTable");
    if (existingSummary) existingSummary.remove();

    const pathwayCounts = {
        STEM: 0,
        "Social Sciences": 0,
        "Sports, Arts & Science": 0,
    };

    learnersRows.forEach((row) => {
        const cells = row.querySelectorAll("td");
        if (cells.length < 22) return;

        const learnerName = cells[1].textContent.trim();
        const learnerGrade = cells[2].textContent.trim();
        if (learnerGrade !== grade) return;

        const scores = {
            English: parseInt(cells[3].textContent.trim()) || 0,
            Math: parseInt(cells[5].textContent.trim()) || 0,
            "Pre-technical Studies": parseInt(cells[7].textContent.trim()) || 0,
            Kiswahili: parseInt(cells[9].textContent.trim()) || 0,
            "Integrated Science": parseInt(cells[11].textContent.trim()) || 0,
            "Social Studies": parseInt(cells[13].textContent.trim()) || 0,
            Agriculture: parseInt(cells[15].textContent.trim()) || 0,
            "Religious Education": parseInt(cells[17].textContent.trim()) || 0,
            "Creative Art": parseInt(cells[19].textContent.trim()) || 0,
        };

        const pathways = {
            STEM: ["English", "Math", "Pre-technical Studies", "Kiswahili", "Integrated Science", "Agriculture"],
            "Social Sciences": ["Kiswahili", "English", "Social Studies", "Religious Education"],
            "Sports, Arts & Science": ["Kiswahili", "English", "Creative Art"],
        };

        const pathwayResults = {};
        for (const path in pathways) {
            const subjects = pathways[path];
            const total = subjects.reduce((sum, subj) => sum + (scores[subj] || 0), 0);
            pathwayResults[path] = total / subjects.length;
        }

        const bestPathway = Object.keys(pathwayResults).reduce((a, b) =>
            pathwayResults[a] > pathwayResults[b] ? a : b
        );
        pathwayCounts[bestPathway]++;

        const resultRow = document.createElement("tr");
        resultRow.innerHTML = `
            <td>${learnerName}</td>
            <td>${learnerGrade}</td>
            ${pathways.STEM.map(subject => `<td>${scores[subject]}</td>`).join("")}
            ${pathways["Social Sciences"].map(subject => `<td>${scores[subject]}</td>`).join("")}
            ${pathways["Sports, Arts & Science"].map(subject => `<td>${scores[subject]}</td>`).join("")}
            <td>${pathwayResults.STEM.toFixed(2)}</td>
            <td>${pathwayResults["Social Sciences"].toFixed(2)}</td>
            <td>${pathwayResults["Sports, Arts & Science"].toFixed(2)}</td>
            <td><strong>${bestPathway}</strong></td>`;
        resultsTable.appendChild(resultRow);
    });

    const summaryHTML = `
        <table id="summaryTable" border="1" cellspacing="0" cellpadding="5"
               style="width: 50%; margin: 10px auto; text-align: center; font-family: Arial, sans-serif;">
           <thead style="background-color:#f2f2f2;">
              <tr><th>Pathway</th><th>Number of Learners</th></tr>
           </thead>
           <tbody>
              <tr><td>STEM</td><td>${pathwayCounts["STEM"]}</td></tr>
              <tr><td>Social Sciences</td><td>${pathwayCounts["Social Sciences"]}</td></tr>
              <tr><td>Sports, Arts & Science</td><td>${pathwayCounts["Sports, Arts & Science"]}</td></tr>
           </tbody>
        </table>`;
    
    document.getElementById("resultsSection").insertAdjacentHTML("beforeend", summaryHTML);
}

function togglePathwaysTable() {
    const resultsSection = document.getElementById("resultsSection");
    const toggleButton = document.querySelector(".toggle-button");

    if (resultsSection.style.display === "none") {
        resultsSection.style.display = "block";
        groupLearnersByPathways(); // Populate the table with updated data
        toggleButton.innerHTML = `<i class="fas fa-eye-slash"></i> Hide Pathways Table`;
    } else {
        resultsSection.style.display = "none";
        toggleButton.innerHTML = `<i class="fas fa-chart-bar"></i> Group Learners by Pathways`;
    }
}

function printPathwayReport() {
    const resultsSection = document.getElementById("resultsSection");
    if (!resultsSection || resultsSection.style.display === "none") {
        alert("Please generate the pathway report first before printing.");
        return;
    }

    // Build the main results table HTML for printing
    const mainTableHTML = `
        <table border="1" cellspacing="0" cellpadding="5" style="width: 100%; text-align: center; font-family: Arial, sans-serif;">
            <thead>
                <tr>
                    <th rowspan="2">Learner</th>
                    <th rowspan="2">Grade</th>
                    <th colspan="6">STEM Subjects</th>
                    <th colspan="4">Social Sciences Subjects</th>
                    <th colspan="3">Sports, Arts & Science Subjects</th>
                    <th rowspan="2">STEM Average</th>
                    <th rowspan="2">Social Sciences Average</th>
                    <th rowspan="2">Sports, Arts & Science Average</th>
                    <th rowspan="2">Best Pathway</th>
                </tr>
                <tr>
                    <th>ENG</th><th>MATH</th><th>PRE-TECH</th><th>KISWA</th><th>I SCIE</th><th>AGRIC</th>
                    <th>KISWA</th><th>ENG</th><th>SST</th><th>CRE</th>
                    <th>KISWA</th><th>ENG</th><th>C/A</th>
                </tr>
            </thead>
            <tbody>${document.querySelector("#pathwaysResultsTable tbody").innerHTML}</tbody>
        </table>
    `;

    // Get the summary table HTML
    const summaryTableHTML = document.getElementById("summaryTable").outerHTML;

    // Combine header, main table, and summary table into the final report content
    const reportContent = `
        <div style="text-align: center; font-family: Arial, sans-serif;">
            <img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo" style="max-width: 100px; display: block; margin: 0 auto;">
            <h2 style="margin: 5px 0;">NACHU COMPREHENSIVE SCHOOL Pathway Report</h2>
            <p>561-00902 Kikuyu KENYA </p>
            <p>Phone: +254-700-123456</p>
            <p style="font-style: italic; font-weight: bold;">School Motto: "Excellence Through Knowledge"</p>
            <p><strong>Year: 2025</strong></p>
        </div>
        <hr>
        ${mainTableHTML}
        <br>
        <h3 style="text-align: center;">Pathway Summary</h3>
        ${summaryTableHTML}
    `;

    // Open print window and include the complete report content
    const printWindow = window.open("", "", "width=900,height=600");
    printWindow.document.write(`
        <html>
        <head>
            <title>Career Pathway Report</title>
            <style>
                body { font-family: Arial, sans-serif; text-align: center; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                th, td { border: 1px solid black; padding: 5px; }
                th { background-color: #f2f2f2; }
            </style>
        </head>
        <body>
            ${reportContent}
            <br><button onclick="window.print()">Print Report</button>
        </body>
        </html>
    `);
    printWindow.document.close();
}


function deleteMarksTable() {
    var tableElement = document.querySelector(".report-table"); // Find the table
    var marksHeader = document.getElementById("marksHeader"); // Find the header
    var marksList = document.getElementById("marksList"); // Find table body

    if (tableElement) {
        showCustomConfirm(
            `Are you sure you want to delete the <span style="color: red; font-weight: bold;">entire marks table</span>?`,
            function () {  // Ensure the function executes on "Yes"
                // Remove from UI
                tableElement.remove();
                if (marksHeader) marksHeader.innerHTML = ""; // Clear the header
                if (marksList) marksList.innerHTML = ""; // Clear the table content

                // Remove marks data from local storage
                localStorage.removeItem("marksTableData");

                showCustomAlert(`<span style="color: green; font-weight: bold;">Marks table deleted successfully!</span>`);
            }
        );
    } else {
        showCustomAlert(`<span style="color: red; font-weight: bold;">Error: Marks table not found.</span>`);
    }
}

function showCustomConfirm(message, onConfirm) {
    let confirmBox = document.createElement("div");
    confirmBox.innerHTML = `<div style="
        position: fixed; 
        top: 20%; 
        left: 50%; 
        transform: translate(-50%, -50%);
        background-color: #fff3cd;
        border: 2px solid orange;
        padding: 15px;
        text-align: center;
        font-size: 16px;
        font-weight: bold;
        color: black;
        border-radius: 10px;
        box-shadow: 0px 4px 10px rgba(0,0,0,0.3);
        z-index: 1000;">
        ${message}
        <br><br>
        <button id="confirmYes" style="
            background: red; 
            color: white; 
            padding: 8px 15px; 
            border: none; 
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;">Yes</button>
        <button onclick="this.parentElement.remove()" style="
            background: gray; 
            color: white; 
            padding: 8px 15px; 
            border: none; 
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;">No</button>
    </div>`;

    document.body.appendChild(confirmBox);

    // Attach the confirmation function to the "Yes" button
    document.getElementById("confirmYes").addEventListener("click", function () {
        onConfirm();  // Call the actual delete function
        confirmBox.remove();  // Remove confirmation box
    });
}
function generateMeritList() {
    let selectedGrade = document.getElementById("gradeSelect").value;

    // Helper function to show a styled alert
    function showAlert(message, color) {
        const alertDiv = document.createElement("div");
        alertDiv.textContent = message;
        alertDiv.style.position = "fixed";
        alertDiv.style.top = "20px";
        alertDiv.style.left = "50%";
        alertDiv.style.transform = "translateX(-50%)";
        alertDiv.style.padding = "10px 20px";
        alertDiv.style.backgroundColor = color;
        alertDiv.style.color = "white";
        alertDiv.style.borderRadius = "5px";
        alertDiv.style.boxShadow = "0 4px 6px rgba(0, 0, 0, 0.1)";
        alertDiv.style.fontFamily = "Arial, sans-serif";
        alertDiv.style.zIndex = "1000";
        document.body.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }

    if (!selectedGrade) {
        showAlert("Please select a grade.", "#FF9800"); // Orange for warning
        return;
    }

    let learnersTable = document.getElementById("learnersList");
    if (!learnersTable) {
        showAlert("Registered learners table not found.", "#F44336"); // Red for error
        return;
    }

    let learners = [];
    let rows = learnersTable.getElementsByTagName("tr");

    for (let i = 0; i < rows.length; i++) {
        let cells = rows[i].getElementsByTagName("td");
        if (cells.length > 0) {
            let grade = cells[4].innerText.trim();
            let name = cells[2].innerText.trim();

            if (grade === selectedGrade) {
                learners.push(name);
            }
        }
    }

    if (learners.length === 0) {
        showAlert("No learners found in the selected grade.", "#FF9800"); // Orange for warning
        return;
    }

    let meritListHTML = `
        <div id="meritList" style="text-align: center; font-family: Arial, sans-serif;">
            <div style="display: flex; align-items: center; justify-content: center;">
                <img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo" style="width: 80px; margin-right: 10px;">
            </div>
            <h2 style="margin: 5px 0; font-size: 20px; font-weight: bold;">NACHU COMPREHENSIVE SCHOOL MERIT LIST</h2>
            <p style="margin: 2px 0; font-size: 14px;"><strong>561-00902 Kikuyu KENYA</strong></p>
            <p style="margin: 2px 0; font-size: 14px;"><strong>Phone: +254-700-123456</strong></p>
            <p style="margin: 2px 0; font-size: 14px;"><strong>School Motto: "Excellence Through Knowledge"</strong></p>
            <p style="margin: 5px 0; font-size: 16px;"><strong>Year: 2025</strong></p>
            <p style="font-size: 16px; font-weight: bold; text-decoration: underline;">Grade: ${selectedGrade}</p>

            <table border="1" cellspacing="0" cellpadding="5" style="width: 100%; border-collapse: collapse; text-align: center; border: 2px solid black;">
                <thead style="background-color: #f0f0f0; font-weight: bold;">
                    <tr>
                        <th>No.</th>
                        <th>Learner</th>
                        <th>Grade</th>
                        <th>Eng</th><th>Lev</th>
                        <th>Math</th><th>Lev</th>
                        <th>Pre-Tech</th><th>Lev</th>
                        <th>Kisw</th><th>Lev</th>
                        <th>Scie</th><th>Lev</th>
                        <th>Sst</th><th>Lev</th>
                        <th>Agric</th><th>Lev</th>
                        <th>Cre</th><th>Lev</th>
                        <th>C/A</th><th>Lev</th>
                        <th>Total Marks</th>
                    </tr>
                </thead>
                <tbody>`;

    learners.forEach((learner, index) => {
        meritListHTML += `
            <tr>
                <td style="border: 2px solid black;">${index + 1}</td>
                <td style="border: 2px solid black;">${learner}</td>
                <td style="border: 2px solid black;">${selectedGrade}</td>
                <td style="border: 2px solid black;"></td><td style="border: 2px solid black;"></td>
                <td style="border: 2px solid black;"></td><td style="border: 2px solid black;"></td>
                <td style="border: 2px solid black;"></td><td style="border: 2px solid black;"></td>
                <td style="border: 2px solid black;"></td><td style="border: 2px solid black;"></td>
                <td style="border: 2px solid black;"></td><td style="border: 2px solid black;"></td>
                <td style="border: 2px solid black;"></td><td style="border: 2px solid black;"></td>
                <td style="border: 2px solid black;"></td><td style="border: 2px solid black;"></td>
                <td style="border: 2px solid black;"></td><td style="border: 2px solid black;"></td>
                <td style="border: 2px solid black;"></td>
            </tr>`;
    });

    meritListHTML += `
        </tbody>
        </table>
        </div>
        <button onclick="printMeritList()" id="printBtn" style="display:block; margin-top:10px;">Print</button>`;

    document.getElementById("meritListContainer").innerHTML = meritListHTML;
    document.getElementById("meritListContainer").style.display = "block";

    showAlert("Merit list generated successfully!", "#4CAF50"); // Green for success
}


function printMeritList() {
    let printContent = document.getElementById("meritList").innerHTML;
    let newWin = window.open("", "", "width=900,height=650");
    newWin.document.write("<html><head><title>Print Merit List</title></head><body>");
    newWin.document.write(printContent);
    newWin.document.write("</body></html>");
    newWin.document.close();
    newWin.print();
}
function toggleMeritList() {
    let meritList = document.getElementById("meritListContainer");
    let toggleBtn = document.getElementById("toggleBtn");

    if (meritList.style.display === "none") {
        meritList.style.display = "block";
        toggleBtn.innerHTML = `<i class="fas fa-eye-slash"></i> Hide Merit List`;
    } else {
        meritList.style.display = "none";
        toggleBtn.innerHTML = `<i class="fas fa-eye"></i> Show Merit List`;
    }
}
 // Initialize fee details from localStorage
    let feeDetails = JSON.parse(localStorage.getItem("feeDetails")) || [];

    // Function to determine constant fee based on grade
    function getConstantFee(grade) {
      if (["1", "2", "3"].includes(grade)) {
        return 4000;
      } else if (["4", "5", "6"].includes(grade)) {
        return 6000;
      } else if (["7", "8", "9"].includes(grade)) {
        return 7000;
      } else {
        return 0;
      }
    }

    // Handle fee form submission
    document.getElementById("feeForm").addEventListener("submit", function (e) {
  e.preventDefault();
  const learnerName = document.getElementById("feeLearnerName").value;
  const learnerGrade = document.getElementById("feeLearnerGrade").value;
  const securityFee = parseFloat(document.getElementById("securityFee").value);
  const bomFee = parseFloat(document.getElementById("bomFee").value);
  const tuitionFee = parseFloat(document.getElementById("tuitionFee").value);
  const exam1Fee = parseFloat(document.getElementById("exam1Fee").value);
  const exam2Fee = parseFloat(document.getElementById("exam2Fee").value);
  const exam3Fee = parseFloat(document.getElementById("exam3Fee").value);
  const activityFee = parseFloat(document.getElementById("activityFee").value);

  const constantFee = getConstantFee(learnerGrade);
  const totalPaid = securityFee + bomFee + tuitionFee + exam1Fee + exam2Fee + exam3Fee + activityFee;
  const balance = constantFee - totalPaid;

  const feeDetail = {
    id: Date.now(),
    name: learnerName,
    grade: learnerGrade,
    securityFee,
    bomFee,
    tuitionFee,
    exam1Fee,
    exam2Fee,
    exam3Fee,
    activityFee,
    constantFee,
    totalPaid,
    balance
  };

  feeDetails.push(feeDetail);
  localStorage.setItem("feeDetails", JSON.stringify(feeDetails));
  updateFeeSummaryTable();
  
  showCustomAlert(); // Show the new colored alert
  document.getElementById("feeForm").reset();
});

    // Update fee summary table
    function updateFeeSummaryTable() {
      const feeSummaryTableBody = document.getElementById("feeSummaryTableBody");
      feeSummaryTableBody.innerHTML = "";
      feeDetails.forEach((detail, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${index + 1}</td>
          <td contenteditable="true" onblur="updateDetail(${detail.id}, 'name', this.textContent)">${detail.name}</td>
          <td contenteditable="true" onblur="updateDetail(${detail.id}, 'grade', this.textContent)">${detail.grade}</td>
          <td contenteditable="true" onblur="updateDetail(${detail.id}, 'securityFee', this.textContent)">${detail.securityFee}</td>
          <td contenteditable="true" onblur="updateDetail(${detail.id}, 'bomFee', this.textContent)">${detail.bomFee}</td>
          <td contenteditable="true" onblur="updateDetail(${detail.id}, 'tuitionFee', this.textContent)">${detail.tuitionFee}</td>
          <td contenteditable="true" onblur="updateDetail(${detail.id}, 'exam1Fee', this.textContent)">${detail.exam1Fee}</td>
          <td contenteditable="true" onblur="updateDetail(${detail.id}, 'exam2Fee', this.textContent)">${detail.exam2Fee}</td>
          <td contenteditable="true" onblur="updateDetail(${detail.id}, 'exam3Fee', this.textContent)">${detail.exam3Fee}</td>
          <td contenteditable="true" onblur="updateDetail(${detail.id}, 'activityFee', this.textContent)">${detail.activityFee}</td>
          <td>${detail.constantFee}</td>
          <td>${detail.totalPaid}</td>
          <td>${detail.balance}</td>
          <td>
            <button onclick="generateReceipt(${detail.id})">Generate Receipt</button>
            <button onclick="deleteDetail(${detail.id})">Delete</button>
          </td>
        `;
        feeSummaryTableBody.appendChild(row);
      });
    }

    // Update fee detail on cell blur
    function updateDetail(id, key, value) {
      const detail = feeDetails.find(d => d.id === id);
      if (detail) {
        detail[key] = parseFloat(value) || value;
        detail.totalPaid = detail.securityFee + detail.bomFee + detail.tuitionFee + detail.exam1Fee + detail.exam2Fee + detail.exam3Fee + detail.activityFee;
        detail.balance = detail.constantFee - detail.totalPaid;
        localStorage.setItem("feeDetails", JSON.stringify(feeDetails));
        updateFeeSummaryTable();
      }
    }

    // Delete fee detail
    function deleteDetail(id) {
      feeDetails = feeDetails.filter(d => d.id !== id);
      localStorage.setItem("feeDetails", JSON.stringify(feeDetails));
      updateFeeSummaryTable();
    }

    // Generate receipt for a learner
    function generateReceipt(id) {
      const detail = feeDetails.find(d => d.id === id);
      if (detail) {
        document.getElementById("receiptNo").innerText = Math.floor(1000 + Math.random() * 9000);
        document.getElementById("receiptDate").innerText = new Date().toLocaleDateString();
        document.getElementById("receiptLearner").innerText = detail.name;
        document.getElementById("receiptGrade").innerText = detail.grade;
        document.getElementById("receiptTotal").innerText = detail.totalPaid + detail.balance;
        document.getElementById("receiptPaid").innerText = detail.totalPaid;
        document.getElementById("receiptBalance").innerText = detail.balance;

        const receiptTableBody = document.getElementById("receiptTableBody");
        receiptTableBody.innerHTML = `
          <tr><td>Security Fee</td><td>KSH ${detail.securityFee}</td></tr>
          <tr><td>BOM Fee</td><td>KSH ${detail.bomFee}</td></tr>
          <tr><td>Tuition Fee</td><td>KSH ${detail.tuitionFee}</td></tr>
          <tr><td>Exam 1 Fee</td><td>KSH ${detail.exam1Fee}</td></tr>
          <tr><td>Exam 2 Fee</td><td>KSH ${detail.exam2Fee}</td></tr>
          <tr><td>Exam 3 Fee</td><td>KSH ${detail.exam3Fee}</td></tr>
          <tr><td>Activity Fee</td><td>KSH ${detail.activityFee}</td></tr>
        `;
        document.getElementById("receiptContainer").style.display = "block";
      }
    }

    // Print receipt (single definition with page reload after printing)
    function printReceipt() {
      const receiptContent = document.getElementById("receiptContainer").innerHTML;
      const originalContent = document.body.innerHTML;
      document.body.innerHTML = receiptContent;
      window.print();
      document.body.innerHTML = originalContent;
      location.reload();
    }

    // Download receipt as PDF
    function downloadReceiptPDF() {
      const receipt = document.getElementById('receiptContainer');
      html2pdf(receipt, {
        margin: 10,
        filename: 'Fee_Receipt.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      });
    }

    // Filter fee records by grade
    function filterFeeRecords() {
      const selectedGrade = document.getElementById("gradeFilter").value;
      const table = document.getElementById("feeSummaryTable");
      const rows = table.getElementsByTagName("tr");

      for (let i = 1; i < rows.length; i++) {
        const gradeCell = rows[i].getElementsByTagName("td")[2];
        if (gradeCell) {
          const grade = gradeCell.textContent || gradeCell.innerText;
          rows[i].style.display = (selectedGrade === "" || grade === selectedGrade) ? "" : "none";
        }
      }
    }

    // Print filtered fee records
    function printFilteredFeeRecords() {
      const selectedGrade = document.getElementById("gradeFilter").value;
      const currentYear = new Date().getFullYear();
      document.getElementById("currentYear").innerText = currentYear;
      document.getElementById("selectedGrade").innerText = selectedGrade ? `Grade ${selectedGrade}` : "All Grades";
      const feeTableBody = document.getElementById("filteredFeeTableBody");
      feeTableBody.innerHTML = "";

      const filteredDetails = selectedGrade ? feeDetails.filter(d => d.grade == selectedGrade) : feeDetails;
      if (filteredDetails.length === 0) {
        feeTableBody.innerHTML = `<tr><td colspan="11" style="text-align: center; padding: 10px;">No records found</td></tr>`;
      } else {
        filteredDetails.forEach((detail, index) => {
          feeTableBody.innerHTML += `
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;">${index + 1}</td>
              <td style="border: 1px solid #ddd; padding: 8px;">${detail.name}</td>
              <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.securityFee}</td>
              <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.bomFee}</td>
              <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.tuitionFee}</td>
              <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.exam1Fee}</td>
              <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.exam2Fee}</td>
              <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.exam3Fee}</td>
              <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.activityFee}</td>
              <td style="border: 1px solid #ddd; padding: 8px; color: green;">KSH ${detail.totalPaid}</td>
              <td style="border: 1px solid #ddd; padding: 8px; color: red;">KSH ${detail.balance}</td>
            </tr>
          `;
        });
      }
      document.getElementById("filteredFeeTableContainer").style.display = "block";
    }

    // Print filtered fee table
    function printFilteredFeeTable() {
      const printContent = document.getElementById('filteredFeeTableContainer').innerHTML;
      const originalContent = document.body.innerHTML;
      document.body.innerHTML = printContent;
      window.print();
      document.body.innerHTML = originalContent;
    }

    // Download filtered fee table as PDF
    function downloadFeeTablePDF() {
      const table = document.getElementById('filteredFeeTableContainer');
      html2pdf(table, {
        margin: 10,
        filename: 'Filtered_Fee_Records.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
      });
    }

    // Toggle visibility functions
    function toggleFeeCaptureForm() {
      const feeForm = document.getElementById("feeCaptureForm");
      feeForm.style.display = (feeForm.style.display === "none" || feeForm.style.display === "") ? "block" : "none";
    }

    function toggleFeeSummaryAndReceipt() {
      const feeSummaryTable = document.getElementById("feeSummaryTableContainer");
      const receiptContainer = document.getElementById("receiptContainer");
      if (feeSummaryTable.style.display === "none" || feeSummaryTable.style.display === "") {
        feeSummaryTable.style.display = "block";
        receiptContainer.style.display = "block";
      } else {
        feeSummaryTable.style.display = "none";
        receiptContainer.style.display = "none";
      }
    }

    function toggleFeeActionsMenu() {
      const menu = document.getElementById("feeActionsBox");
      menu.style.display = (menu.style.display === "none" || menu.style.display === "") ? "block" : "none";
    }

    // Payment Summary generation and toggle
    function generatePaymentSummary() {
      const summaryContainer = document.getElementById("paymentSummaryContainer");
      const summaryBody = document.getElementById("paymentSummaryBody");
      summaryBody.innerHTML = "";
      const feeRows = document.querySelectorAll("#feeSummaryTable tbody tr");
      const gradeSummary = {};

      feeRows.forEach((row) => {
        const cells = row.getElementsByTagName("td");
        const grade = cells[2].innerText.trim();
        const totalPaid = parseFloat(cells[11].innerText) || 0;
        const constantFee = parseFloat(cells[10].innerText) || 0;

        if (!gradeSummary[grade]) {
          gradeSummary[grade] = { totalPaid: 0, learnerCount: 0, constantFee: constantFee };
        }
        gradeSummary[grade].totalPaid += totalPaid;
        gradeSummary[grade].learnerCount += 1;
      });

      for (let grade in gradeSummary) {
        let expectedTotal = gradeSummary[grade].constantFee * gradeSummary[grade].learnerCount;
        let balance = expectedTotal - gradeSummary[grade].totalPaid;
        let status = (balance === 0) ? "Cleared" : (balance > 0) ? `KSH ${balance} Due` : `Overpaid by KSH ${Math.abs(balance)}`;
        summaryBody.innerHTML += `<tr>
                                    <td>${grade}</td>
                                    <td>KSH ${gradeSummary[grade].totalPaid.toLocaleString()}</td>
                                    <td>KSH ${expectedTotal.toLocaleString()}</td>
                                    <td>KSH ${balance.toLocaleString()}</td>
                                    <td>${status}</td>
                                  </tr>`;
      }
      summaryContainer.style.display = "block";
    }

    function togglePaymentSummary() {
      const summaryContainer = document.getElementById("paymentSummaryContainer");
      if (summaryContainer.style.display === "none" || summaryContainer.style.display === "") {
        generatePaymentSummary();
        summaryContainer.style.display = "block";
      } else {
        summaryContainer.style.display = "none";
      }
    }

    function printPaymentSummaryOnly() {
      const printContent = document.getElementById("summaryTable").outerHTML;
      const newWindow = window.open("", "", "width=800, height=600");
      newWindow.document.write("<html><head><title>Payment Summary</title><style>");
      newWindow.document.write("body { font-family: Arial, sans-serif; text-align: center; }");
      newWindow.document.write("table { width: 100%; border-collapse: collapse; border: 2px solid black; margin-top: 20px; }");
      newWindow.document.write("th, td { border: 2px solid black; padding: 10px; text-align: center; }");
      newWindow.document.write("h2, h3, p { text-align: center; margin: 5px 0; }");
      newWindow.document.write("</style></head><body>");
      newWindow.document.write("<h2>NACHU COMPREHENSIVE SCHOOL</h2>");
      newWindow.document.write("<p>561-00902 Kikuyu Kenya</p>");
      newWindow.document.write("<p>Phone: +254-700-123456</p>");
      newWindow.document.write("<p><strong>School Motto:</strong> Excellence Through Knowledge</p>");
      newWindow.document.write("<h3>Year: 2025</h3>");
      newWindow.document.write("<h2 style='background: #4CAF50; color: white; padding: 10px;'>Payment Summary Per Grade</h2>");
      newWindow.document.write(printContent);
      newWindow.document.write("</body></html>");
      newWindow.document.close();
      newWindow.print();
    }
function archiveFeesTable() {
  const feeTable = document.getElementById("feeSummaryTable");
  if (!feeTable || feeTable.rows.length <= 1) {
    alert("No fee records to archive.");
    return;
  }

  const currentYear = new Date().getFullYear();
  let savedArchives = JSON.parse(localStorage.getItem("archivedFeesHTML")) || {};

  if (savedArchives[currentYear]) {
    // Show confirmation alert instead of window.confirm()
    document.getElementById("archiveYear").innerText = currentYear;
    document.getElementById("archiveConfirmAlert").style.display = "block";
  } else {
    // Proceed with archiving if no existing archive
    saveArchive(currentYear, feeTable);
  }
}

// Function to handle archive confirmation
function confirmArchive(update) {
  const currentYear = new Date().getFullYear();
  document.getElementById("archiveConfirmAlert").style.display = "none"; // Hide confirmation alert

  if (update) {
    // Proceed with updating the archive
    saveArchive(currentYear, document.getElementById("feeSummaryTable"));
  }
}

// Function to save or update the archive
function saveArchive(year, table) {
  let savedArchives = JSON.parse(localStorage.getItem("archivedFeesHTML")) || {};
  const timestamp = new Date().toLocaleString();
  let archiveEntry = `<div class="archived-fees-record">
                        <h3>Archived for Year: ${year} (Updated on: ${timestamp})</h3>
                        ${table.outerHTML}
                      </div>`;

  savedArchives[year] = archiveEntry;
  localStorage.setItem("archivedFeesHTML", JSON.stringify(savedArchives));

  // Show success message
  document.getElementById("successYear").innerText = year;
  document.getElementById("archiveSuccessAlert").style.display = "block";

  // Hide the success alert after 3 seconds
  setTimeout(() => {
    document.getElementById("archiveSuccessAlert").style.display = "none";
  }, 3000);

  viewArchivedFees();
}

// Display all archived fee records from localStorage
function viewArchivedFees() {
  try {
    const savedArchives = JSON.parse(localStorage.getItem("archivedFeesHTML")) || {};
    const archivedFeesContainer = document.getElementById("archivedFeesContainer");
    const archivedFeesList = document.getElementById("archivedFeesList");

    if (Object.keys(savedArchives).length === 0) {
      archivedFeesContainer.style.display = "none";
      alert("No archived fee records found.");
      return;
    }

    let archiveContent = "";
    for (const year in savedArchives) {
      archiveContent += `
        <div class="archive-year" style="border-bottom: 1px solid #ddd; margin-bottom: 10px; padding-bottom: 10px;">
          <h3>Archived Fees for ${year}</h3>
          <button onclick="printArchivedFees('${year}')" style="margin-bottom: 10px; padding: 5px 10px; background: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px;">
            <i class="fas fa-print"></i> Print This Archive
          </button>
          <div id="archivedTable-${year}">
            ${savedArchives[year]}
          </div>
        </div>
      `;
    }

    archivedFeesList.innerHTML = archiveContent;
    archivedFeesContainer.style.display = "block";
  } catch (error) {
    console.error("Error retrieving archived fee records:", error);
    alert("An error occurred while retrieving archived fee records.");
  }
}


    // Generate learner receipt from archived fees
    function generateLearnerReceipt(learnerName) {
      const savedArchives = JSON.parse(localStorage.getItem("archivedFeesHTML")) || {};
      if (Object.keys(savedArchives).length === 0) {
        alert("No archived fee records available.");
        return;
      }
      const tempDiv = document.createElement("div");
      for (let year in savedArchives) {
        tempDiv.innerHTML += savedArchives[year];
      }
      const tables = tempDiv.getElementsByTagName("table");
      for (let table of tables) {
        for (let row of table.rows) {
          if (row.cells.length > 0 && row.cells[1].innerText.trim() === learnerName.trim()) {
            const receiptContent = `
              <h2>Fee Receipt</h2>
              <p><strong>Learner:</strong> ${row.cells[1].innerText}</p>
              <p><strong>Grade:</strong> ${row.cells[2].innerText}</p>
              <p><strong>Security Fee:</strong> ${row.cells[3].innerText} KSH</p>
              <p><strong>BOM Fee:</strong> ${row.cells[4].innerText} KSH</p>
              <p><strong>Tuition Fee:</strong> ${row.cells[5].innerText} KSH</p>
              <p><strong>Exam 1 Fee:</strong> ${row.cells[6].innerText} KSH</p>
              <p><strong>Exam 2 Fee:</strong> ${row.cells[7].innerText} KSH</p>
              <p><strong>Exam 3 Fee:</strong> ${row.cells[8].innerText} KSH</p>
              <p><strong>Activity Fee:</strong> ${row.cells[9].innerText} KSH</p>
              <p><strong>Constant Fee:</strong> ${row.cells[10].innerText} KSH</p>
              <p><strong>Total Paid:</strong> ${row.cells[11].innerText} KSH</p>
              <p><strong>Balance:</strong> ${row.cells[12].innerText} KSH</p>
              <hr>
              <p><em>Thank you for your payment!</em></p>
            `;
            const receiptWindow = window.open("", "_blank");
            receiptWindow.document.write(receiptContent);
            receiptWindow.document.close();
            receiptWindow.print();
            return;
          }
        }
      }
      alert("Learner not found in archived records.");
    }

    // Stub for exportToExcel function (implement as needed)
    function exportToExcel(table, filename) {
      console.log("Exporting table to Excel as: " + filename);
    }

    // Initialize fee summary table on page load
    updateFeeSummaryTable();

    // Optional: onload actions
    window.onload = function() {
      const savedArchives = JSON.parse(localStorage.getItem("archivedFeesHTML")) || {};
      if (Object.keys(savedArchives).length > 0) {
        console.log("Archived fees loaded from storage.");
      }
    };
function togglePrintFilteredRecords() {
  const container = document.getElementById("filteredFeeTableContainer");
  const btn = document.getElementById("togglePrintFilteredRecordsBtn");
  
  // If container is visible, hide it and update button text
  if (container.style.display === "block") {
    container.style.display = "none";
    btn.innerHTML = '<i class="fas fa-print"></i> Show Filtered Records';
  } else {
    // Update the filtered table content first
    const selectedGrade = document.getElementById("gradeFilter").value;
    const currentYear = new Date().getFullYear();
    document.getElementById("currentYear").innerText = currentYear;
    document.getElementById("selectedGrade").innerText = selectedGrade ? `Grade ${selectedGrade}` : "All Grades";
    
    const feeTableBody = document.getElementById("filteredFeeTableBody");
    feeTableBody.innerHTML = ""; // Clear previous content

    // Filter fee details by grade (if selected) or show all
    const filteredDetails = selectedGrade ? feeDetails.filter(d => d.grade == selectedGrade) : feeDetails;
    
    if (filteredDetails.length === 0) {
      feeTableBody.innerHTML = `<tr><td colspan="11" style="text-align: center; padding: 10px;">No records found</td></tr>`;
    } else {
      filteredDetails.forEach((detail, index) => {
        feeTableBody.innerHTML += `
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">${index + 1}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${detail.name}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.securityFee}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.bomFee}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.tuitionFee}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.exam1Fee}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.exam2Fee}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.exam3Fee}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.activityFee}</td>
            <td style="border: 1px solid #ddd; padding: 8px; color: green;">KSH ${detail.totalPaid}</td>
            <td style="border: 1px solid #ddd; padding: 8px; color: red;">KSH ${detail.balance}</td>
          </tr>
        `;
      });
    }
    
    // Show the filtered records container and update button text
    container.style.display = "block";
    btn.innerHTML = '<i class="fas fa-print"></i> Hide Filtered Records';
  }
}
function toggleViewArchivedFees() {
  const container = document.getElementById("archivedFeesContainer");
  const btn = document.getElementById("toggleViewArchivedBtn");

  // If container is visible, hide it and update button text
  if (container.style.display === "block") {
    container.style.display = "none";
    btn.innerHTML = '<i class="fas fa-eye"></i> View Archived Fees';
  } else {
    // Otherwise, display the container
    viewArchivedFees(); // Refresh or load the archived fees content
    container.style.display = "block";
    btn.innerHTML = '<i class="fas fa-eye"></i> Hide Archived Fees';
  }
}
// Closes all fee action sections
function closeAllFeeActionSections() {
  const sections = [
    "feeCaptureForm", 
    "feeSummaryTableContainer", 
    "receiptContainer", 
    "filteredFeeTableContainer", 
    "archivedFeesContainer", 
    "paymentSummaryContainer"
  ];
  sections.forEach(id => {
    const sec = document.getElementById(id);
    if (sec) sec.style.display = "none";
  });
}

// Generic function to toggle a group of sections
function toggleFeeActionGroup(sectionIds) {
  // Check if any of the sections in the group is currently visible
  const isAnyOpen = sectionIds.some(id => {
    const sec = document.getElementById(id);
    return sec && sec.style.display === "block";
  });

  // If any is open, close them; otherwise, close all and then open the group
  if (isAnyOpen) {
    sectionIds.forEach(id => {
      const sec = document.getElementById(id);
      if (sec) sec.style.display = "none";
    });
  } else {
    closeAllFeeActionSections();
    sectionIds.forEach(id => {
      const sec = document.getElementById(id);
      if (sec) sec.style.display = "block";
    });
  }
}
function filterArchivedFees() {
  const input = document.getElementById("archivedGradeFilter").value.toLowerCase();
  const archiveEntries = document.querySelectorAll("#archivedFeesList .archive-year");

  archiveEntries.forEach(entry => {
    const tableRows = entry.querySelectorAll("table tbody tr");
    let found = false;

    tableRows.forEach(row => {
      const gradeCell = row.cells[2]?.innerText.toLowerCase(); // Assuming Grade is in the 3rd column
      if (gradeCell && gradeCell.includes(input)) {
        row.style.display = "";
        found = true;
      } else {
        row.style.display = "none";
      }
    });

    // Hide/archive section if no rows match the filter
    entry.style.display = found ? "block" : "none";
  });
}

function printArchivedFees(year) {
  const archivedTable = document.getElementById(`archivedTable-${year}`);

  if (!archivedTable) {
    alert("No archived records found for " + year);
    return;
  }

  // Clone the table and remove hidden rows (filtered-out rows)
  const clonedTable = archivedTable.cloneNode(true);
  const rows = clonedTable.getElementsByTagName("tr");

  for (let i = rows.length - 1; i >= 0; i--) {
    if (rows[i].style.display === "none") {
      rows[i].remove(); // Remove hidden rows
    }
  }

  const printWindow = window.open("", "", "width=900,height=600");
  printWindow.document.write(`
    <html>
    <head>
      <title>Archived Fees for ${year}</title>
      <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .header-container { text-align: center; margin-bottom: 20px; }
        .header-container img { max-width: 80px; }
        .header-container h2, .header-container p { margin: 5px 0; }

        /* Table Styling */
        table { 
          width: 100%; 
          border-collapse: collapse; 
          margin-top: 20px; 
        }
        th, td { 
          border: 2px solid black;  /* Ensures visible black borders */
          padding: 8px; 
          text-align: left; 
        }
        th { 
          background: #4CAF50; 
          color: white; 
          font-weight: bold; 
        }
        tr:nth-child(even) { 
          background: #f2f2f2; 
        }
      </style>
    </head>
    <body>
      <div class="header-container">
        <img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo">
        <h2>NACHU COMPREHENSIVE SCHOOL</h2>
        <h3>Archived Fee Records for ${year}</h3>
        <p><strong>561-00902 Kikuyu KENYA</strong></p>
        <p><strong>Phone: +254-700-123456</strong></p>
        <p><strong>School Motto:</strong> "Excellence Through Knowledge"</p>
        <p><strong>Year:</strong> ${year}</p>
        <hr>
      </div>
      
      ${clonedTable.outerHTML}

    </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.print();
}
function deleteFeeRecordsTable() {
  const confirmation = confirm("?? Are you sure you want to delete all fee records? This action cannot be undone.");

  if (confirmation) {
    // Clear the table body
    document.getElementById("feeSummaryTableBody").innerHTML = "";

    // Remove fee details from localStorage
    localStorage.removeItem("feeDetails");

    // Custom alert with a red background
    showCustomAlert(" All fee records have been deleted successfully!", "red");
  }
}
function showDeleteConfirmation(message) {
  document.getElementById("deleteMessage").innerText = message;
  document.getElementById("deleteConfirmModal").style.display = "block";
}


function closeDeleteModal() {
  document.getElementById("deleteConfirmModal").style.display = "none";
}

function confirmDeleteFeeRecords() {
  // Close the modal immediately
  closeDeleteModal();

  // Clear the table
  document.getElementById("feeSummaryTableBody").innerHTML = "";

  // Remove fee details from localStorage
  localStorage.removeItem("feeDetails");

  // Delay the alert slightly to ensure visibility
  setTimeout(() => {
    showCustomAlert("? All fee records have been deleted successfully!", "red");
  }, 300); // 300ms delay to ensure the modal closes first
}


function deleteFeeRecordsTable() {
  showDeleteConfirmation(" Are you sure you want to delete all fee records? This action cannot be undone.");
}

function showCustomAlert(message, color) {
  // Remove any existing alert
  const existingAlert = document.getElementById("customAlert");
  if (existingAlert) existingAlert.remove();

  // Create a new alert box
  const alertBox = document.createElement("div");
  alertBox.id = "customAlert";
  alertBox.innerHTML = message;
  alertBox.style.cssText = `
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: ${color};
    color: white;
    padding: 15px;
    font-size: 16px;
    border-radius: 5px;
    z-index: 1000;
    box-shadow: 0px 4px 10px rgba(0,0,0,0.2);
    text-align: center;
  `;

  document.body.appendChild(alertBox);

  // Remove alert after 3 seconds
  setTimeout(() => {
    alertBox.remove();
  }, 3000);
}


function showCustomAlert(message, color) {
  // Remove any existing alert
  const existingAlert = document.getElementById("customAlert");
  if (existingAlert) existingAlert.remove();

  // Create a new alert box
  const alertBox = document.createElement("div");
  alertBox.id = "customAlert";
  alertBox.innerHTML = message;
  alertBox.style.cssText = `
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: ${color};
    color: white;
    padding: 15px;
    font-size: 16px;
    border-radius: 5px;
    z-index: 1000;
    box-shadow: 0px 4px 10px rgba(0,0,0,0.2);
    text-align: center;
  `;

  document.body.appendChild(alertBox);

  // Remove alert after 3 seconds
  setTimeout(() => {
    alertBox.remove();
  }, 3000);
}
function showCustomAlert() {
  const alertBox = document.getElementById("customAlert");
  alertBox.style.display = "block";
  
  // Hide the alert after 3 seconds
  setTimeout(() => {
    alertBox.style.display = "none";
  }, 3000);
}

function showArchiveAlert() {
  const alertBox = document.getElementById("archiveAlert");
  alertBox.style.display = "block";

  // Hide the alert after 3 seconds
  setTimeout(() => {
    alertBox.style.display = "none";
  }, 3000);
}

function displayCategoryCollectionSummary() {
  const feeTable = document.getElementById("feeSummaryTableBody");
  if (!feeTable) {
    alert("Fee summary table not found.");
    return;
  }

  const categoryTotals = {};

  feeTable.querySelectorAll("tr").forEach(row => {
    const cells = row.getElementsByTagName("td");
    if (cells.length > 1) {
      const grade = cells[2].textContent.trim();
      const securityFee = parseFloat(cells[3].textContent) || 0;
      const bomFee = parseFloat(cells[4].textContent) || 0;
      const tuitionFee = parseFloat(cells[5].textContent) || 0;
      const exam1Fee = parseFloat(cells[6].textContent) || 0;
      const exam2Fee = parseFloat(cells[7].textContent) || 0;
      const exam3Fee = parseFloat(cells[8].textContent) || 0;
      const activityFee = parseFloat(cells[9].textContent) || 0;
      const totalPaid = parseFloat(cells[11].textContent) || 0;

      if (!categoryTotals[grade]) {
        categoryTotals[grade] = { securityFee: 0, bomFee: 0, tuitionFee: 0, exam1Fee: 0, exam2Fee: 0, exam3Fee: 0, activityFee: 0, totalCollected: 0 };
      }

      categoryTotals[grade].securityFee += securityFee;
      categoryTotals[grade].bomFee += bomFee;
      categoryTotals[grade].tuitionFee += tuitionFee;
      categoryTotals[grade].exam1Fee += exam1Fee;
      categoryTotals[grade].exam2Fee += exam2Fee;
      categoryTotals[grade].exam3Fee += exam3Fee;
      categoryTotals[grade].activityFee += activityFee;
      categoryTotals[grade].totalCollected += totalPaid;
    }
  });

  let summaryTableHTML = `
    <h2 style="color: #4CAF50; text-align: center;">Fee Collection Summary Per Grade</h2>
    <table style="width: 100%; border-collapse: collapse; text-align: center; margin-top: 10px;">
      <thead>
        <tr style="background: #4CAF50; color: white;">
          <th style="border: 1px solid black; padding: 10px;">Grade</th>
          <th style="border: 1px solid black; padding: 10px;">Security Fee</th>
          <th style="border: 1px solid black; padding: 10px;">BOM Fee</th>
          <th style="border: 1px solid black; padding: 10px;">Tuition Fee</th>
          <th style="border: 1px solid black; padding: 10px;">Exam 1 Fee</th>
          <th style="border: 1px solid black; padding: 10px;">Exam 2 Fee</th>
          <th style="border: 1px solid black; padding: 10px;">Exam 3 Fee</th>
          <th style="border: 1px solid black; padding: 10px;">Activity Fee</th>
          <th style="border: 1px solid black; padding: 10px;">Total Collected</th>
        </tr>
      </thead>
      <tbody>`;

  for (let grade in categoryTotals) {
    summaryTableHTML += `
      <tr style="background: #f9f9f9;">
        <td style="border: 1px solid black; padding: 10px;">${grade}</td>
        <td style="border: 1px solid black; padding: 10px;">KSH ${categoryTotals[grade].securityFee.toLocaleString()}</td>
        <td style="border: 1px solid black; padding: 10px;">KSH ${categoryTotals[grade].bomFee.toLocaleString()}</td>
        <td style="border: 1px solid black; padding: 10px;">KSH ${categoryTotals[grade].tuitionFee.toLocaleString()}</td>
        <td style="border: 1px solid black; padding: 10px;">KSH ${categoryTotals[grade].exam1Fee.toLocaleString()}</td>
        <td style="border: 1px solid black; padding: 10px;">KSH ${categoryTotals[grade].exam2Fee.toLocaleString()}</td>
        <td style="border: 1px solid black; padding: 10px;">KSH ${categoryTotals[grade].exam3Fee.toLocaleString()}</td>
        <td style="border: 1px solid black; padding: 10px;">KSH ${categoryTotals[grade].activityFee.toLocaleString()}</td>
        <td style="border: 1px solid black; padding: 10px; font-weight: bold; color: green;">KSH ${categoryTotals[grade].totalCollected.toLocaleString()}</td>
      </tr>`;
  }

  summaryTableHTML += `</tbody></table>
    <div style="text-align: center; margin-top: 15px;">
      <button onclick="printCategoryCollectionSummary()" style="padding: 10px; background: #0277BD; color: white; border: none; border-radius: 5px; cursor: pointer;">
        <i class="fas fa-print"></i> Print Summary
      </button>
    </div>`;

  document.getElementById("feeSummaryContainer").innerHTML = summaryTableHTML;
}

function printCategoryCollectionSummary() {
  const summaryTable = document.getElementById("feeSummaryContainer").innerHTML;
  const currentYear = new Date().getFullYear(); // Get current year

  // Print content with school header
  const printWindow = window.open("", "", "width=900,height=600");
  printWindow.document.write(`
    <html>
    <head>
      <title>Category Collection Summary</title>
      <style>
        body { font-family: Arial, sans-serif; text-align: center; color: black; }
        .header-container { text-align: center; margin-bottom: 20px; color: black; }
        .header-container img { max-width: 80px; }
        .header-container h2, .header-container h3, .header-container p { margin: 5px 0; color: black; }

        /* Table Styling */
        table { 
          width: 100%; 
          border-collapse: collapse; 
          margin-top: 20px; 
          color: black; /* Ensuring all table text prints in black */
        }
        th, td { 
          border: 2px solid black;  
          padding: 8px; 
          text-align: left; 
          color: black; /* Ensures all text remains black */
        }
        th { 
          background: #ffffff; /* White background to contrast black text */
          font-weight: bold; 
        }
        tr:nth-child(even) { 
          background: #f2f2f2; 
        }
      </style>
    </head>
    <body>
      <div class="header-container">
        <img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo">
        <h2>NACHU COMPREHENSIVE SCHOOL</h2>
        <h3>Category Collection Summary</h3>
        <p><strong>561-00902 Kikuyu KENYA</strong></p>
        <p><strong>Phone: +254-700-123456</strong></p>
        <p><strong>School Motto:</strong> "Excellence Through Knowledge"</p>
        <p><strong>Year:</strong> ${currentYear}</p>
        <hr>
      </div>
      
      ${summaryTable}

    </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.print();
}
function updateTotalSchoolFeeCollected() {
  let totalCollected = 0;
  
  // Get all rows from the fee summary table
  const feeTable = document.getElementById("feeSummaryTableBody");
  if (!feeTable) {
    console.error("Fee summary table not found.");
    return;
  }

  // Loop through all rows and sum the "Total Paid" column (index 11)
  feeTable.querySelectorAll("tr").forEach(row => {
    const cells = row.getElementsByTagName("td");
    if (cells.length > 1) {
      const totalPaid = parseFloat(cells[11].textContent) || 0;
      totalCollected += totalPaid;
    }
  });

  // Get the container where total collected is displayed
  let totalContainer = document.getElementById("totalSchoolFeeContainer");
  
  // If it doesn't exist, create it and append to the page
  if (!totalContainer) {
    totalContainer = document.createElement("div");
    totalContainer.id = "totalSchoolFeeContainer";
    totalContainer.style = "margin-top: 20px; text-align: center; font-size: 18px; font-weight: bold; color: #4CAF50;";
    
    // Append it below the fee summary table
    document.getElementById("feeSummaryTableContainer").appendChild(totalContainer);
  }

  // Update the total collected amount
  totalContainer.innerHTML = `Total School Fee Collected: <span style="color: black;">KSH ${totalCollected.toLocaleString()}</span>`;
}

// Call the function initially to show the total on page load
updateTotalSchoolFeeCollected();

// Update total whenever a new fee entry is added
document.getElementById("feeForm").addEventListener("submit", function () {
  setTimeout(updateTotalSchoolFeeCollected, 100); // Delay to ensure data updates first
});
function animateCounter(start, end, duration, element) {
  let startTime = null;

  function updateCounter(currentTime) {
    if (!startTime) startTime = currentTime;
    const elapsedTime = currentTime - startTime;
    const progress = Math.min(elapsedTime / duration, 1);
    const value = Math.floor(progress * (end - start) + start);
    element.innerText = `KSH ${value.toLocaleString()}`;

    if (progress < 1) {
      requestAnimationFrame(updateCounter);
    }
  }

  requestAnimationFrame(updateCounter);
}

function updateTotalSchoolFeeCollected() {
  let totalCollected = 0;
  
  // Get all rows from the fee summary table
  const feeTable = document.getElementById("feeSummaryTableBody");
  if (!feeTable) {
    console.error("Fee summary table not found.");
    return;
  }

  // Loop through all rows and sum the "Total Paid" column (index 11)
  feeTable.querySelectorAll("tr").forEach(row => {
    const cells = row.getElementsByTagName("td");
    if (cells.length > 1) {
      const totalPaid = parseFloat(cells[11].textContent) || 0;
      totalCollected += totalPaid;
    }
  });

  // Get or create the total fee container
  let totalContainer = document.getElementById("totalSchoolFeeContainer");
  if (!totalContainer) {
    totalContainer = document.createElement("div");
    totalContainer.id = "totalSchoolFeeContainer";
    totalContainer.style = "margin-top: 20px; text-align: center; font-size: 22px; font-weight: bold; color: #4CAF50;";
    
    // Append below the fee summary table
    document.getElementById("feeSummaryTableContainer").appendChild(totalContainer);
  }

  // Start animation from the current displayed value to the new total
  const currentDisplayedValue = parseInt(totalContainer.innerText.replace(/[^\d]/g, "")) || 0;
  animateCounter(currentDisplayedValue, totalCollected, 1500, totalContainer);
}

// Call the function initially to show the total on page load
updateTotalSchoolFeeCollected();

// Update total whenever a new fee entry is added
document.getElementById("feeForm").addEventListener("submit", function () {
  setTimeout(updateTotalSchoolFeeCollected, 100); // Slight delay to ensure data updates first
});

function toggleDefaultersList() {
    const container = document.getElementById("defaultersTableContainer");
    
    if (container.style.display === "none" || container.style.display === "") {
        generateDefaultersList(); // Generate the list before showing
        container.style.display = "block";
    } else {
        container.style.display = "none";
    }
}

function generateDefaultersList() {
    const selectedGrade = document.getElementById("gradeFilter").value;
    const defaultersTableBody = document.getElementById("defaultersTableBody");
    defaultersTableBody.innerHTML = ""; // Clear previous data

    const defaulters = feeDetails.filter(student => student.balance > 0 && (selectedGrade === "" || student.grade == selectedGrade));

    if (defaulters.length === 0) {
        defaultersTableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 10px;">No defaulters found</td></tr>`;
    } else {
        defaulters.forEach((student, index) => {
            const row = `
                <tr>
                    <td>${index + 1}</td>
                    <td>${student.name}</td>
                    <td>${student.grade}</td>
                    <td style="color: red;">KSH ${student.balance}</td>
                </tr>
            `;
            defaultersTableBody.innerHTML += row;
        });
    }
}

function printDefaultersList() {
    const selectedGrade = document.getElementById("gradeFilter").value;
    const currentYear = new Date().getFullYear();
    const gradeText = selectedGrade ? `Grade ${selectedGrade}` : "All Grades";

    const defaultersTable = document.getElementById("defaultersTableContainer").innerHTML;

    const printWindow = window.open("", "", "width=900,height=600");
    printWindow.document.write(`
        <html>
        <head>
            <title>Defaulters List</title>
            <style>
                body { font-family: Arial, sans-serif; text-align: center; color: black; }
                .header-container { text-align: center; margin-bottom: 20px; color: black; }
                .header-container img { max-width: 80px; }
                .header-container h2, .header-container p, .header-container h3 { margin: 5px 0; color: black; }
                
                /* Table Styling */
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin-top: 20px; 
                    color: black;
                }
                th, td { 
                    border: 2px solid black;  /* Ensures all table borders are black */
                    padding: 8px; 
                    text-align: left; 
                    color: black; /* Ensures all text is black */
                }
                th { 
                    background: #f2f2f2; /* Light grey for header background */
                    font-weight: bold; 
                }
                tr:nth-child(even) { 
                    background: #ffffff; /* White background for even rows */
                }
            </style>
        </head>
        <body>
            <div class="header-container">
                <img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo">
                <h2>NACHU COMPREHENSIVE SCHOOL </h2>
                <h3>Defaulters List</h3>
                <p><strong>Po Box 886-01000 Thika, KENYA</strong></p>
                <p><strong>Phone: +254-700-123456</strong></p>
                <p><strong>School Motto:</strong> "Excellence Through Knowledge"</p>
                <p><strong>Year:</strong> ${currentYear}</p>
                <p><strong>Grade:</strong> ${gradeText}</p>
                <hr style="border: 1px solid black;">
            </div>
            
            ${defaultersTable}

        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.print();
}

function openOnlyOneSection(sectionId) {
    // List of all section IDs that can be opened
    const sections = [
        "feeCaptureForm",
        "feeSummaryTableContainer",
        "receiptContainer",
        "filteredFeeTableContainer",
        "archivedFeesContainer",
        "paymentSummaryContainer",
        "defaultersTableContainer",
        "feeSummaryContainer"
    ];

    // Close all sections
    sections.forEach(id => {
        const section = document.getElementById(id);
        if (section) {
            section.style.display = "none";
        }
    });

    // Open the requested section
    const selectedSection = document.getElementById(sectionId);
    if (selectedSection) {
        selectedSection.style.display = "block";
    }
}
function openOnlyOneSection(sectionId) {
    // List of all section IDs
    const sections = [
        "feeCaptureForm",
        "feeSummaryTableContainer",
        "receiptContainer",
        "filteredFeeTableContainer",
        "archivedFeesContainer",
        "paymentSummaryContainer",
        "defaultersTableContainer",
        "feeSummaryContainer"
    ];

    // Close all sections first
    sections.forEach(id => {
        const section = document.getElementById(id);
        if (section) section.style.display = "none";
    });

    // Run necessary data function before opening the section
    switch (sectionId) {
        case "feeSummaryContainer":
            displayCategoryCollectionSummary();  // Generate Fee Collection Summary
            break;
        case "defaultersTableContainer":
            generateDefaultersList();  // Generate Defaulters List
            break;
        case "paymentSummaryContainer":
            generatePaymentSummary();  // Generate Payment Summary
            break;
        case "filteredFeeTableContainer":
            updateFilteredFeeRecords();  // Load Filtered Fee Records
            break;
    }

    // Open the requested section
    const selectedSection = document.getElementById(sectionId);
    if (selectedSection) selectedSection.style.display = "block";
}

// Function to Load Filtered Fee Records
function updateFilteredFeeRecords() {
    const selectedGrade = document.getElementById("gradeFilter")?.value || "";
    const tableBody = document.getElementById("filteredFeeTableBody");

    if (!tableBody) return;

    tableBody.innerHTML = "";  // Clear previous content

    // Filter fee details based on the selected grade
    const filteredDetails = selectedGrade ? feeDetails.filter(d => d.grade == selectedGrade) : feeDetails;

    if (filteredDetails.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="11" style="text-align: center; padding: 10px;">No records found</td></tr>`;
    } else {
        filteredDetails.forEach((detail, index) => {
            tableBody.innerHTML += `
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">${index + 1}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${detail.name}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.securityFee}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.bomFee}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.tuitionFee}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.exam1Fee}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.exam2Fee}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.exam3Fee}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">KSH ${detail.activityFee}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; color: green;">KSH ${detail.totalPaid}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; color: red;">KSH ${detail.balance}</td>
                </tr>`;
        });
    }
}

// Function to create a custom modal
function showModal(message, type = "info", callback = null) {
    let modal = document.createElement("div");
    modal.style.position = "fixed";
    modal.style.top = "50%";
    modal.style.left = "50%";
    modal.style.transform = "translate(-50%, -50%)";
    modal.style.padding = "20px";
    modal.style.backgroundColor = "#fff";
    modal.style.border = "2px solid #333";
    modal.style.boxShadow = "0px 0px 10px rgba(0,0,0,0.2)";
    modal.style.textAlign = "center";
    modal.style.zIndex = "10000";
    modal.style.borderRadius = "10px";

    let color = type === "error" ? "red" : type === "success" ? "green" : "#333";
    let textColor = type === "error" ? "white" : "black";

    modal.innerHTML = `
        <p style="color: ${textColor}; font-weight: bold;">${message}</p>
        <button id="closeModal" style="padding: 8px 15px; margin-top: 10px; background: ${color}; color: white; border: none; border-radius: 5px; cursor: pointer;">OK</button>
    `;

    document.body.appendChild(modal);

    document.getElementById("closeModal").onclick = () => {
        document.body.removeChild(modal);
        if (callback) callback();
    };
}

// Function to create a custom prompt
function showPrompt(message, callback) {
    let modal = document.createElement("div");
    modal.style.position = "fixed";
    modal.style.top = "50%";
    modal.style.left = "50%";
    modal.style.transform = "translate(-50%, -50%)";
    modal.style.padding = "20px";
    modal.style.backgroundColor = "#fff";
    modal.style.border = "2px solid #333";
    modal.style.boxShadow = "0px 0px 10px rgba(0,0,0,0.2)";
    modal.style.textAlign = "center";
    modal.style.zIndex = "10000";
    modal.style.borderRadius = "10px";

    modal.innerHTML = `
        <p style="font-weight: bold;">${message}</p>
        <input type="text" id="modalInput" style="padding: 8px; margin-bottom: 10px; width: 80%;"><br>
        <button id="confirmPrompt" style="padding: 8px 15px; background: green; color: white; border: none; border-radius: 5px; cursor: pointer;">OK</button>
        <button id="cancelPrompt" style="padding: 8px 15px; background: red; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Cancel</button>
    `;

    document.body.appendChild(modal);

    document.getElementById("confirmPrompt").onclick = () => {
        let value = document.getElementById("modalInput").value.trim();
        document.body.removeChild(modal);
        callback(value);
    };

    document.getElementById("cancelPrompt").onclick = () => {
        document.body.removeChild(modal);
        callback(null);
    };
}

// Function to save the report
function saveReport() {
    showPrompt("Enter Grade to Save Report:", (grade) => {
        if (!grade) {
            showModal("Grade is required.", "error");
            return;
        }

        showPrompt("Enter Exam Number (1-6):", (examNumber) => {
            if (!examNumber || examNumber < 1 || examNumber > 6) {
                showModal("Invalid exam number.", "error");
                return;
            }

            let table = document.getElementById("pathwaysResultsTable");
            let rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");

            let savedData = JSON.parse(localStorage.getItem(`Career_Report_Grade${grade}`)) || {};

            for (let i = 0; i < rows.length; i++) {
                let cells = rows[i].getElementsByTagName("td");
                let learnerName = cells[0].innerText;
                let bestPathway = cells[cells.length - 1].innerText; 

                if (!savedData[learnerName]) {
                    savedData[learnerName] = { grade: grade, exams: {}, pathwayCount: {} };
                }

                savedData[learnerName].exams[`Exam${examNumber}`] = bestPathway;

                savedData[learnerName].pathwayCount[bestPathway] = 
                    (savedData[learnerName].pathwayCount[bestPathway] || 0) + 1;
            }

            localStorage.setItem(`Career_Report_Grade${grade}`, JSON.stringify(savedData));
            showModal(`Report saved successfully for Grade ${grade}, Exam ${examNumber}.`, "success");
        });
    });
}

// Function to view saved reports
function viewSavedReports() {
    showPrompt("Enter Grade to View Report:", (selectedGrade) => {
        if (!selectedGrade) {
            showModal("Please enter a valid grade.", "error");
            return;
        }

        let allKeys = Object.keys(localStorage).filter(key => key.startsWith("Career_Report_Grade"));
        let savedData = {};

        // Loop through all saved reports and check if they belong to the selected grade
        allKeys.forEach(key => {
            let gradeFromKey = key.replace("Career_Report_Grade", ""); // Extract the stored grade (e.g., "7A")

            if (gradeFromKey.startsWith(selectedGrade)) { // Include "7A", "7B", etc.
                let reportData = JSON.parse(localStorage.getItem(key));
                Object.assign(savedData, reportData); // Merge data from matching grades
            }
        });

        if (Object.keys(savedData).length === 0) {
            showModal(`No saved reports found for Grade ${selectedGrade}.`, "error");
            return;
        }

        let savedReportsTable = document.getElementById("savedReportsTable");
        let savedReportsSection = document.getElementById("savedReportsSection");
        savedReportsSection.style.display = "block";

        savedReportsTable.getElementsByTagName("thead")[0].innerHTML = "";
        savedReportsTable.getElementsByTagName("tbody")[0].innerHTML = "";

        let theadContent = `<tr>
            <th>No.</th>
            <th>Learner Name</th>
            <th>Grade</th>
            <th>Exam 1</th>
            <th>Exam 2</th>
            <th>Exam 3</th>
            <th>Exam 4</th>
            <th>Exam 5</th>
            <th>Exam 6</th>
            <th>Best Career Pathway</th>
        </tr>`;
        savedReportsTable.getElementsByTagName("thead")[0].innerHTML = theadContent;

        let tbodyContent = "";
        let counter = 1;

        for (let learner in savedData) {
            let exams = savedData[learner].exams;
            let pathwayCount = savedData[learner].pathwayCount;

            let bestPathway = Object.keys(pathwayCount).reduce((a, b) => pathwayCount[a] > pathwayCount[b] ? a : b, "");

            tbodyContent += `<tr>
                <td>${counter++}</td>
                <td>${learner}</td>
                <td>${savedData[learner].grade}</td>
                <td>${exams.Exam1 || "-"}</td>
                <td>${exams.Exam2 || "-"}</td>
                <td>${exams.Exam3 || "-"}</td>
                <td>${exams.Exam4 || "-"}</td>
                <td>${exams.Exam5 || "-"}</td>
                <td>${exams.Exam6 || "-"}</td>
                <td><strong>${bestPathway}</strong></td>
            </tr>`;
        }

        savedReportsTable.getElementsByTagName("tbody")[0].innerHTML = tbodyContent;
        document.getElementById("printButton").style.display = "block";
    });
}


function printReport() {
    let reportContent = document.getElementById("savedReportsSection").innerHTML;

    let originalContent = document.body.innerHTML; // Store original page content

    document.body.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="school_logo_url_here" alt="School Logo" style="width: 100px; height: auto;"><br>
            <h2>Nachu Junior School  Compiled Pathway Report</h2>
            <p>561-00902 Kikuyu KENYA</p>
            <p>Phone: +254-700-123456</p>
            <p><strong>School Motto:</strong> "Excellence Through Knowledge"</p>
            <p><strong>Year:</strong> 2025</p>
        </div>

        ${reportContent}
    `;

    window.print(); // Print the page

    document.body.innerHTML = originalContent; // Restore original content after printing
    location.reload(); // Reload page to prevent display issues
}
function searchLearnerFee() {
    var input = document.getElementById("searchLearnerFee");
    var filter = input.value.toUpperCase();
    var table = document.getElementById("feeSummaryTable");
    var tr = table.getElementsByTagName("tr");

    for (var i = 1; i < tr.length; i++) { // Skip the header row
        var td = tr[i].getElementsByTagName("td")[1]; // Learner Name Column
        if (td) {
            var txtValue = td.textContent || td.innerText;
            tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? "" : "none";
        }
    }
}

function searchDefaulter() {
    var input = document.getElementById("searchDefaulter");
    var filter = input.value.toUpperCase();
    var table = document.getElementById("defaultersTableContainer").getElementsByTagName("table")[0];
    var tr = table.getElementsByTagName("tr");

    for (var i = 1; i < tr.length; i++) { // Skip the header row
        var td = tr[i].getElementsByTagName("td")[1]; // Learner Name Column
        if (td) {
            var txtValue = td.textContent || td.innerText;
            tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? "" : "none";
        }
    }
}
const fields = [
    { id: "learnerName", prompt: "Name", delay: 1500 },
    { id: "learnerGender", prompt: "Gender", delay: 1500 },
    { id: "learnerGrade", prompt: "Grade", delay: 1500 },
    { id: "learnerAge", prompt: "Age", delay: 1500 },
    { id: "parentName", prompt: "Parent Name", delay: 2000 },
    { id: "learnerPhone", prompt: "Parent Phone Number", delay: 3000 },
    { id: "birthCertificate", prompt: "Birth Certificate Number", delay: 3500, isNumber: true }, // Added Fix
    { id: "admissionNumber", prompt: "Admission Number", delay: 3000, isNumber: true } // Ensured number input
];

let currentFieldIndex = 0;
let recognition;

// Function to start voice input for each field one by one
function startVoiceInput() {
    if (!('webkitSpeechRecognition' in window)) {
        alert("Your browser does not support speech recognition. Please use Chrome.");
        return;
    }

    recognition = new webkitSpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = "en-US";

    recognition.onresult = function(event) {
        let transcript = event.results[0][0].transcript.trim();
        console.log("Captured Speech:", transcript);

        // Handle number inputs (convert to proper format)
        if (fields[currentFieldIndex].isNumber) {
            transcript = transcript.replace(/\D/g, ""); // Remove non-numeric characters
            transcript = parseInt(transcript, 10) || ""; // Convert to number safely
        }

        // Fill the current field
        document.getElementById(fields[currentFieldIndex].id).value = transcript;

        // Move to the next field
        currentFieldIndex++;

        // If more fields remain, prompt the user for the next one with appropriate delay
        if (currentFieldIndex < fields.length) {
            showVoicePrompt(fields[currentFieldIndex].prompt);
            setTimeout(() => recognition.start(), fields[currentFieldIndex].delay);
        } else {
            hideVoicePrompt();
            alert("All details recorded successfully!");
        }
    };

    recognition.onerror = function(event) {
        console.error("Speech recognition error:", event.error);
    };

    recognition.onend = function() {
        console.log("Speech recognition ended.");
    };

    // Start with the first prompt
    currentFieldIndex = 0;
    showVoicePrompt(fields[currentFieldIndex].prompt);
    setTimeout(() => recognition.start(), fields[currentFieldIndex].delay);
}

// Function to show custom voice input prompt
function showVoicePrompt(text) {
    const promptBox = document.getElementById("voicePrompt");
    document.getElementById("promptText").innerText = `Say: ${text}`;
    promptBox.style.display = "block";
}

// Function to hide custom prompt
function hideVoicePrompt() {
    document.getElementById("voicePrompt").style.display = "none";
}

// Function to preview uploaded photo
function previewPhoto(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById("photoPreview").src = e.target.result;
            document.getElementById("photoPreview").style.display = "block";
        };
        reader.readAsDataURL(file);
    }
}   
function filterDefaulters() {
  const selectedGrade = document.getElementById("defaultersGradeFilter").value;
  const table = document.getElementById("defaultersTableBody");
  const rows = table.getElementsByTagName("tr");

  for (let i = 0; i < rows.length; i++) {
    const gradeCell = rows[i].getElementsByTagName("td")[2]; // Grade column
    if (gradeCell) {
      const grade = gradeCell.textContent || gradeCell.innerText;
      rows[i].style.display = (selectedGrade === "" || grade === selectedGrade) ? "" : "none";
    }
  }
}
function toggleLearnersCount() {
    const container = document.getElementById('learnerCountContainer');
    const toggleButton = document.getElementById('toggleLearnersCountButton');
    if (container.style.display === 'none' || container.style.display === '') {
        generateLearnersCount(); // Generate counts when showing the container
        container.style.display = 'block';
        toggleButton.textContent = 'Hide Learners Count';
    } else {
        container.style.display = 'none';
        toggleButton.textContent = 'Show Learners Count';
    }
}

function generateLearnersCount() {
    // Get the table body where learners' data is stored
    const learnersTable = document.getElementById('learnersList');
    if (!learnersTable) {
        console.error('Learners table not found!');
        return;
    }

    const rows = learnersTable.querySelectorAll('tr');
    const gradeCounts = {};

    // Loop through rows to process each learner's data
    rows.forEach(row => {
        const gradeCell = row.querySelector('td:nth-child(5)'); // Assuming 5th column is grade
        const genderCell = row.querySelector('td:nth-child(4)'); // Assuming 4th column is gender

        if (!gradeCell || !genderCell) return;

        const grade = gradeCell.textContent.trim();
        const gender = genderCell.textContent.trim().toLowerCase();

        // Initialize grade object if not exists
        if (!gradeCounts[grade]) {
            gradeCounts[grade] = { boys: 0, girls: 0, total: 0 };
        }

        // Increment based on gender
        if (gender === 'male' || gender === 'boy') {
            gradeCounts[grade].boys += 1;
        } else if (gender === 'female' || gender === 'girl') {
            gradeCounts[grade].girls += 1;
        }

        // Update total
        gradeCounts[grade].total = gradeCounts[grade].boys + gradeCounts[grade].girls;
    });

    // Display counts dynamically in the HTML table
    const resultTable = document.getElementById('learnerCountTableBody');
    resultTable.innerHTML = ''; // Clear previous content
    let count = 1;
    Object.keys(gradeCounts).forEach(grade => {
        const { boys, girls, total } = gradeCounts[grade];
        resultTable.innerHTML += `
            <tr>
                <td style="font-size: 50px;">${count}</td>
                <td style="font-size: 50px;">${grade}</td>
                <td style="font-size: 50px;">${boys}</td>
                <td style="font-size: 50px;">${girls}</td>
                <td style="font-size: 50px;">${total}</td>
            </tr>
        `;
        count++;
    });
}

function printLearnersCount() {
    const container = document.getElementById('learnerCountContainer');
    if (container) {
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Learners Count</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            text-align: center;
                            margin: 20px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                        }
                        th, td {
                            border: 1px solid black;
                            padding: 10px;
                            text-align: center;
                        }
                        th {
                            background-color: #f2f2f2;
                        }
                        td {
                            font-size: 20px;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 20px;
                        }
                        .header img {
                            max-width: 80px;
                            margin-bottom: 10px;
                        }
                        .header h1 {
                            font-size: 20px;
                            margin: 0;
                        }
                        .header p {
                            margin: 5px 0;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo">
                        <h1>NACHU COMPREHENSIVE SCHOOL LEARNERS COUNT PER GRADE </h1>
                        <p>ADDRESS: PO BOX 561-00902 KIKUYU, KENYA</p>
                        <p>Phone: +254-700-123456</p>
                        <p>School Motto: "HARD WORK PAYS"</p>
                        <p>Year: 2025</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Grade</th>
                                <th>Boys</th>
                                <th>Girls</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${document.getElementById('learnerCountTableBody').innerHTML}
                        </tbody>
                    </table>
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    } else {
        console.error('Learner count container not found!');
    }
}
function showCelebration(message = "Congratulations!", duration = 5000) {
    // Create celebration container
    const celebrationContainer = document.createElement("div");
    celebrationContainer.style.position = "fixed";
    celebrationContainer.style.top = "0";
    celebrationContainer.style.left = "0";
    celebrationContainer.style.width = "100%";
    celebrationContainer.style.height = "100%";
    celebrationContainer.style.backgroundColor = "rgba(0, 0, 0, 0.8)";
    celebrationContainer.style.zIndex = "1000";
    celebrationContainer.style.display = "flex";
    celebrationContainer.style.justifyContent = "center";
    celebrationContainer.style.alignItems = "center";
    celebrationContainer.style.flexDirection = "column";
    celebrationContainer.style.color = "white";
    celebrationContainer.style.fontSize = "24px";
    celebrationContainer.style.fontFamily = "Arial, sans-serif";
    celebrationContainer.style.textAlign = "center";

    // Add message
    const celebrationMessage = document.createElement("h1");
    celebrationMessage.textContent = message;
    celebrationContainer.appendChild(celebrationMessage);

    // Add confetti effect
    const confettiCanvas = document.createElement("canvas");
    confettiCanvas.style.position = "absolute";
    confettiCanvas.style.top = "0";
    confettiCanvas.style.left = "0";
    confettiCanvas.style.width = "100%";
    confettiCanvas.style.height = "100%";
    confettiCanvas.id = "confettiCanvas";
    celebrationContainer.appendChild(confettiCanvas);

    document.body.appendChild(celebrationContainer);

    // Play confetti animation
    const confettiSettings = { target: "confettiCanvas", max: 150, size: 1.5, clock: 25 };
    const confetti = new ConfettiGenerator(confettiSettings);
    confetti.render();

    // Optional celebration sound
    const celebrationSound = new Audio("https://www.soundjay.com/button/sounds/button-20.mp3");
    celebrationSound.play();

    // Remove celebration after duration
    setTimeout(() => {
        celebrationContainer.remove();
        confetti.clear(); // Stop the confetti animation
    }, duration);
}
let libraryRecords = JSON.parse(localStorage.getItem("libraryRecords")) || [];
let bookNumbers = [];

function saveRecords() {
  localStorage.setItem("libraryRecords", JSON.stringify(libraryRecords));
}

function fetchBookNumbers() {
  const bookNoInput = document.getElementById("bookNo").value.trim();
  bookNumbers = bookNoInput.split(",").map((num) => num.trim());
}

function populateTable(records = libraryRecords) {
  const tableBody = document.querySelector("#library-records table tbody");
  tableBody.innerHTML = "";

  if (records.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="9" style="text-align: center;">No records found.</td></tr>`;
    return;
  }

  records.forEach((record, index) => {
    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${index + 1}</td>
      <td contenteditable="true" onblur="updateRecord(${index}, 'name', this.textContent.trim())">${record.name}</td>
      <td contenteditable="true" onblur="updateRecord(${index}, 'grade', this.textContent.trim())">${record.grade}</td>
      <td contenteditable="true" onblur="updateRecord(${index}, 'bookNumbers', this.textContent.trim().split(','))">${record.bookNumbers.join(", ")}</td>
      <td contenteditable="true" onblur="updateRecord(${index}, 'date', this.textContent.trim())">${record.date}</td>
      <td contenteditable="true" onblur="updateRecord(${index}, 'issuedBooks', this.textContent.trim().split(','))">${record.issuedBooks.join(", ")}</td>
      <td contenteditable="true" onblur="updateRecord(${index}, 'lostBooks', this.textContent.trim().split(','))">${record.lostBooks.join(", ")}</td>
      <td>${record.status}</td>
      <td><button onclick="deleteRecord(${index})">Delete</button></td>
    `;

    tableBody.appendChild(row);
  });
}

function updateRecord(index, field, value) {
  // Update the specific field of the record
  libraryRecords[index][field] = Array.isArray(value) ? value.map((v) => v.trim()) : value;

  // Update the status dynamically based on lostBooks
  if (field === "lostBooks") {
    libraryRecords[index].status = value.some((book) => book.trim() !== "") ? "Pending" : "Cleared";
  }

  // Save updated records and refresh the table
  saveRecords();
  populateTable();
}

function deleteRecord(index) {
  if (confirm("Are you sure you want to delete this record?")) {
    libraryRecords.splice(index, 1);
    saveRecords();
    populateTable();
    updateGradeFilter();
  }
}

function addRecord(event) {
  event.preventDefault();

  const name = document.getElementById("name").value;
  const grade = document.getElementById("grade").value;
  const date = new Date().toISOString().split("T")[0];

  fetchBookNumbers();

  const issuedBooksCheckboxes = Array.from(document.querySelectorAll("#issuedBooks input:checked"));
  const lostBooksCheckboxes = Array.from(document.querySelectorAll("#lostBooks input:checked"));

  const issuedBooks = issuedBooksCheckboxes.map((checkbox, index) => {
    return `${checkbox.value} (${bookNumbers[index] || "N/A"})`;
  });

  const lostBooks = lostBooksCheckboxes.map((checkbox) => checkbox.value);
  const status = lostBooks.length > 0 ? "Pending Clearance" : "Active";

  const newRecord = { name, grade, bookNumbers, date, issuedBooks, lostBooks, status };

  libraryRecords.push(newRecord);
  saveRecords();
  populateTable();
  updateGradeFilter();
  document.getElementById("record-form").reset();
}

// Toggle form & table visibility
function toggleLibraryManager() {
  const formSection = document.getElementById("record-form");
  const tableSection = document.getElementById("library-records");

  if (formSection.style.display === "none") {
    formSection.style.display = "block";
    tableSection.style.display = "block";
  } else {
    formSection.style.display = "none";
    tableSection.style.display = "none";
  }
}

function updateGradeFilter() {
  const gradeFilter = document.getElementById("grade-filter");
  gradeFilter.innerHTML = '<option value="All">All Grades</option>';

  const grades = [...new Set(libraryRecords.map((record) => record.grade))];
  grades.forEach((grade) => {
    const option = document.createElement("option");
    option.value = grade;
    option.textContent = `Grade ${grade}`;
    gradeFilter.appendChild(option);
  });
}

function searchTable() {
  const searchTerm = document.getElementById("search-bar").value.toLowerCase();
  const selectedGrade = document.getElementById("grade-filter").value;

  const filteredRecords = libraryRecords.filter((record) => {
    const matchesName = record.name.toLowerCase().includes(searchTerm);
    const matchesGrade = selectedGrade === "All" || record.grade === selectedGrade;
    return matchesName && matchesGrade;
  });

  populateTable(filteredRecords);
}

window.onload = function () {
  populateTable();
  updateGradeFilter();
};


function printFilteredTable() {
  const table = document.querySelector("#library-records table");
  const gradeFilter = document.getElementById("grade-filter").value;

  const filteredRecords = libraryRecords.filter(
    (record) => gradeFilter === "All" || record.grade === gradeFilter
  );

  if (filteredRecords.length === 0) {
    alert("No records to print for the selected grade.");
    return;
  }

  // Create a new window for printing
  const printWindow = window.open("", "_blank");

  // Prepare the content for the printable version
  let printContent = `
    <html>
    <head>
      <title>Filtered Table</title>
      <style>
        table {
          width: 100%;
          border-collapse: collapse;
        }
        th, td {
          border: 1px solid #000;
          padding: 8px;
          text-align: left;
        }
        .header {
          text-align: center;
          margin-bottom: 20px;
        }
        .header img {
          max-width: 100px;
        }
      </style>
    </head>
    <body>
      <div class="header">
        <img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo"> <!-- Replace with your logo URL -->
        <h1>RASM LIBRARY MANAGEMENT DATA SYSTEM</h1>
        <h2>Nachu Junior School</h2>
        <p>P.O BOX 561-00902, KIKUYU, KENYA</p>
        <p>Phone: +254-700-123456</p>
        <p><em>School Motto: "Excellence Through Knowledge"</em></p>
      </div>
      <h3>Library Records for Grade: ${gradeFilter === "All" ? "All Grades" : gradeFilter}</h3>
      <table>
        <thead>
          <tr>
            <th>NO</th>
            <th>Name</th>
            <th>Grade</th>
            <th>Book Numbers</th>
            <th>Date</th>
            <th>Issued Books</th>
            <th>Lost Books</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
  `;

  filteredRecords.forEach((record, index) => {
    printContent += `
      <tr>
        <td>${index + 1}</td>
        <td>${record.name}</td>
        <td>${record.grade}</td>
        <td>${record.bookNumbers.join(", ")}</td>
        <td>${record.date}</td>
        <td>${record.issuedBooks.join(", ")}</td>
        <td>${record.lostBooks.join(", ")}</td>
        <td>${record.status}</td>
      </tr>
    `;
  });

  printContent += `
        </tbody>
      </table>
    </body>
    </html>
  `;

  // Write the content to the new window
  printWindow.document.open();
  printWindow.document.write(printContent);
  printWindow.document.close();

  // Trigger the print dialog
  printWindow.print();
}

function generateLibraryCards() {
  const gradeFilter = document.getElementById("grade-filter").value;

  // Filter records based on the selected grade
  const filteredRecords = libraryRecords.filter(
    (record) => gradeFilter === "All" || record.grade === gradeFilter
  );

  if (filteredRecords.length === 0) {
    alert("No library cards to generate for the selected grade.");
    return;
  }

  // Create a new window for printing
  const printWindow = window.open("", "_blank");

  // Prepare printable content
  let printContent = `
    <html>
    <head>
      <title>Library Cards</title>
      <style>
        body {
          font-family: Arial, sans-serif;
          margin: 0;
          padding: 0;
        }
        .card-container {
          display: grid;
          grid-template-columns: 1fr 1fr; /* Two cards per row */
          gap: 20px;
          padding: 20px;
        }
        .library-card {
          border: 2px solid #000;
          padding: 15px;
          height: 500px; /* Adjusted height */
          width: 100%;
          box-sizing: border-box;
          text-align: left;
          box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
          border-radius: 8px;
          display: flex;
          flex-direction: column;
          justify-content: space-between;
        }
        .card-header {
          font-weight: bold;
          text-align: center;
          font-size: 20px;
          margin-bottom: 10px;
        }
        .school-logo {
          text-align: center;
          margin-bottom: 10px;
        }
        .school-logo img {
          max-width: 60px;
          max-height: 60px;
        }
        .school-name {
          text-align: center;
          font-size: 20px;
          font-weight: bold;
          margin-bottom: 15px;
        }
        .card-content {
          flex-grow: 1; /* Ensures content adjusts to fit the space */
        }
        .stamp {
          border: 2px solid blue;
          color: blue;
          text-align: center;
          width: 160px;
          height: 60px;
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 10px auto;
          font-weight: bold;
        }
        .card-footer {
          font-style: italic;
          font-size: 12px;
          text-align: center;
          margin-top: 10px;
        }
        @page {
          margin: 1cm;
        }
        @media print {
          .card-container {
            page-break-inside: avoid;
          }
        }
      </style>
    </head>
    <body>
      <div class="card-container">
  `;

  // Generate individual library cards
  filteredRecords.forEach((record) => {
    printContent += `
      <div class="library-card">
        <div class="school-logo">
          <img src="https://i.imgur.com/uWrz8rt.png" alt="School Logo"> <!-- Replace with your logo URL -->
        </div>
        <div class="card-header">Rasm Library Card</div>
        <div class="school-name">Nachu Junior School</div>
        <div class="card-content">
          <p><strong>Name:</strong> ${record.name}</p>
          <p><strong>Grade:</strong> ${record.grade}</p>
          <p><strong>Issued Books:</strong> ${record.issuedBooks.join(", ") || "None"}</p>
             <p><strong>Books Lost:</strong> ${record.lostBooks.join(", ") || "None"}</p>
        </div>
        <div class="stamp">
          NACHU JS SCHOOL<br>
          Po.Box 561-00902 Kikuyu
        </div>
        <div class="card-footer">Valid for the academic year 2025</div>
      </div>
    `;
  });

  printContent += `
      </div>
    </body>
    </html>
  `;

  // Write the content to the new window
  printWindow.document.open();
  printWindow.document.write(printContent);
  printWindow.document.close();

  // Trigger the print dialog
  printWindow.print();
}
function populateGradeDropdown() {
  const gradeDropdown = document.getElementById("grade-filter");
  gradeDropdown.innerHTML = `<option value="All">All Grades</option>`; // Reset options

  const uniqueGrades = [...new Set(libraryRecords.map((record) => record.grade))];
  uniqueGrades.forEach((grade) => {
    const option = document.createElement("option");
    option.value = grade;
    option.textContent = grade;
    gradeDropdown.appendChild(option);
  });
}

// Call this whenever records are updated
populateGradeDropdown();
// Function to set today's date dynamically
  function setCurrentDate() {
    const today = new Date().toISOString().split("T")[0]; // Get current date in YYYY-MM-DD format
    document.getElementById("date").value = today;
  }

  // Call the function when the page loads
  window.onload = setCurrentDate;
function updateStatus() {
  const lostBooksCheckboxes = document.querySelectorAll("#lostBooks input[type='checkbox']");
  const lostBooks = Array.from(lostBooksCheckboxes).filter((checkbox) => checkbox.checked);

  const statusField = document.getElementById("status");
  if (lostBooks.length > 0) {
    statusField.value = "Pending Clearance";
  } else {
    statusField.value = "Active";
  }
}

// Add an event listener to update the status dynamically when checkboxes are changed
document.querySelectorAll("#lostBooks input[type='checkbox']").forEach((checkbox) => {
  checkbox.addEventListener("change", updateStatus);
});

// Ensure status is updated when the form loads or if lost books are pre-filled
window.onload = () => {
  updateStatus();
  setCurrentDate(); // Call to set the current date
};
function toggleFormVisibility() {
  const form = document.getElementById("record-form");
  const toggleButton = document.getElementById("manage-library-btn");

  if (form.style.display === "none" || form.style.display === "") {
    form.style.display = "block";
    toggleButton.textContent = "Hide Form";
  } else {
    form.style.display = "none";
    toggleButton.textContent = "Show Form";
  }
}

document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("record-form");
  form.style.display = "none"; // Ensure the form is hidden initially
});

function toggleLibraryManagement() {
    var libraryManagement = document.getElementById("library-management");
    if (libraryManagement.style.display === "none") {
        libraryManagement.style.display = "block";
    } else {
        libraryManagement.style.display = "none";
    }
}
  function toggleFormVisibility() {
    const form = document.getElementById("record-form");
    const button = document.getElementById("manage-library-btn");

    if (form.style.display === "none") {
      form.style.display = "block";
      button.textContent = "Hide Form";
    } else {
      form.style.display = "none";
      button.textContent = "Register Learner";
    }
  }

// Function to toggle all checkboxes in a group based on the "Select All" checkbox state
function toggleCheckboxes(groupName, masterCheckbox) {
    // Get all checkboxes within the specified group
    const checkboxes = document.querySelectorAll(`#${groupName} input[type='checkbox']`);
    // Set each checkbox's checked property to match the master checkbox's state
    checkboxes.forEach(checkbox => checkbox.checked = masterCheckbox.checked);
}

function showMarksStatus() {
  const container = document.getElementById("marksStatusWrapper");
  container.innerHTML = "";

  const wrapper = document.createElement("div");

  // === School Header Section (Print only) ===
  const headerDiv = document.createElement("div");
  headerDiv.id = "printHeader";
  headerDiv.style.textAlign = "center";
  headerDiv.style.marginBottom = "20px";
  headerDiv.style.display = "none"; // Hidden by default, shown in print

  const logoImg = document.createElement("img");
  logoImg.src = "https://i.imgur.com/uWrz8rt.png"; // Replace with your logo path
  logoImg.alt = "School Logo";
  logoImg.style.width = "100px";
  logoImg.style.marginBottom = "10px";

  const schoolName = document.createElement("h2");
  schoolName.textContent = "Sunrise Secondary School"; // Replace with your school name
  schoolName.style.margin = "0";

  const title = document.createElement("h3");
  title.textContent = "Marks Submission Status Per Grade";
  title.style.margin = "5px 0 15px 0";
  title.style.fontWeight = "normal";

  headerDiv.appendChild(logoImg);
  headerDiv.appendChild(schoolName);
  headerDiv.appendChild(title);
  wrapper.appendChild(headerDiv);

  // === Print Button ===
  const tableHeaderBar = document.createElement("div");
  tableHeaderBar.style.display = "flex";
  tableHeaderBar.style.justifyContent = "flex-end";
  tableHeaderBar.style.marginBottom = "8px";

  const printBtn = document.createElement("button");
  printBtn.innerHTML = `<i class="fa fa-print"></i> Print This Table`; // FontAwesome print icon
  printBtn.style.backgroundColor = "#4CAF50";
  printBtn.style.color = "white";
  printBtn.style.padding = "8px 12px";
  printBtn.style.border = "none";
  printBtn.style.borderRadius = "5px";
  printBtn.style.cursor = "pointer";
  printBtn.onclick = () => window.print();

  tableHeaderBar.appendChild(printBtn);
  wrapper.appendChild(tableHeaderBar);

  // === Table Creation ===
  const table = document.createElement("table");
  table.style.width = "100%";
  table.style.borderCollapse = "collapse";
  table.style.marginTop = "0px";
  table.innerHTML = `
    <thead>
      <tr style="background-color: #4CAF50; color: white;">
        <th style="border: 1px solid black; padding: 8px;">Grade</th>
        <th style="border: 1px solid black; padding: 8px;">Registered Learners</th>
        <th style="border: 1px solid black; padding: 8px;">Recorded Learners</th>
        <th style="border: 1px solid black; padding: 8px;">Learners Without Marks</th>
        <th style="border: 1px solid black; padding: 8px;">Missing Names</th>
        <th style="border: 1px solid black; padding: 8px;">Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;

  const tbody = table.querySelector("tbody");

  const learnersByGrade = learners.reduce((acc, learner) => {
    const grade = learner.grade;
    if (!acc[grade]) acc[grade] = [];
    acc[grade].push(learner.name);
    return acc;
  }, {});

  const marksByGrade = marks.reduce((acc, entry) => {
    const grade = entry.grade;
    if (!acc[grade]) acc[grade] = [];
    acc[grade].push(entry.learner);
    return acc;
  }, {});

  for (const grade in learnersByGrade) {
    const registered = learnersByGrade[grade];
    const recorded = marksByGrade[grade] || [];
    const missing = registered.filter(name => !recorded.includes(name));

    const row = document.createElement("tr");

    const deleteBtn = document.createElement("button");
    deleteBtn.innerHTML = `<i class="fa fa-trash"></i> Delete`; // FontAwesome trash icon
    deleteBtn.style.backgroundColor = "#f44336";
    deleteBtn.style.color = "white";
    deleteBtn.style.padding = "5px 10px";
    deleteBtn.style.border = "none";
    deleteBtn.style.borderRadius = "4px";
    deleteBtn.style.cursor = "pointer";
    deleteBtn.onclick = () => deleteGradeMarks(grade);

    row.innerHTML = `
      <td style="border: 1px solid black; padding: 8px;">${grade}</td>
      <td style="border: 1px solid black; padding: 8px;">${registered.length}</td>
      <td style="border: 1px solid black; padding: 8px;">${recorded.length}</td>
      <td style="border: 1px solid black; padding: 8px;">${missing.length}</td>
      <td style="border: 1px solid black; padding: 8px; color: red;">${missing.join(', ') || 'All recorded'}</td>
    `;

    const actionCell = document.createElement("td");
    actionCell.style.border = "1px solid black";
    actionCell.style.padding = "8px";
    actionCell.appendChild(deleteBtn);

    row.appendChild(actionCell);
    tbody.appendChild(row);
  }

  wrapper.appendChild(table);
  container.appendChild(wrapper);
}


let isMarksStatusVisible = false;

function toggleMarksStatus() {
  const wrapper = document.getElementById("marksStatusWrapper");
  const button = document.getElementById("toggleMarksStatusBtn");

  if (!isMarksStatusVisible) {
    showMarksStatus(); // Render table
    wrapper.style.display = "block";
    button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Marks Recording Summary';
    isMarksStatusVisible = true;
  } else {
    wrapper.style.display = "none";
    button.innerHTML = '<i class="fas fa-chart-bar"></i> Show Marks Recording Summary';
    isMarksStatusVisible = false;
  }
}

function deleteGradeMarks(grade) {
  // Display the custom confirmation modal
  const modal = document.getElementById("customConfirmModal");
  const gradeText = document.getElementById("gradeText");
  gradeText.textContent = grade;
  
  modal.style.display = "flex"; // Show the modal

  // Return a promise to handle the user's response asynchronously
  return new Promise((resolve) => {
    // Handle Yes button click
    document.getElementById("confirmYes").onclick = function() {
      // Remove marks for this grade only
      marks = marks.filter(entry => entry.grade !== grade);
      saveMarksToStorage();
      showMarksStatus();
      
      // Show success alert with inline CSS styling
      showCustomAlert(`
        <div style="color: white; background-color: #ff4d4d; padding: 10px; border-radius: 5px; font-weight: bold;">
          All marks for Grade ${grade} have been deleted.
        </div>`, 
        "error"
      );
      
      modal.style.display = "none"; // Hide the modal
      resolve(true); // Resolve with true (confirmed)
    };

    // Handle No button click
    document.getElementById("confirmNo").onclick = function() {
      modal.style.display = "none"; // Hide the modal
      resolve(false); // Resolve with false (cancelled)
    };
  });
}

// HTML for custom confirmation modal
document.body.insertAdjacentHTML('beforeend', `
  <div id="customConfirmModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background-color: white; padding: 20px; border-radius: 10px; text-align: center; width: 300px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
      <p style="color: #333; font-size: 16px;">Delete all marks recorded for Grade <span id="gradeText"></span>? This cannot be undone.</p>
      <button id="confirmYes" style="background-color: red; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Yes</button>
      <button id="confirmNo" style="background-color: green; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">No</button>
    </div>
  </div>
`);
function populateGradeDropdown() {
  const dropdown = document.getElementById("gradeDropdown");
  dropdown.innerHTML = '<option value="">-- Select Grade --</option>';

  const grades = [...new Set(learners.map(l => l.grade))].sort();
  grades.forEach(grade => {
    const option = document.createElement("option");
    option.value = grade;
    option.textContent = grade;
    dropdown.appendChild(option);
  });
}

function showLearnerNamesOnly() {
  const selectedGrade = document.getElementById("gradeDropdown").value;
  const tableBody = document.getElementById("learnerNamesList");
  const gradeHeader = document.getElementById("selectedGradeHeader");

  tableBody.innerHTML = "";
  gradeHeader.textContent = selectedGrade || "All";

  const filtered = learners.filter(l => l.grade === selectedGrade);

  const boys = filtered.filter(l => l.gender?.toLowerCase() === "male");
  const girls = filtered.filter(l => l.gender?.toLowerCase() === "female");

  if (boys.length) {
    const boysHeader = document.createElement("tr");
    const boysCell = document.createElement("td");
    boysCell.colSpan = 2;
    boysCell.textContent = "--- BOYS ---";
    boysCell.style.textAlign = "center";
    boysCell.style.fontWeight = "bold";
    boysCell.style.color = "black";
    boysHeader.appendChild(boysCell);
    tableBody.appendChild(boysHeader);

    boys.forEach((l, index) => {
      const row = document.createElement("tr");

      const noCell = document.createElement("td");
      noCell.textContent = index + 1;
      noCell.style.border = "1px solid black";
      noCell.style.padding = "8px";
      noCell.style.color = "black";

      const nameCell = document.createElement("td");
      nameCell.textContent = l.name;
      nameCell.style.border = "1px solid black";
      nameCell.style.padding = "8px";
      nameCell.style.color = "black";

      row.appendChild(noCell);
      row.appendChild(nameCell);
      tableBody.appendChild(row);
    });
  }

  if (girls.length) {
    const girlsHeader = document.createElement("tr");
    const girlsCell = document.createElement("td");
    girlsCell.colSpan = 2;
    girlsCell.textContent = "--- GIRLS ---";
    girlsCell.style.textAlign = "center";
    girlsCell.style.fontWeight = "bold";
    girlsCell.style.color = "black";
    girlsHeader.appendChild(girlsCell);
    tableBody.appendChild(girlsHeader);

    girls.forEach((l, index) => {
      const row = document.createElement("tr");

      const noCell = document.createElement("td");
      noCell.textContent = index + 1;
      noCell.style.border = "1px solid black";
      noCell.style.padding = "8px";
      noCell.style.color = "black";

      const nameCell = document.createElement("td");
      nameCell.textContent = l.name;
      nameCell.style.border = "1px solid black";
      nameCell.style.padding = "8px";
      nameCell.style.color = "black";

      row.appendChild(noCell);
      row.appendChild(nameCell);
      tableBody.appendChild(row);
    });
  }
}

function printLearnersTable() {
  const printable = document.getElementById("printableLearnersTable").innerHTML;
  const win = window.open('', '', 'height=600,width=800');
  win.document.write('<html><head><title>Print Learners</title>');
  win.document.write('<style>body { color: black; font-family: Arial; } table { border-collapse: collapse; width: 100%; } th, td { border: 1px solid black; padding: 8px; color: black; } h2, h3 { color: black; }</style>');
  win.document.write('</head><body>');
  win.document.write(printable);
  win.document.write('</body></html>');
  win.document.close();
  win.focus();
  win.print();
  win.close();
}

function populateMarksGradeDropdown() {
    const gradeSelect = document.getElementById("gradeSelect");
    const tableBody = document.getElementById("marksList");

    if (!gradeSelect || !tableBody) return;

    gradeSelect.innerHTML = '<option value="">All Grades</option>';

    const rows = tableBody.querySelectorAll("tr");
    const grades = new Set();

    rows.forEach(row => {
        const gradeCell = row.cells[2]; // 3rd column
        if (gradeCell) {
            const gradeText = gradeCell.textContent.trim();
            if (gradeText) {
                grades.add(gradeText);
            }
        }
    });

    [...grades].sort().forEach(grade => {
        const option = document.createElement("option");
        option.value = grade;
        option.textContent = grade;
        gradeSelect.appendChild(option);
    });
}

document.addEventListener("DOMContentLoaded", function () {
    populateMarksGradeDropdown();
});



function filterMarksByGrade() {
    const selectedGrade = document.getElementById("gradeSelect").value;
    const rows = Array.from(document.querySelectorAll("#marksList tr"));
    
    let subjectTotals = Array(9).fill(0);
    let visibleRowCount = 0;
    let totalMarksSum = 0;

    // Remove existing totals/averages if present
    document.querySelectorAll("#marksList .summary-row").forEach(row => row.remove());

    rows.forEach(row => {
        const grade = row.cells[2]?.textContent.trim();
        const isVisible = selectedGrade === "" || grade === selectedGrade;

        row.style.display = isVisible ? "" : "none";

        if (isVisible) {
            visibleRowCount++;
            for (let i = 3, subjIdx = 0; subjIdx < 9; i += 2, subjIdx++) {
                const score = parseFloat(row.cells[i]?.textContent.trim()) || 0;
                subjectTotals[subjIdx] += score;
            }

            const totalCell = row.cells[row.cells.length - 2];
            totalMarksSum += parseFloat(totalCell?.textContent.trim()) || 0;
        }
    });

    if (visibleRowCount === 0) return;

    const marksList = document.getElementById("marksList");

    // Total row
    const totalRow = document.createElement("tr");
    totalRow.classList.add("summary-row");
    totalRow.innerHTML = `
        <td colspan="3" style="font-weight:bold;"> Total</td>
        ${subjectTotals.map(t => `<td style="font-weight:bold;">${t}</td><td></td>`).join('')}
        <td style="font-weight:bold;">${totalMarksSum}</td>
        <td></td>
    `;

    // Average row
    const averageRow = document.createElement("tr");
    averageRow.classList.add("summary-row");
    averageRow.innerHTML = `
        <td colspan="3" style="font-weight:bold;"> Average</td>
        ${subjectTotals.map(t => `<td style="font-weight:bold;">${(t / visibleRowCount).toFixed(2)}</td><td></td>`).join('')}
        <td style="font-weight:bold;">${(totalMarksSum / visibleRowCount).toFixed(2)}</td>
        <td></td>
    `;

    marksList.appendChild(totalRow);
    marksList.appendChild(averageRow);
}

function printFilteredGrades() {
  const selectedGrade = document.getElementById("gradeSelect").value;
  const term = document.getElementById("termSelect")?.value || "Term 1";
  const year = new Date().getFullYear();
  const schoolName = "NACHU JUNIOR  SCHOOL";
  const motto = "Excellence Through Knowledge";
  const logoUrl = "https://i.imgur.com/uWrz8rt.png";

  const rows = document.querySelectorAll("#marksList tr");

  // Generate today's date in readable format
  const today = new Date();
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  const formattedDate = today.toLocaleDateString('en-US', options);

  const printWindow = window.open('', '', 'height=900,width=1100');
  printWindow.document.write(`
    <html>
      <head>
        <title>Filtered Merit List</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; }
          table { width: 100%; border-collapse: collapse; margin-top: 20px; }
          th, td { border: 1px solid black; padding: 8px; text-align: center; }
          h2, h3, h4 { margin: 0; }
          .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
          }
          .school-info { text-align: left; }
          .school-info .inline-details {
            margin-top: 6px;
            font-size: 16px;
          }
          .inline-details span {
            margin-right: 20px;
          }
          .logo img {
            max-height: 70px;
            margin-left: 20px;
          }
          .stamp {
            border: 2px solid blue;
            color: blue;
            text-align: center;
            width: 200px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            font-weight: bold;
            line-height: 1.3;
            flex-direction: column;
          }
        </style>
      </head>
      <body>
        <div class="top-bar">
          <div class="school-info">
            <h2>${schoolName}</h2>
            <h4><em>${motto}</em></h4>
            <div class="inline-details">
              <span><strong>Term:</strong> ${term}</span>
              <span><strong>Grade:</strong> ${selectedGrade || "All"}</span>
              <span><strong>Year:</strong> ${year}</span>
            </div>
          </div>
          <div class="logo">
            <img src="${logoUrl}" alt="School Logo">
          </div>
        </div>

        <h3 style="text-align:center;">Merit List</h3>
        <table>
  `);

  // Remove the last column header
  const headerRow = document.querySelector(".report-table thead tr");
  if (headerRow) {
    const headerCells = headerRow.querySelectorAll('th');
    if (headerCells.length > 0) {
      headerCells[headerCells.length - 1].remove();
    }
  }

  printWindow.document.write(document.querySelector(".report-table thead").outerHTML);

  rows.forEach(row => {
    if (row.style.display !== "none") {
      const cells = row.querySelectorAll('td');
      if (cells.length > 0) {
        cells[cells.length - 1].remove();
      }
      printWindow.document.write(`<tr>${row.innerHTML}</tr>`);
    }
  });

  // Stamp with your specified style
  printWindow.document.write(`
        </table>
        <div class="stamp">
          Nachu Junior School<br>
          P.O. Box 561-0902, Kikuyu<br>
          Date: ${formattedDate}
        </div>
      </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
  printWindow.close();
}





</script>

                
                
            </body>
            </html>               
           
